# 🔧 环境变量配置指南

## 📋 当前状态

✅ 已创建 `worker-api/.env.local` 文件  
⚠️ 需要填写实际的配置信息

---

## 🎯 配置步骤

### 方式1: 如果您还没有购买阿里云服务

**建议**: 先跳过本地测试，直接配置GitHub部署

1. 按照 [部署指南-快速开始.md](./部署指南-快速开始.md) 购买阿里云服务
2. 配置GitHub Secrets（不需要.env.local）
3. 推送代码到GitHub自动部署

---

### 方式2: 如果您已经购买了阿里云服务

需要填写 `worker-api/.env.local` 文件中的配置信息。

---

## 📝 配置说明

打开文件: `worker-api/.env.local`

### 1. 数据库配置（必需）

```bash
# RDS连接地址（从阿里云RDS控制台获取）
DB_HOST=rm-xxxxx.mysql.rds.aliyuncs.com

# 端口（默认3306）
DB_PORT=3306

# 用户名（默认root）
DB_USER=root

# 密码（您创建RDS时设置的密码）
DB_PASSWORD=your_password_here

# 数据库名（已创建的数据库）
DB_NAME=songbrocade
```

**如何获取RDS连接地址**:
1. 登录阿里云控制台
2. 进入 RDS 管理控制台
3. 选择您的实例
4. 在"基本信息"页面找到"内网地址"或"外网地址"
5. 复制地址（格式: `rm-xxxxx.mysql.rds.aliyuncs.com`）

---

### 2. OSS配置（必需）

```bash
# OSS区域（您创建Bucket时选择的区域）
OSS_REGION=oss-cn-shanghai

# OSS Bucket名称
OSS_BUCKET=songbrocade-media

# AccessKey ID（步骤1.3中创建的）
OSS_ACCESS_KEY_ID=LTAI5t_your_access_key_id

# AccessKey Secret（步骤1.3中创建的）
OSS_ACCESS_KEY_SECRET=your_access_key_secret
```

**如何获取OSS配置**:
1. 登录阿里云控制台
2. 进入 OSS 管理控制台
3. Bucket名称: 您创建的Bucket名称
4. 区域: 在Bucket概览页面查看
5. AccessKey: 点击右上角头像 → AccessKey管理

---

### 3. 区块链配置（可选，保持现有的）

```bash
# Base Sepolia RPC
RPC_URL=https://sepolia.base.org

# 您的合约地址（如果已部署）
BROCADE_ADDR=0x_your_contract_address
RDA_REG_ADDR=0x_your_contract_address
```

**如果还没有部署合约**:
- 可以先使用占位符
- 后续部署合约后再更新

---

### 4. AI服务配置（可选）

```bash
# OpenAI API Key（用于文化故事生成）
OPENAI_API_KEY=sk-your_openai_api_key

# Replicate API Key（用于视频生成）
REPLICATE_API_KEY=r8_your_replicate_api_key
```

**如果暂时不使用AI功能**:
- 可以先使用占位符
- 后续需要时再配置

---

### 5. 业务配置（保持现有的）

```bash
# 管理员钱包地址
ADMIN_WALLETS=0xEf85456652ada05f12708b9bDcF215780E780D18

# 物流信息加密密钥
SHIPPING_KEY=ir9I4xwi1Umc9W2jSv6NUB9LCjzhufhixOpMvPUR02U=
```

这些配置可以保持不变。

---

## ✅ 配置示例

### 完整配置示例（已购买阿里云服务）

```bash
# 数据库配置
DB_HOST=rm-bp1xxxxx.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_USER=root
DB_PASSWORD=MyStr0ngP@ssw0rd
DB_NAME=songbrocade

# OSS配置
OSS_REGION=oss-cn-shanghai
OSS_BUCKET=songbrocade-media
OSS_ACCESS_KEY_ID=LTAI5tXXXXXXXXXXXXXX
OSS_ACCESS_KEY_SECRET=YourSecretKeyHere123456

# 区块链配置
RPC_URL=https://sepolia.base.org
BROCADE_ADDR=0x1234567890123456789012345678901234567890
RDA_REG_ADDR=0x0987654321098765432109876543210987654321

# AI服务配置
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxx
REPLICATE_API_KEY=r8_xxxxxxxxxxxxxxxxxxxxx

# 业务配置
ADMIN_WALLETS=0xEf85456652ada05f12708b9bDcF215780E780D18
SHIPPING_KEY=ir9I4xwi1Umc9W2jSv6NUB9LCjzhufhixOpMvPUR02U=
```

---

## 🧪 测试配置

配置完成后，测试数据库连接：

```bash
cd /Users/petterbrand/Downloads/阿里云
./deploy-to-aliyun.sh
```

或者单独测试数据库连接：

```bash
cd worker-api
node -e "
import mysql from 'mysql2/promise';
import dotenv from 'dotenv';
dotenv.config({ path: '.env.local' });

const connection = await mysql.createConnection({
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME
});

console.log('✅ 数据库连接成功！');
await connection.end();
"
```

---

## ⚠️ 重要提示

### 安全注意事项

1. **不要提交到Git**
   - `.env.local` 已在 `.gitignore` 中
   - 确保不会被提交到GitHub

2. **妥善保管密码**
   - 数据库密码
   - AccessKey Secret
   - API Keys

3. **生产环境使用GitHub Secrets**
   - 不要在代码中硬编码密钥
   - 使用GitHub Secrets管理敏感信息

---

## 🔄 如果暂时没有阿里云服务

### 选项A: 先部署到GitHub，使用GitHub Actions

1. 跳过本地测试
2. 直接配置GitHub Secrets
3. 推送代码触发自动部署

**优势**: 不需要本地配置，直接部署到生产环境

---

### 选项B: 使用测试数据库

如果只是想测试代码，可以使用本地MySQL：

```bash
# 安装MySQL（如果没有）
brew install mysql

# 启动MySQL
brew services start mysql

# 创建数据库
mysql -u root -e "CREATE DATABASE songbrocade"

# 配置.env.local
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=
DB_NAME=songbrocade
```

---

## 📞 需要帮助？

### 常见问题

**Q1: 找不到RDS连接地址？**
A: 阿里云控制台 → RDS → 实例列表 → 点击实例ID → 基本信息 → 内网地址

**Q2: AccessKey在哪里？**
A: 阿里云控制台 → 右上角头像 → AccessKey管理 → 创建AccessKey

**Q3: 数据库连接失败？**
A: 检查：
- RDS白名单是否配置
- 密码是否正确
- 网络是否可达

**Q4: 暂时没有阿里云服务怎么办？**
A: 建议先购买服务，或者使用GitHub Actions直接部署

---

## 🎯 下一步

### 如果配置成功

```bash
# 继续运行部署脚本
cd /Users/petterbrand/Downloads/阿里云
./deploy-to-aliyun.sh
```

### 如果暂时无法配置

1. 阅读 [部署指南-快速开始.md](./部署指南-快速开始.md)
2. 购买阿里云服务
3. 配置GitHub Secrets
4. 直接推送到GitHub部署

---

## 📚 相关文档

- [部署指南-快速开始.md](./部署指南-快速开始.md) - 第1步：购买阿里云服务
- [README-部署完成.md](./README-部署完成.md) - 项目总览
- [部署检查清单.md](./部署检查清单.md) - 配置检查

---

**配置完成后，记得测试数据库连接！** ✅

