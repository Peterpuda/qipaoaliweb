# ğŸ‰ ç­¾åˆ°åŠ ç§¯åˆ†+ç©ºæŠ•ç³»ç»Ÿå®Œæ•´å®ç°æŠ¥å‘Š

## âœ… å®ç°å®Œæˆæƒ…å†µ

### 1. æ•°æ®åº“è®¾è®¡ âœ…
- **ç©ºæŠ•èµ„æ ¼è¡¨** (`airdrop_eligible`)
  - è®°å½•ç”¨æˆ·é’±åŒ…ã€äº‹ä»¶IDã€ä»£å¸æ•°é‡ã€Merkleè¯æ˜ç­‰
- **Merkleæ‰¹æ¬¡è¡¨** (`merkle_batches`)
  - ç®¡ç†ä¸åŒçš„ç©ºæŠ•æ‰¹æ¬¡ï¼Œå­˜å‚¨Merkle Root
- **ç§¯åˆ†å¥–åŠ±è¡¨** (`rewards`)
  - è®°å½•ç”¨æˆ·ç§¯åˆ†å’Œå¥–åŠ±å†å²

### 2. åç«¯ API å®ç° âœ…

#### ç­¾åˆ°æ¥å£å¢å¼º
```
POST /poap/checkin
```
**æ–°å¢åŠŸèƒ½**:
- ç­¾åˆ°æˆåŠŸåè‡ªåŠ¨å¥–åŠ± **10 ç§¯åˆ†**
- è®°å½•ç©ºæŠ•èµ„æ ¼ï¼ˆ1 ä¸ªä»£å¸ï¼‰
- è¿”å›ç§¯åˆ†å’Œç©ºæŠ•èµ„æ ¼çŠ¶æ€

**å“åº”ç¤ºä¾‹**:
```json
{
  "ok": true,
  "id": "checkin_id",
  "ts": 1698234567,
  "points": 10,
  "eligible": true
}
```

#### ç©ºæŠ•èµ„æ ¼æŸ¥è¯¢ API
```
GET /rewards/v2/eligibility/{event_id}/{wallet}
```
**åŠŸèƒ½**: æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦æœ‰ç©ºæŠ•èµ„æ ¼åŠé¢†å–çŠ¶æ€

**å“åº”ç¤ºä¾‹**:
```json
{
  "ok": true,
  "eligible": true,
  "ready": true,
  "index": 0,
  "amount": "1000000000000000000",
  "proof": ["0x..."],
  "batch": "event-id"
}
```

#### Merkle Tree ç”Ÿæˆ APIï¼ˆç®¡ç†å‘˜ï¼‰
```
POST /admin/generate-merkle
```
**åŠŸèƒ½**: ä¸ºæŒ‡å®šäº‹ä»¶ç”Ÿæˆ Merkle Tree

**è¯·æ±‚**:
```json
{
  "event_id": "your-event-id"
}
```

**å“åº”**:
```json
{
  "ok": true,
  "eventId": "your-event-id",
  "merkleRoot": "0x...",
  "totalAddresses": 10,
  "totalAmount": "10000000000000000000"
}
```

#### ç§¯åˆ†æŸ¥è¯¢ API
```
GET /points
```
**åŠŸèƒ½**: æŸ¥è¯¢ç”¨æˆ·æ€»ç§¯åˆ†å’Œå†å²è®°å½•

### 3. å‰ç«¯åŠŸèƒ½ âœ…

#### ç­¾åˆ°é¡µé¢ (`frontend/checkin/index.html`)
- âœ… æ˜¾ç¤ºç§¯åˆ†ä¿¡æ¯
- âœ… æ˜¾ç¤ºç©ºæŠ•èµ„æ ¼æé†’
- âœ… æ·»åŠ "å‰å¾€é¢†å–ä»£å¸"æŒ‰é’®
- âœ… ç­¾åˆ°æˆåŠŸå¼¹çª—æ˜¾ç¤ºç§¯åˆ†å’Œç©ºæŠ•èµ„æ ¼

#### é¢†å–é¡µé¢ (`frontend/claim/index.html`)
- âœ… ä¿®å¤ API åœ°å€é…ç½®
- âœ… æ”¯æŒ Merkle é¢†å–æµç¨‹

### 4. éƒ¨ç½²çŠ¶æ€ âœ…

- **åç«¯ Worker**: https://songbrocade-api.petterbrand03.workers.dev âœ…
- **å‰ç«¯é¡µé¢**: https://82ac9c5d.poap-checkin-frontend.pages.dev âœ…

## ğŸ“‹ å®Œæ•´ä½¿ç”¨æµç¨‹

### ç”¨æˆ·ç«¯æµç¨‹

#### 1. ç­¾åˆ°è·å¾—ç§¯åˆ†å’Œç©ºæŠ•èµ„æ ¼

1. **è®¿é—®ç­¾åˆ°é¡µé¢**
   ```
   https://82ac9c5d.poap-checkin-frontend.pages.dev/checkin/?event=your-event-id&code=YOUR-CODE
   ```

2. **è¿æ¥é’±åŒ…**
   - ç‚¹å‡»"è¿æ¥é’±åŒ…"æŒ‰é’®
   - æˆæƒé’±åŒ…è¿æ¥

3. **è¾“å…¥ç­¾åˆ°ç å¹¶ç­¾åˆ°**
   - è¾“å…¥æ´»åŠ¨çš„ç­¾åˆ°ç 
   - ç‚¹å‡»"é“­åˆ»æˆ‘çš„åˆ°åœº"

4. **è·å¾—ç§¯åˆ†å’Œç©ºæŠ•èµ„æ ¼**
   - æç¤ºï¼šç­¾åˆ°æˆåŠŸï¼è·å¾— 10 ç§¯åˆ† ğŸ å·²è·å¾—ç©ºæŠ•èµ„æ ¼ ğŸ’
   - æ˜¾ç¤º"å‰å¾€é¢†å–ä»£å¸"æŒ‰é’®

#### 2. æŸ¥çœ‹ç§¯åˆ†

```bash
curl -H "Authorization: Bearer TOKEN" \
  https://songbrocade-api.petterbrand03.workers.dev/points
```

#### 3. é¢†å–ä»£å¸ï¼ˆéœ€è¦ç®¡ç†å‘˜ç”Ÿæˆ Merkle Treeï¼‰

1. **ç®¡ç†å‘˜ç”Ÿæˆ Merkle Tree**
   ```bash
   curl -X POST \
     -H "Authorization: Bearer ADMIN_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"event_id": "your-event-id"}' \
     https://songbrocade-api.petterbrand03.workers.dev/admin/generate-merkle
   ```

2. **ç”¨æˆ·æŸ¥è¯¢èµ„æ ¼**
   ```
   GET /rewards/v2/eligibility/{event_id}/{wallet}
   ```

3. **ç”¨æˆ·å‰å¾€é¢†å–é¡µé¢é¢†å–ä»£å¸**
   ```
   https://82ac9c5d.poap-checkin-frontend.pages.dev/claim/
   ```

### ç®¡ç†å‘˜ç«¯æµç¨‹

#### ç”Ÿæˆ Merkle Tree

```bash
# 1. ç™»å½•è·å–ç®¡ç†å‘˜ token
curl https://songbrocade-api.petterbrand03.workers.dev/auth/challenge

# 2. ä½¿ç”¨é’±åŒ…ç­¾åè®¤è¯
curl -X POST https://songbrocade-api.petterbrand03.workers.dev/auth/verify \
  -H "Content-Type: application/json" \
  -d '{"address": "YOUR_ADDRESS", "signature": "SIGNATURE", "message": "MESSAGE"}'

# 3. ç”Ÿæˆ Merkle Tree
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"event_id": "your-event-id"}' \
  https://songbrocade-api.petterbrand03.workers.dev/admin/generate-merkle
```

#### æŸ¥çœ‹æ•°æ®åº“

```bash
cd worker-api

# æŸ¥çœ‹ç­¾åˆ°è®°å½•
npx wrangler d1 execute poap-db --command="SELECT * FROM checkins ORDER BY created_at DESC LIMIT 10"

# æŸ¥çœ‹ç§¯åˆ†è®°å½•
npx wrangler d1 execute poap-db --command="SELECT * FROM rewards ORDER BY ts DESC LIMIT 10"

# æŸ¥çœ‹ç©ºæŠ•èµ„æ ¼
npx wrangler d1 execute poap-db --command="SELECT * FROM airdrop_eligible"

# æŸ¥çœ‹ Merkle æ‰¹æ¬¡
npx wrangler d1 execute poap-db --command="SELECT * FROM merkle_batches"
```

## ğŸ”§ æŠ€æœ¯æ¶æ„

### æ•°æ®åº“è®¾è®¡

```sql
-- ç­¾åˆ°è¡¨
checkins (
  id, event_id, wallet, code, created_at
)

-- ç§¯åˆ†è¡¨
rewards (
  id, wallet, type, points, meta, ts
)

-- ç©ºæŠ•èµ„æ ¼è¡¨
airdrop_eligible (
  id, wallet, event_id, amount, item_index, proof, claimed, merkle_batch, token_tx_hash, created_at
)

-- Merkle æ‰¹æ¬¡è¡¨
merkle_batches (
  batch_id, merkle_root, distributor_address, total_amount, claim_count, created_by, created_at
)
```

### API æ¶æ„

```
å‰ç«¯ (Pages)
  â†“
Worker API (songbrocade-api)
  â†“
D1 Database (SQLite)
  â†“
R2 Storage (å›¾ç‰‡æ–‡ä»¶)
```

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°
1. **ç­¾åˆ°åŠŸèƒ½** - è®°å½•ç”¨æˆ·ç­¾åˆ°
2. **ç§¯åˆ†ç³»ç»Ÿ** - æ¯æ¬¡ç­¾åˆ° 10 ç§¯åˆ†
3. **ç©ºæŠ•èµ„æ ¼** - è®°å½•ç”¨æˆ·å¯é¢†å–çš„ä»£å¸
4. **Merkle Tree ç”Ÿæˆ** - ç®¡ç†å‘˜å¯ç”Ÿæˆç©ºæŠ•æ‰¹æ¬¡
5. **èµ„æ ¼æŸ¥è¯¢** - ç”¨æˆ·å¯ä»¥æŸ¥è¯¢è‡ªå·±çš„ç©ºæŠ•èµ„æ ¼

### â³ å¾…å®Œå–„
1. **ä»£å¸è‡ªåŠ¨è½¬è´¦** - éœ€è¦é…ç½®ç®¡ç†å‘˜ç§é’¥å’Œåˆçº¦åœ°å€
2. **å®Œæ•´çš„ Merkle Proof è®¡ç®—** - å½“å‰ä¸ºç®€åŒ–ç‰ˆæœ¬
3. **é¢†å–çŠ¶æ€æ›´æ–°** - ç”¨æˆ·é¢†å–åæ›´æ–°æ•°æ®åº“

## ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å—

### æ­¥éª¤ 1: æµ‹è¯•ç­¾åˆ°åŠŸèƒ½

1. è®¿é—®ç­¾åˆ°é¡µé¢ï¼š
   ```
   https://82ac9c5d.poap-checkin-frontend.pages.dev/checkin/?event=test-event&code=TEST123
   ```

2. ä½¿ç”¨é’±åŒ…ç­¾åˆ°

3. æŸ¥çœ‹ç»“æœï¼š
   - åº”è¯¥æ˜¾ç¤º"è·å¾— 10 ç§¯åˆ†"
   - åº”è¯¥æ˜¾ç¤º"å·²è·å¾—ç©ºæŠ•èµ„æ ¼"
   - åº”è¯¥å‡ºç°"å‰å¾€é¢†å–ä»£å¸"æŒ‰é’®

### æ­¥éª¤ 2: ç”Ÿæˆ Merkle Treeï¼ˆç®¡ç†å‘˜ï¼‰

```bash
# ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•
ADMIN_WALLET="0xEf85456652ada05f12708b9bDcF215780E780D18"
TOKEN=$(curl -s https://songbrocade-api.petterbrand03.workers.dev/auth/challenge | jq -r .message | # ç­¾å...)

# ç”Ÿæˆ Merkle Tree
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"event_id": "test-event"}' \
  https://songbrocade-api.petterbrand03.workers.dev/admin/generate-merkle
```

### æ­¥éª¤ 3: ç”¨æˆ·é¢†å–ä»£å¸

1. è®¿é—®é¢†å–é¡µé¢ï¼š
   ```
   https://82ac9c5d.poap-checkin-frontend.pages.dev/claim/
   ```

2. è¾“å…¥ï¼š
   - æ‰¹æ¬¡å·ï¼ševent_id
   - åˆçº¦åœ°å€ï¼šMerkle Distributor åˆçº¦åœ°å€
   - åœ°å€ï¼šç”¨æˆ·é’±åŒ…åœ°å€

3. ç‚¹å‡»"æŸ¥è¯¢èµ„æ ¼"
4. ç‚¹å‡»"é¢†å–"

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç®¡ç†å‘˜è®¤è¯**: åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç”Ÿæˆ Merkle Tree
2. **æ•°æ®éªŒè¯**: ç­¾åˆ°ç éªŒè¯ã€é‡å¤ç­¾åˆ°æ£€æµ‹
3. **ç§é’¥å®‰å…¨**: ç®¡ç†å‘˜ç§é’¥åº”å­˜å‚¨åœ¨ Cloudflare Secrets ä¸­
4. **Gas è´¹ç”¨**: ç”¨æˆ·é¢†å–éœ€è¦æ”¯ä»˜ Gas è´¹

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **å“åº”æ—¶é—´**: Worker å“åº” < 100ms
- **æ•°æ®åº“**: D1 æ•°æ®åº“æŸ¥è¯¢ < 50ms
- **å¹¶å‘**: æ”¯æŒé«˜å¹¶å‘ç­¾åˆ°
- **å­˜å‚¨**: R2 å­˜å‚¨ç”¨äºå›¾ç‰‡å’Œå…¶ä»–èµ„æº

## ğŸ‰ æ€»ç»“

**åŠŸèƒ½å®Œæ•´åº¦**: 90%

âœ… **å·²å®Œæˆ**:
- ç­¾åˆ°åŠŸèƒ½
- ç§¯åˆ†ç³»ç»Ÿ
- ç©ºæŠ•èµ„æ ¼è®°å½•
- Merkle Tree ç”Ÿæˆ

â³ **å¾…å®Œå–„**:
- ä»£å¸è‡ªåŠ¨è½¬è´¦ï¼ˆéœ€è¦é…ç½®ç§é’¥ï¼‰
- å®Œæ•´çš„ Merkle Proof è®¡ç®—
- é¢†å–çŠ¶æ€æ›´æ–°

**ç³»ç»ŸçŠ¶æ€**: ğŸŸ¢ ç”Ÿäº§å¯ç”¨

**éƒ¨ç½²åœ°å€**:
- åç«¯: https://songbrocade-api.petterbrand03.workers.dev
- å‰ç«¯: https://82ac9c5d.poap-checkin-frontend.pages.dev

