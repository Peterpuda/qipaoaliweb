# æ–‡åŒ–æ•…äº‹è¯­è¨€åŒ¹é…é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### é—®é¢˜ç°è±¡
å•†å“è¯¦æƒ…é¡µæ˜¾ç¤º"æš‚æ— æ–‡åŒ–æ•…äº‹å†…å®¹"ï¼Œä½†åœ¨ Admin é¡µé¢å·²ç»ç”Ÿæˆå¹¶å‘å¸ƒäº†æ–‡åŒ–æ•…äº‹ã€‚

### æ ¹æœ¬åŸå› 
**è¯­è¨€ä¸åŒ¹é…**ï¼šæ•°æ®åº“ä¸­å­˜å‚¨çš„æ˜¯**è‹±æ–‡**ï¼ˆ`lang: 'en'`ï¼‰æ–‡åŒ–æ•…äº‹ï¼Œä½†åç«¯ API é»˜è®¤æŸ¥è¯¢**ä¸­æ–‡**ï¼ˆ`lang: 'zh'`ï¼‰ã€‚

---

## ğŸ“Š æ•°æ®åº“å®é™…å­˜å‚¨æƒ…å†µ

ä»æ•°æ®åº“æŸ¥è¯¢ç»“æœå¯ä»¥çœ‹åˆ°ï¼š

```json
{
  "id": "nrt_mhd7wf2sg5xxs7e2",
  "product_id": "id_19a28fd0a18_47a42e7525ca5",  // âœ… å•†å“ ID æ­£ç¡®
  "type": "story",
  "lang": "en",  // âš ï¸ è¯­è¨€æ˜¯è‹±æ–‡ï¼
  "status": "published",  // âœ… çŠ¶æ€å·²å‘å¸ƒ
  "audio_url": "/r2/narratives/audio/nrt_mhd7wf2sg5xxs7e2.mp3",  // âœ… éŸ³é¢‘å­˜åœ¨
  "video_url": null
}
```

**æ•°æ®å­˜å‚¨ç»“æ„**ï¼š
- âœ… æ–‡å­—ã€éŸ³é¢‘ã€è§†é¢‘éƒ½å­˜å‚¨åœ¨**åŒä¸€æ¡è®°å½•**ä¸­ï¼ˆ`content_variants` è¡¨ï¼‰
- âœ… éŸ³é¢‘/è§†é¢‘æ–‡ä»¶å­˜å‚¨åœ¨ **R2** çš„ç»Ÿä¸€è·¯å¾„ï¼š`/r2/narratives/audio/` å’Œ `/r2/narratives/video/`
- âœ… æ¯ä¸ªå•†å“å¯ä»¥æœ‰**å¤šä¸ªè¯­è¨€ç‰ˆæœ¬**çš„æ–‡åŒ–æ•…äº‹ï¼ˆ`lang` å­—æ®µï¼‰
- âœ… æ¯ä¸ªè¯­è¨€ç‰ˆæœ¬å¯ä»¥æœ‰**å¤šç§ç±»å‹**ï¼ˆ`type` å­—æ®µï¼šstory, feature, heritage, usageï¼‰

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å‰çš„é€»è¾‘
```javascript
// âŒ åç«¯é»˜è®¤æŸ¥è¯¢ä¸­æ–‡
const lang = searchParams.get('lang') || 'zh';

// âŒ å¼ºåˆ¶è¦æ±‚ lang åŒ¹é…
WHERE product_id = ? AND lang = ?
```

**é—®é¢˜**ï¼šå¦‚æœæ•°æ®åº“ä¸­åªæœ‰è‹±æ–‡ç‰ˆæœ¬ï¼ŒæŸ¥è¯¢ä¸­æ–‡æ—¶ä¼šè¿”å›ç©ºç»“æœã€‚

---

### ä¿®å¤åçš„é€»è¾‘
```javascript
// âœ… lang å‚æ•°å˜ä¸ºå¯é€‰ï¼Œä¸ä¼ åˆ™è¿”å›æ‰€æœ‰è¯­è¨€
const lang = searchParams.get('lang');

// âœ… åªåœ¨æŒ‡å®šè¯­è¨€æ—¶æ‰è¿‡æ»¤
WHERE product_id = ?
if (lang) {
  AND lang = ?
}
```

**ä¼˜åŠ¿**ï¼š
1. âœ… å‰ç«¯ä¸ä¼  `lang` å‚æ•°æ—¶ï¼Œè¿”å›**æ‰€æœ‰è¯­è¨€**çš„æ–‡åŒ–æ•…äº‹
2. âœ… ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ‰€æœ‰å¯ç”¨çš„æ–‡åŒ–æ•…äº‹ï¼Œä¸å—è¯­è¨€é™åˆ¶
3. âœ… å‰ç«¯å¯ä»¥æ ¹æ®éœ€è¦æ˜¾ç¤ºä¸åŒè¯­è¨€çš„ç‰ˆæœ¬

---

## ğŸ“‹ æ•°æ®å­˜å‚¨æ¶æ„æ€»ç»“

### 1. æ•°æ®åº“è¡¨ç»“æ„ï¼ˆ`content_variants`ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | TEXT | å™äº‹ IDï¼ˆå¦‚ `nrt_xxx`ï¼‰ |
| `product_id` | TEXT | å•†å“ ID |
| `type` | TEXT | ç±»å‹ï¼ˆstory/feature/heritage/usageï¼‰ |
| `lang` | TEXT | è¯­è¨€ï¼ˆzh/en/ja/fr/es/ru/msï¼‰ |
| `status` | TEXT | çŠ¶æ€ï¼ˆdraft/published/archivedï¼‰ |
| `content_json` | TEXT | æ–‡å­—å†…å®¹ï¼ˆJSON æ ¼å¼ï¼‰ |
| `audio_key` | TEXT | éŸ³é¢‘æ–‡ä»¶ keyï¼ˆå¦‚ `narratives/audio/nrt_xxx.mp3`ï¼‰ |
| `audio_url` | TEXT | éŸ³é¢‘è®¿é—®è·¯å¾„ï¼ˆå¦‚ `/r2/narratives/audio/nrt_xxx.mp3`ï¼‰ |
| `audio_duration` | INTEGER | éŸ³é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰ |
| `audio_size` | INTEGER | éŸ³é¢‘å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `video_key` | TEXT | è§†é¢‘æ–‡ä»¶ key |
| `video_url` | TEXT | è§†é¢‘è®¿é—®è·¯å¾„ |
| `video_duration` | INTEGER | è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰ |
| `video_size` | INTEGER | è§†é¢‘å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `video_thumbnail` | TEXT | è§†é¢‘ç¼©ç•¥å›¾ |
| `generation_status` | TEXT | ç”ŸæˆçŠ¶æ€ |
| `generation_progress` | TEXT | ç”Ÿæˆè¿›åº¦ï¼ˆJSONï¼‰ |

### 2. R2 å­˜å‚¨è·¯å¾„

```
R2_BUCKET/
â”œâ”€â”€ narratives/
â”‚   â”œâ”€â”€ audio/
â”‚   â”‚   â”œâ”€â”€ nrt_xxx.mp3  // éŸ³é¢‘æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ nrt_yyy.mp3
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ video/
â”‚       â”œâ”€â”€ nrt_xxx.mp4  // è§†é¢‘æ–‡ä»¶
â”‚       â”œâ”€â”€ nrt_yyy.mp4
â”‚       â””â”€â”€ ...
```

**è®¿é—®è·¯å¾„**ï¼š
- éŸ³é¢‘ï¼š`https://songbrocade-api.petterbrand03.workers.dev/r2/narratives/audio/nrt_xxx.mp3`
- è§†é¢‘ï¼š`https://songbrocade-api.petterbrand03.workers.dev/r2/narratives/video/nrt_xxx.mp4`

### 3. æ•°æ®ç»„ç»‡é€»è¾‘

**æ¯ä¸ªå•†å“çš„æ–‡åŒ–æ•…äº‹åŒ…**ï¼š
```
å•†å“ A (id_19a28fd0a18_47a42e7525ca5)
â”œâ”€â”€ ä¸­æ–‡ç‰ˆ
â”‚   â”œâ”€â”€ story (æ•…äº‹ç‰ˆ)
â”‚   â”‚   â”œâ”€â”€ æ–‡å­— (content_json)
â”‚   â”‚   â”œâ”€â”€ éŸ³é¢‘ (audio_url)
â”‚   â”‚   â””â”€â”€ è§†é¢‘ (video_url)
â”‚   â”œâ”€â”€ feature (ç‰¹ç‚¹ç‰ˆ)
â”‚   â”œâ”€â”€ heritage (ä¼ æ‰¿ç‰ˆ)
â”‚   â””â”€â”€ usage (ä½¿ç”¨ç‰ˆ)
â””â”€â”€ è‹±æ–‡ç‰ˆ
    â”œâ”€â”€ story
    â”‚   â”œâ”€â”€ æ–‡å­—
    â”‚   â”œâ”€â”€ éŸ³é¢‘
    â”‚   â””â”€â”€ è§†é¢‘
    â”œâ”€â”€ feature
    â”œâ”€â”€ heritage
    â””â”€â”€ usage
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ–‡å­—ã€éŸ³é¢‘ã€è§†é¢‘åœ¨**åŒä¸€æ¡æ•°æ®åº“è®°å½•**ä¸­
- âœ… é€šè¿‡ `product_id` + `lang` + `type` ç»„åˆå®šä½å…·ä½“å†…å®¹
- âœ… å‰ç«¯åªéœ€è¦ä¸€æ¬¡ API è°ƒç”¨ï¼Œè·å–æ‰€æœ‰æ ¼å¼

---

## âœ… ä¿®å¤å®Œæˆ

### åç«¯ä¿®æ”¹
- âœ… ç§»é™¤ `lang` å‚æ•°çš„é»˜è®¤å€¼
- âœ… åªåœ¨æŒ‡å®š `lang` æ—¶æ‰è¿‡æ»¤è¯­è¨€
- âœ… æ·»åŠ è¯­è¨€åˆ—è¡¨æ—¥å¿—è¾“å‡º

### éƒ¨ç½²ä¿¡æ¯
- **åç«¯ç‰ˆæœ¬**: `5433326f-c958-4cfd-95cf-93d79fe0a177`
- **éƒ¨ç½²æ—¶é—´**: 2025-11-02 15:59 (åŒ—äº¬æ—¶é—´)

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **å¼ºåˆ¶åˆ·æ–°å•†å“è¯¦æƒ…é¡µ**
   ```
   https://10break.com/product?id=id_19a28fd0a18_47a42e7525ca5
   ```
   æŒ‰ `Cmd/Ctrl + Shift + R` å¼ºåˆ¶åˆ·æ–°

2. **ç‚¹å‡»"äº†è§£æ–‡åŒ–æ•…äº‹"æŒ‰é’®**

3. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**
   åº”è¯¥çœ‹åˆ°ï¼š
   ```
   ğŸ“– Loading cultural narratives for product: id_19a28fd0a18_47a42e7525ca5
   ğŸ“– API URL: .../ai/narrative/product/id_19a28fd0a18_47a42e7525ca5?status=published
   ğŸ“– Response status: 200
   ğŸ“– Response data: { ok: true, narratives: Array(1), total: 1 }
   âœ… Found 1 narratives
   ```

4. **æŸ¥çœ‹æ–‡åŒ–æ•…äº‹å¡ç‰‡**
   - åº”è¯¥èƒ½çœ‹åˆ°è‹±æ–‡ç‰ˆçš„æ–‡åŒ–æ•…äº‹
   - æœ‰ä¸‰ä¸ªæ ‡ç­¾ï¼šğŸ“– æ–‡å­—ã€ğŸµ è¯­éŸ³ã€ğŸ¬ è§†é¢‘

5. **æµ‹è¯•éŸ³é¢‘æ’­æ”¾**
   - ç‚¹å‡»"ğŸµ è¯­éŸ³"æ ‡ç­¾
   - ç‚¹å‡»æ’­æ”¾æŒ‰é’®
   - åº”è¯¥èƒ½æ­£å¸¸æ’­æ”¾éŸ³é¢‘

---

## ğŸ“ åç«¯æ—¥å¿—ç¤ºä¾‹

### âœ… æˆåŠŸæƒ…å†µ
```
ğŸ“– [Cultural Story] product_id: id_19a28fd0a18_47a42e7525ca5, lang: all, status: published, found 1 narratives
ğŸ“– [Cultural Story] Languages: en
ğŸ“– [Cultural Story] Types: story
ğŸ“– [Cultural Story] IDs: nrt_mhd7wf2sg5xxs7e2
```

### âš ï¸ æ— æ•°æ®æƒ…å†µ
```
ğŸ“– [Cultural Story] product_id: id_xxx, lang: all, status: published, found 0 narratives
âš ï¸ [Cultural Story] No narratives found for product id_xxx
```

---

## ğŸ¯ å»ºè®®ä¼˜åŒ–

### 1. ç”Ÿæˆå¤šè¯­è¨€ç‰ˆæœ¬
åœ¨ Admin é¡µé¢ç”Ÿæˆæ–‡åŒ–æ•…äº‹æ—¶ï¼Œå»ºè®®ï¼š
- âœ… åŒæ—¶ç”Ÿæˆä¸­æ–‡å’Œè‹±æ–‡ç‰ˆæœ¬
- âœ… æˆ–è€…æ ¹æ®ç”¨æˆ·å½“å‰è¯­è¨€ç”Ÿæˆå¯¹åº”ç‰ˆæœ¬

### 2. å‰ç«¯æ˜¾ç¤ºä¼˜åŒ–
å‰ç«¯å¯ä»¥ï¼š
- âœ… ä¼˜å…ˆæ˜¾ç¤ºå½“å‰ç”¨æˆ·è¯­è¨€çš„ç‰ˆæœ¬
- âœ… å¦‚æœæ²¡æœ‰ï¼Œåˆ™æ˜¾ç¤ºå…¶ä»–è¯­è¨€çš„ç‰ˆæœ¬
- âœ… æä¾›è¯­è¨€åˆ‡æ¢åŠŸèƒ½

### 3. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
å»ºè®®æ·»åŠ ï¼š
- âœ… æ£€æŸ¥æ¯ä¸ªå•†å“æ˜¯å¦æœ‰æ–‡åŒ–æ•…äº‹
- âœ… æ£€æŸ¥æ¯ä¸ªæ–‡åŒ–æ•…äº‹æ˜¯å¦æœ‰éŸ³é¢‘/è§†é¢‘
- âœ… åœ¨ Admin é¡µé¢æ˜¾ç¤ºç¼ºå¤±çš„å†…å®¹

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¦‚æœä¾ç„¶çœ‹ä¸åˆ°æ–‡åŒ–æ•…äº‹

1. **æ£€æŸ¥æ•°æ®åº“**
   ```bash
   npx wrangler d1 execute poap-db --remote --command \
     "SELECT id, product_id, lang, status, audio_url FROM content_variants WHERE product_id = 'id_19a28fd0a18_47a42e7525ca5'"
   ```

2. **æ£€æŸ¥çŠ¶æ€**
   - ç¡®è®¤ `status = 'published'`
   - å¦‚æœæ˜¯ `draft`ï¼Œéœ€è¦åœ¨ Admin é¡µé¢ç‚¹å‡»"å‘å¸ƒ"

3. **æ£€æŸ¥è¯­è¨€**
   - ç¡®è®¤æ•°æ®åº“ä¸­æœ‰è¯¥å•†å“çš„æ–‡åŒ–æ•…äº‹
   - ä»»ä½•è¯­è¨€éƒ½å¯ä»¥ï¼Œä¸å†é™åˆ¶

4. **æ£€æŸ¥å‰ç«¯ç¼“å­˜**
   - å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆCmd/Ctrl + Shift + Rï¼‰
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

---

## ğŸ“Š æ€»ç»“

### é—®é¢˜
- âŒ è¯­è¨€ä¸åŒ¹é…å¯¼è‡´æŸ¥è¯¢å¤±è´¥

### è§£å†³æ–¹æ¡ˆ
- âœ… ç§»é™¤è¯­è¨€å¼ºåˆ¶è¿‡æ»¤ï¼Œè¿”å›æ‰€æœ‰è¯­è¨€çš„æ–‡åŒ–æ•…äº‹

### æ•°æ®æ¶æ„
- âœ… æ–‡å­—ã€éŸ³é¢‘ã€è§†é¢‘å­˜å‚¨åœ¨åŒä¸€æ¡è®°å½•
- âœ… R2 ç»Ÿä¸€è·¯å¾„ï¼š`/r2/narratives/audio/` å’Œ `/r2/narratives/video/`
- âœ… é€šè¿‡ `product_id` + `lang` + `type` ç»„åˆå®šä½

### ä¸‹ä¸€æ­¥
- ğŸ§ª æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ
- ğŸ“ æ ¹æ®æµ‹è¯•ç»“æœè¿›ä¸€æ­¥ä¼˜åŒ–

