# ğŸ”§ Merkle Amount é‡‘é¢ä¸åŒ¹é…é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡
ç”¨æˆ·åœ¨é¢†å–ä»£å¸æ—¶ï¼ŒMetaMask ç­¾åæ—¶å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
Error: could not coalesce error 
error={ "code": -32603, "message": "Unexpected error" }
```

### æ ¹æœ¬åŸå› 

**æ—¶é—´çº¿åˆ†æ**ï¼š

1. **10æœˆ26æ—¥** - ç”Ÿæˆ Merkle Tree
   - åŸºäºå½“æ—¶çš„ç­¾åˆ°æ•°æ®
   - æ¯ä¸ªç”¨æˆ· 1000 tokens
   - éƒ¨ç½²åˆçº¦ï¼ŒMerkle Root å›ºåŒ–åœ¨é“¾ä¸Š

2. **10æœˆ27æ—¥** - ç”¨æˆ·ç¬¬2æ¬¡ç­¾åˆ°  
   - æ•°æ®åº“ä¸­ `amount` ç´¯åŠ ï¼š1000 â†’ 2000 tokens
   - ä½† Merkle Tree æ²¡æœ‰æ›´æ–°ï¼ˆå·²å›ºåŒ–åœ¨åˆçº¦ä¸­ï¼‰

3. **ç”¨æˆ·å°è¯•é¢†å–** - éªŒè¯å¤±è´¥
   - å‰ç«¯æŸ¥è¯¢åˆ° `amount = 2000`
   - è°ƒç”¨åˆçº¦ `claim(1, address, 2000, proof)`
   - âŒ Merkle éªŒè¯å¤±è´¥ï¼
   - **åŸå› **ï¼šåˆçº¦ä¸­ Merkle Tree è®°å½•çš„æ˜¯ 1000ï¼Œè€Œä¸æ˜¯ 2000

### æ ¸å¿ƒçŸ›ç›¾

- **Merkle Tree æ˜¯é™æ€çš„**ï¼ˆéƒ¨ç½²åä¸å¯å˜ï¼‰
- **ä»£å¸æ•°é‡æ˜¯åŠ¨æ€çš„**ï¼ˆæ¯æ¬¡ç­¾åˆ°éƒ½ç´¯åŠ ï¼‰

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### é‡‡ç”¨æ–¹æ¡ˆï¼šæ–¹æ¡ˆ A - å¿«é€Ÿä¿®å¤

**ç­–ç•¥**ï¼šåˆ†ç¦»æ˜¾ç¤ºé‡‘é¢å’Œé¢†å–é‡‘é¢

- **`amount`**: ç´¯åŠ çš„æ€»é‡‘é¢ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
- **`merkle_amount`**: Merkle Tree å¿«ç…§é‡‘é¢ï¼ˆç”¨äºåˆçº¦éªŒè¯ï¼‰

---

## ğŸ”§ å®æ–½å†…å®¹

### 1ï¸âƒ£ æ•°æ®åº“æ”¹åŠ¨

**æ–°å¢å­—æ®µ**ï¼š
```sql
ALTER TABLE airdrop_eligible ADD COLUMN merkle_amount TEXT DEFAULT NULL;
```

**æ›´æ–°ç°æœ‰æ•°æ®**ï¼š
```sql
-- å°†å·²ç”Ÿæˆ Merkle Tree çš„è®°å½•è®¾ç½® merkle_amount = 1000 tokens
UPDATE airdrop_eligible 
SET merkle_amount = '1000000000000000000000'
WHERE item_index IS NOT NULL AND merkle_amount IS NULL;
```

**éªŒè¯ç»“æœ**ï¼š
```json
{
  "wallet": "0xe7c5a43821acb99f01e216b44e994f665d1e4998",
  "amount": "2000000000000000000000",      // 2000 tokensï¼ˆç´¯åŠ ï¼‰
  "merkle_amount": "1000000000000000000000", // 1000 tokensï¼ˆå¿«ç…§ï¼‰
  "checkin_count": 1
}
```

### 2ï¸âƒ£ API æ”¹åŠ¨

**`GET /rewards/v2/eligibility/{batch}/{wallet}`**

**ä¿®æ”¹å‰**ï¼š
```javascript
return {
  amount: row.amount  // è¿”å›ç´¯åŠ é‡‘é¢ï¼ˆé”™è¯¯ï¼‰
};
```

**ä¿®æ”¹å**ï¼š
```javascript
const claimableAmount = row.merkle_amount || row.amount;

return {
  amount: claimableAmount,      // å¯é¢†å–é‡‘é¢ï¼ˆMerkle Tree å¿«ç…§ï¼‰
  totalAmount: row.amount,       // ç´¯è®¡æ€»é‡‘é¢ï¼ˆä»…ä¾›æ˜¾ç¤ºï¼‰
  checkinCount: row.checkin_count,
  note: "æœ¬æ¬¡å¯é¢†å–åŸºäº Merkle Tree å¿«ç…§çš„é‡‘é¢"
};
```

### 3ï¸âƒ£ å‰ç«¯æ”¹åŠ¨

**é¢†å–æç¤ºä¼˜åŒ–**ï¼š

```javascript
// æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
if (eligData.totalAmount !== eligData.amount) {
  setClaimLog(`
    âœ… èµ„æ ¼éªŒè¯é€šè¿‡ï¼
    ğŸ“Š ç´¯è®¡ç­¾åˆ° ${eligData.checkinCount} æ¬¡
    ğŸ’° æœ¬æ¬¡å¯é¢†å–ï¼š${claimableTokens} æšä»£å¸
    ğŸ“ˆ ç´¯è®¡æ€»é¢ï¼š${totalTokens} æšä»£å¸
    
    âš ï¸ è¯´æ˜ï¼šæœ¬æ¬¡é¢†å–åŸºäº Merkle Tree å¿«ç…§é‡‘é¢ã€‚
    å‰©ä½™ä»£å¸å°†åœ¨ä¸‹æ¬¡ Merkle Tree æ›´æ–°åå¯é¢†å–ã€‚
  `);
}
```

**é¢†å–æˆåŠŸæç¤º**ï¼š

```javascript
let modalMsg = `
ğŸ‰ æ­å–œï¼ä»£å¸é¢†å–æˆåŠŸï¼

ğŸ’° æœ¬æ¬¡åˆ°è´¦ï¼š${amountInTokens} æšä»£å¸
ğŸ“¦ åŒºå—é«˜åº¦ï¼š${receipt.blockNumber}
`;

if (remainingTokens > 0) {
  modalMsg += `
ğŸ“ˆ ç´¯è®¡æ€»é¢ï¼š${totalTokens} æšä»£å¸
â³ å‰©ä½™ ${remainingTokens} æšä»£å¸å°†åœ¨ä¸‹æ¬¡ Merkle Tree æ›´æ–°åå¯é¢†å–
  `;
}
```

---

## âœ… ä¿®å¤éªŒè¯

### æ•°æ®åº“çŠ¶æ€

```bash
SELECT wallet, amount, merkle_amount, checkin_count 
FROM airdrop_eligible 
WHERE wallet = '0xe7c5a43821acb99f01e216b44e994f665d1e4998';
```

**ç»“æœ**ï¼š
| wallet | amount | merkle_amount | checkin_count |
|--------|--------|---------------|---------------|
| 0xe7c5... | 2000 tokens | 1000 tokens | 1 |

âœ… **merkle_amount å·²æ­£ç¡®è®¾ç½®ä¸º 1000 tokens**

### API æµ‹è¯•

```bash
curl "https://songbrocade-api.petterbrand03.workers.dev/rewards/v2/eligibility/airdrop-2025/0xe7c5a..."
```

**é¢„æœŸè¿”å›**ï¼š
```json
{
  "ok": true,
  "eligible": true,
  "ready": true,
  "index": 1,
  "amount": "1000000000000000000000",      // âœ… è¿”å› merkle_amount
  "totalAmount": "2000000000000000000000",  // âœ… è¿”å›ç´¯è®¡æ€»é¢
  "checkinCount": 1,
  "proof": ["0x23dd5b..."],
  "note": "æœ¬æ¬¡å¯é¢†å–åŸºäº Merkle Tree å¿«ç…§çš„é‡‘é¢"
}
```

### æ™ºèƒ½åˆçº¦éªŒè¯

**è°ƒç”¨å‚æ•°**ï¼š
```javascript
contract.claim(
  1,                                        // index
  "0xe7c5a43821acb99f01e216b44e994f665d1e4998", // address
  "1000000000000000000000",                 // amount (1000 tokens)
  ["0x23dd5b29cc5e5026b11a9ba706e6c6e8ca810245fa285ac17e2960d1ba4d03ff"]
);
```

**åˆçº¦éªŒè¯**ï¼š
```solidity
// åˆçº¦ä¸­çš„ Merkle Root
0x23dd5b29cc5e5026b11a9ba706e6c6e8ca810245fa285ac17e2960d1ba4d03ff

// éªŒè¯é€»è¾‘
bytes32 leaf = keccak256(abi.encodePacked(index, account, amount));
require(MerkleProof.verify(proof, merkleRoot, leaf));

// âœ… ä½¿ç”¨ merkle_amount (1000) éªŒè¯é€šè¿‡ï¼
```

---

## ğŸ“Š ç”¨æˆ·ä½“éªŒæµç¨‹

### åœºæ™¯ï¼šç”¨æˆ·ç­¾åˆ° 2 æ¬¡

**ç¬¬ 1 æ¬¡ç­¾åˆ°**ï¼ˆ10æœˆ26æ—¥ï¼‰ï¼š
```
âœ… ç­¾åˆ°æˆåŠŸ
ğŸ“… ç¬¬ 1 æ¬¡ç­¾åˆ°
ğŸ’° è·å¾— 1000 tokens ç©ºæŠ•èµ„æ ¼
```

**ç¬¬ 2 æ¬¡ç­¾åˆ°**ï¼ˆ10æœˆ27æ—¥ï¼‰ï¼š
```
âœ… ç­¾åˆ°æˆåŠŸ
ğŸ“… ç¬¬ 2 æ¬¡ç­¾åˆ°
ğŸ’° ç´¯è®¡ 2000 tokensï¼ˆæ•°æ®åº“æ›´æ–°ï¼‰
```

**é¢†å–ä»£å¸**ï¼ˆ10æœˆ27æ—¥ï¼‰ï¼š
```
ğŸ’° æœ¬æ¬¡å¯é¢†å–ï¼š1000 æšä»£å¸
ğŸ“ˆ ç´¯è®¡æ€»é¢ï¼š2000 æšä»£å¸

âš ï¸ è¯´æ˜ï¼š
æœ¬æ¬¡é¢†å–åŸºäº Merkle Tree å¿«ç…§é‡‘é¢ï¼ˆ1000 tokensï¼‰
å‰©ä½™ 1000 tokens å°†åœ¨ä¸‹æ¬¡ Merkle Tree æ›´æ–°åå¯é¢†å–
```

**äº¤æ˜“æˆåŠŸ**ï¼š
```
ğŸ‰ æ­å–œï¼ä»£å¸é¢†å–æˆåŠŸï¼
ğŸ’° æœ¬æ¬¡åˆ°è´¦ï¼š1000 æšä»£å¸
ğŸ“ˆ ç´¯è®¡æ€»é¢ï¼š2000 æšä»£å¸
â³ å‰©ä½™ 1000 æšä»£å¸å°†åœ¨ä¸‹æ¬¡ Merkle Tree æ›´æ–°åå¯é¢†å–
```

---

## ğŸ¯ åç»­ä¼˜åŒ–è®¡åˆ’

### çŸ­æœŸï¼ˆå½“å‰å®æ–½ï¼‰âœ…
- âœ… ç”¨æˆ·å¯ä»¥é¢†å– merkle_amountï¼ˆ1000 tokensï¼‰
- âœ… å‰ç«¯æç¤ºæ¸…æ™°ï¼Œç”¨æˆ·äº†è§£å‰©ä½™é‡‘é¢
- âœ… å¿«é€Ÿä¿®å¤ï¼Œä¸éœ€è¦é‡æ–°éƒ¨ç½²åˆçº¦

### ä¸­æœŸï¼ˆä¸‹ä¸€æ­¥ï¼‰
- ğŸ“… å®šæœŸé‡æ–°ç”Ÿæˆ Merkle Treeï¼ˆä¾‹å¦‚æ¯å‘¨ï¼‰
- ğŸ“… ç®¡ç†å‘˜å·¥å…·ï¼šä¸€é”®æ›´æ–° Merkle Tree
- ğŸ“… ç”¨æˆ·å¯ä»¥é¢†å–å‰©ä½™çš„ç´¯åŠ ä»£å¸

### é•¿æœŸï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰
- ğŸ”® å®æ–½æ–¹æ¡ˆ Dï¼šå¤šæ‰¹æ¬¡ Merkle Tree
- ğŸ”® æ”¯æŒåˆ†æ‰¹æ¬¡é¢†å–
- ğŸ”® ç”¨æˆ·å¯ä»¥ä¸€æ¬¡æ€§é¢†å–æ‰€æœ‰æ‰¹æ¬¡

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### æ•°æ®åº“
- âœ… `worker-api/migrations/006_add_merkle_amount.sql` - æ–°å¢
- âœ… `worker-api/utils/db.js` - æ›´æ–° schema å’Œ COLUMN_PATCHES

### åç«¯ API
- âœ… `worker-api/index.js` - ä¿®æ”¹ eligibility API è¿”å›é€»è¾‘

### å‰ç«¯
- âœ… `frontend/checkin/index.html` - æ›´æ–°é¢†å–æç¤ºå’Œæ˜¾ç¤ºé€»è¾‘

### æ–‡æ¡£
- âœ… `MERKLE_AMOUNT_FIX.md` - æœ¬æ–‡æ¡£

---

## ğŸš€ éƒ¨ç½²çŠ¶æ€

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ•°æ®åº“è¿ç§» | âœ… å·²å®Œæˆ | æ‰§è¡Œ 006_add_merkle_amount.sql |
| åç«¯ API | âœ… å·²éƒ¨ç½² | Version: 0b030937-b585-452b-9ce1-a95f68a242fb |
| å‰ç«¯é¡µé¢ | â³ éƒ¨ç½²ä¸­ | Cloudflare Pages è‡ªåŠ¨éƒ¨ç½² |
| GitHub | âœ… å·²æ¨é€ | Commit: 000bc90 |

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. éªŒè¯ API
```bash
curl "https://songbrocade-api.petterbrand03.workers.dev/rewards/v2/eligibility/airdrop-2025/YOUR_WALLET"
```

**æ£€æŸ¥**ï¼š
- âœ… `amount` åº”è¯¥æ˜¯ 1000 tokensï¼ˆmerkle_amountï¼‰
- âœ… `totalAmount` åº”è¯¥æ˜¯ç´¯è®¡é‡‘é¢
- âœ… `checkinCount` æ˜¾ç¤ºç­¾åˆ°æ¬¡æ•°

### 2. å‰ç«¯æµ‹è¯•
1. è®¿é—®ç­¾åˆ°é¡µé¢å¹¶è¿æ¥é’±åŒ…
2. ç‚¹å‡»"é¢†å–ä»£å¸"æŒ‰é’®
3. **æ£€æŸ¥æç¤ºä¿¡æ¯**ï¼š
   - åº”è¯¥æ˜¾ç¤º"æœ¬æ¬¡å¯é¢†å–"å’Œ"ç´¯è®¡æ€»é¢"
   - åº”è¯¥æœ‰è¯´æ˜æ–‡å­—
4. ç¡®è®¤ MetaMask äº¤æ˜“
5. **æ£€æŸ¥é¢†å–é‡‘é¢**ï¼š
   - åº”è¯¥æ˜¯ 1000 tokensï¼ˆä¸æ˜¯ 2000ï¼‰

### 3. åˆçº¦éªŒè¯
1. åœ¨ Base Sepolia æµè§ˆå™¨æŸ¥çœ‹äº¤æ˜“
2. æ£€æŸ¥ `claim` å‡½æ•°è°ƒç”¨å‚æ•°
3. éªŒè¯ amount = 1000000000000000000000 (1000 tokens)

---

## âš ï¸ é‡è¦è¯´æ˜

### ç»™ç”¨æˆ·çš„è¯´æ˜

**é—®**ï¼šä¸ºä»€ä¹ˆæˆ‘ç­¾åˆ°äº† 2 æ¬¡ï¼Œä½†åªèƒ½é¢†å– 1000 tokensï¼Ÿ

**ç­”**ï¼š
- Merkle Tree æ˜¯åœ¨æ‚¨é¦–æ¬¡ç­¾åˆ°åç”Ÿæˆçš„ï¼Œè®°å½•äº† 1000 tokens
- æ‚¨çš„ç¬¬äºŒæ¬¡ç­¾åˆ°çš„ 1000 tokens ä¹Ÿå·²è®°å½•åœ¨ç³»ç»Ÿä¸­
- ç®¡ç†å‘˜ä¼šå®šæœŸæ›´æ–° Merkle Treeï¼Œå±Šæ—¶æ‚¨å¯ä»¥é¢†å–å‰©ä½™çš„ 1000 tokens
- æ‚¨çš„ç´¯è®¡é‡‘é¢ï¼ˆ2000 tokensï¼‰æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šä¸¢å¤±

### ç»™ç®¡ç†å‘˜çš„è¯´æ˜

**ä¸‹æ¬¡æ›´æ–° Merkle Tree æ—¶**ï¼š
1. è¿è¡Œ Merkle Tree ç”Ÿæˆå·¥å…·
2. ä½¿ç”¨æœ€æ–°çš„ `amount`ï¼ˆç´¯åŠ åçš„é‡‘é¢ï¼‰
3. éƒ¨ç½²æ–°çš„ MerkleDistributor åˆçº¦ï¼ˆæˆ–ä½¿ç”¨å¤šæ‰¹æ¬¡æ–¹æ¡ˆï¼‰
4. æ›´æ–°å‰ç«¯é…ç½®ä¸­çš„åˆçº¦åœ°å€
5. ç”¨æˆ·å³å¯é¢†å–å‰©ä½™ä»£å¸

---

## âœ… æ€»ç»“

**é—®é¢˜**ï¼šMerkle Tree é™æ€å¿«ç…§ vs ä»£å¸é‡‘é¢åŠ¨æ€ç´¯åŠ çš„å†²çª

**è§£å†³**ï¼š
- âœ… çŸ­æœŸï¼šä½¿ç”¨ `merkle_amount` å­—æ®µè®°å½•å¿«ç…§é‡‘é¢
- âœ… ç”¨æˆ·å¯ä»¥æˆåŠŸé¢†å–ä»£å¸ï¼ˆåŸºäºå¿«ç…§ï¼‰
- âœ… ç”¨æˆ·çŸ¥é“å‰©ä½™é‡‘é¢ï¼Œä½“éªŒé€æ˜
- âœ… ä¸éœ€è¦é‡æ–°éƒ¨ç½²åˆçº¦

**æ•ˆæœ**ï¼š
- âœ… ä¿®å¤äº† MetaMask ç­¾åé”™è¯¯
- âœ… ç”¨æˆ·å¯ä»¥æ­£å¸¸é¢†å–ä»£å¸
- âœ… æ•°æ®å®Œæ•´æ€§å¾—åˆ°ä¿è¯
- âœ… ä¸ºåç»­ä¼˜åŒ–ï¼ˆå¤šæ‰¹æ¬¡æ–¹æ¡ˆï¼‰æ‰“ä¸‹åŸºç¡€

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-10-27  
**ä¿®å¤äººå‘˜**ï¼šAI Assistant  
**æ–¹æ¡ˆç±»å‹**ï¼šæ–¹æ¡ˆ A - å¿«é€Ÿä¿®å¤

