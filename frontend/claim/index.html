<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no"/>
<title>é“¾ä¸Šé¢†å– Â· POAP Check-in</title>
<meta name="theme-color" content="#0a0a0a"/>
<style>
  :root{--bg:#0a0a0a;--card:#111113;--line:#232325;--muted:#9b9ca0;--text:#f4f4f5;--brand:#ff8a3d;--brand2:#ffd05a;--radius:16px}
  *{box-sizing:border-box}
  html,body{height:100%;background:radial-gradient(80% 50% at 50% 0%, #1a1713 0%, var(--bg) 65%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0}
  .appbar{position:sticky;top:0;padding:14px 16px;background:rgba(10,10,10,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
  .wrap{max-width:720px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin:12px 0}
  h1{font-size:18px;margin:0 0 4px}
  .muted{color:#9b9ca0;font-size:12px}
  input,button{width:100%;height:48px;border-radius:14px;border:1px solid var(--line);background:#161616;color:var(--text);padding:0 12px;font-size:15px}
  .btn{border:none;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#2b1706;font-weight:800}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > div{flex:1;min-width:160px}
  .panel{background:#0d0d0d;border:1px solid #222;border-radius:12px;padding:10px 12px;font:13px/1.5 ui-monospace,Menlo,monospace;color:#cfe3ff;min-height:48px;white-space:pre-wrap}
</style>
<script src="/poap.config.js?v=20251016"></script>
<script>
const API = (()=>{ 
  const q=new URLSearchParams(location.search); 
  if(q.get('api')) localStorage.setItem('API_BASE', q.get('api')); 
  return (localStorage.getItem('API_BASE')||window.POAP_CONFIG?.WORKER_BASE_URL||'https://songbrocade-api.petterbrand03.workers.dev').trim(); 
})();

const ABI = [
  {"inputs":[{"internalType":"address","name":"token_","type":"address"},{"internalType":"bytes32","name":"merkleRoot_","type":"bytes32"}],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[],"name":"merkleRoot","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"token","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"isClaimed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"index","type":"uint256"},{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes32[]","name":"proof","type":"bytes32[]"}],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"},{"indexed":false,"internalType":"address","name":"account","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Claimed","type":"event"}
];

let provider, signer, account;

async function connect() {
  if(!window.ethereum){ alert('è¯·å…ˆå®‰è£…é’±åŒ…æ’ä»¶'); return; }
  provider = new window.ethereum.constructor(window.ethereum);
  const [a] = await window.ethereum.request({ method:'eth_requestAccounts' });
  account = a; document.getElementById('addr').value = a;
}

async function checkEligibility() {
  const batch = document.getElementById('batch').value.trim();
  const addr  = (document.getElementById('addr').value||'').trim().toLowerCase();
  if(!batch || !addr){ return setLog('è¯·å…ˆè¾“å…¥æ‰¹æ¬¡å·ä¸åœ°å€'); }
  const r = await fetch(`${API}/rewards/v2/eligibility/${encodeURIComponent(batch)}/${encodeURIComponent(addr)}`);
  const j = await r.json();
  document.getElementById('elig').textContent = JSON.stringify(j, null, 2);
  return j;
}

function setLog(t){ document.getElementById('log').textContent = '['+new Date().toLocaleTimeString()+'] '+t; }

async function doClaim() {
  const batch = document.getElementById('batch').value.trim();
  const addr  = (document.getElementById('addr').value||'').trim().toLowerCase();
  const contract = (document.getElementById('contract').value||'').trim();
  if(!batch || !addr || !contract){ return setLog('è¯·å…ˆå¡«å†™æ‰¹æ¬¡å· / åˆçº¦åœ°å€ / è¿æ¥é’±åŒ…'); }

  const info = await checkEligibility();
  if(!info?.ok || !info.eligible){ return setLog('æœªæŸ¥è¯¢åˆ°é¢†å–èµ„æ ¼'); }

  // è¿æ¥åˆçº¦è°ƒç”¨
  const ethersProvider = new ethers.BrowserProvider(window.ethereum);
  const signer = await ethersProvider.getSigner();
  const c = new ethers.Contract(contract, ABI, signer);

  const index = BigInt(info.index);
  const amount = BigInt(info.amount);
  const proof = info.proof; // bytes32[]
  setLog('æäº¤é“¾ä¸Šäº¤æ˜“ä¸­â€¦');

  const tx = await c.claim(index, addr, amount, proof);
  setLog('äº¤æ˜“å·²æäº¤ï¼š'+tx.hash+'\nç­‰å¾…ç¡®è®¤...');
  const rc = await tx.wait();
  
  // æ˜¾ç¤ºé¢†å–æ•°é‡ï¼ˆè½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼‰
  const amountInTokens = (BigInt(amount) / BigInt(10**18)).toString();
  setLog(`âœ… é¢†å–æˆåŠŸï¼\nåŒºå—ï¼š${rc.blockNumber}\næ•°é‡ï¼š${amountInTokens} ä»£å¸\näº¤æ˜“å“ˆå¸Œï¼š${tx.hash}`);
}
</script>
<!-- ä½¿ç”¨ ethers v6ï¼ˆä» UNPKG å¼•å…¥ï¼‰ -->
<script src="https://unpkg.com/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <link rel="stylesheet" href="/common/global-nav.css">
</head>
<body>
  <div id="globalNavContainer"></div>

  <div class="appbar"><h1>é“¾ä¸Šé¢†å– Â· Merkle v2ï¼ˆSHA-256ï¼‰</h1></div>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div><input id="batch" placeholder="æ‰¹æ¬¡å·ï¼ˆå¦‚ï¼šB169...ï¼‰" /></div>
        <div><input id="contract" placeholder="åˆçº¦åœ°å€ï¼ˆ0x...ï¼‰" /></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><input id="addr" placeholder="0x...ï¼ˆæˆ–è¿æ¥é’±åŒ…ï¼‰" /></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="connect()">ğŸ”— è¿æ¥é’±åŒ…</button>
        <button class="btn" onclick="checkEligibility()">ğŸ” æŸ¥è¯¢èµ„æ ¼</button>
        <button class="btn" onclick="doClaim()">ğŸª™ é¢†å–</button>
      </div>
      <div class="panel" id="log">å°±ç»ªã€‚</div>
      <div class="panel" id="elig" style="margin-top:10px"></div>
      <p class="muted">æç¤ºï¼šæœ¬åˆçº¦ä¸ºæ¼”ç¤ºåŸç”Ÿå¸å‘æ”¾ç‰ˆæœ¬ï¼›ç”Ÿäº§å¯æ›¿æ¢ä¸º ERC20 è½¬è´¦æˆ– NFT å‡­è¯ã€‚</p>
    </div>
  </div>
  <script src="/common/global-nav.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      await initGlobalNav({ currentPage: 'claim' });
    });
  </script>
</body>
</html>