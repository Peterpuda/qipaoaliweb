<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>éé—é¡¹ç›®ç®¡ç† - å¹³å°ç®¡ç†åå°</title>
  <link rel="stylesheet" href="/styles/app.css"/>
  <link rel="stylesheet" href="common/admin-common.css"/>
  <script src="/poap.config.js"></script>
  <script src="common/admin-common.js"></script>
  <script src="common/admin-auth.js"></script>
</head>
<body>
<div class="wrap">
  <!-- å¯¼èˆªæ  -->
  <nav class="admin-nav">
    <div class="nav-brand">éé—é¡¹ç›®ç®¡ç†</div>
    <button class="hamburger">â˜°</button>
    <div class="nav-user">
      <span id="authState" class="pill">æœªç™»å½•</span>
      <button onclick="logout()" class="btn btn-sm btn-outline" style="margin-left: 12px;" title="é€€å‡ºç™»å½•">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </nav>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ  -->
  <div class="sidebar-overlay"></div>
  <div class="sidebar">
    <div class="sidebar-header">
      <div>å¯¼èˆªèœå•</div>
      <button class="sidebar-close">Ã—</button>
    </div>
    <nav class="sidebar-nav">
      <a href="/admin/index.html" class="nav-item">
        <i>ğŸ“Š</i> å¹³å°æ¦‚è§ˆ
      </a>
      <a href="/admin/projects.html" class="nav-item">
        <i>ğŸŒ</i> éé—é¡¹ç›®ç®¡ç†
      </a>
      <a href="/admin/qipao.html" class="nav-item">
        <i>ğŸ‘—</i> æ——è¢ç¤¾åŒºç®¡ç†
      </a>
      <a href="/admin/events.html" class="nav-item">
        <i>ğŸª</i> æ´»åŠ¨ç®¡ç†
      </a>
      <a href="/admin/artisans.html" class="nav-item">
        <i>ğŸ‘¨â€ğŸ¨</i> ä¼ æ‰¿äººç®¡ç†
      </a>
      <a href="/admin/products.html" class="nav-item">
        <i>ğŸ›ï¸</i> å•†å“ç®¡ç†
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i>ğŸ“¦</i> è®¢å•ç®¡ç†
      </a>
      <a href="../profile/" class="nav-item">
        <i>ğŸ‘¤</i> ä¸ªäººä¸­å¿ƒ
      </a>
      <a href="javascript:logout()" class="nav-item">
        <i>ğŸšª</i> é€€å‡ºç™»å½•
      </a>
    </nav>
  </div>

  <!-- é¡¹ç›®åˆ›å»º/ç¼–è¾‘è¡¨å• -->
  <div class="card">
    <h2 class="card-title">éé—é¡¹ç›®ä¿¡æ¯</h2>
    
    <form id="projectForm">
      <input type="hidden" id="project_id" name="id" />
      
      <div class="field">
        <label>é¡¹ç›®IDï¼ˆç¼–è¾‘æ—¶è‡ªåŠ¨å¡«å…¥ï¼‰</label>
        <input id="project_id_display" placeholder="æ–°å»ºæ—¶ç•™ç©º" readonly/>
      </div>
      
      <div class="field">
        <label>é¡¹ç›®åç§° *</label>
        <input id="project_name" name="name" placeholder="å¦‚ï¼šæ——è¢æ–‡åŒ–" required/>
      </div>
      
      <div class="field">
        <label>é¡¹ç›®è‹±æ–‡åç§°</label>
        <input id="project_name_en" name="name_en" placeholder="å¦‚ï¼šQipao Culture"/>
      </div>
      
      <div class="field">
        <label>é¡¹ç›®åˆ†ç±» *</label>
        <select id="project_category" name="category" required>
          <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
          <option value="traditional_craft">ä¼ ç»Ÿæ‰‹å·¥è‰º</option>
          <option value="performing_arts">è¡¨æ¼”è‰ºæœ¯</option>
          <option value="festivals">èŠ‚åº†æ´»åŠ¨</option>
          <option value="oral_tradition">å£å¤´ä¼ ç»Ÿ</option>
          <option value="social_practice">ç¤¾ä¼šå®è·µ</option>
          <option value="traditional_knowledge">ä¼ ç»ŸçŸ¥è¯†</option>
        </select>
      </div>
      
      <div class="field">
        <label>æ‰€å±å›½å®¶/åœ°åŒº *</label>
        <input id="project_country" name="country" placeholder="å¦‚ï¼šä¸­å›½" required/>
      </div>
      
      <div class="field">
        <label>é¡¹ç›®æè¿°</label>
        <textarea id="project_description" name="description" rows="4" placeholder="è¯¦ç»†æè¿°é¡¹ç›®çš„æ–‡åŒ–èƒŒæ™¯ã€å†å²ä»·å€¼ç­‰"></textarea>
      </div>
      
      <div class="field">
        <label>é¡¹ç›®çŠ¶æ€ *</label>
        <select id="project_status" name="status" required>
          <option value="active">æ´»è·ƒ</option>
          <option value="inactive">æš‚åœ</option>
          <option value="archived">å½’æ¡£</option>
        </select>
      </div>
      
      <div class="row">
        <button type="button" id="btnSaveProject" class="btn btn-primary btn-block">
          ä¿å­˜ / æ›´æ–° é¡¹ç›®
        </button>
        <button type="button" id="btnClearProjectForm" class="btn btn-secondary btn-block">
          æ¸…ç©ºè¡¨å•
        </button>
      </div>
    </form>
  </div>

  <!-- é¡¹ç›®åˆ—è¡¨ -->
  <div class="card">
    <h2 class="card-title">éé—é¡¹ç›®åˆ—è¡¨</h2>
    
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>å½“å‰é¡¹ç›®</div>
      <button id="btnRefreshProjects" class="btn btn-sm btn-secondary">
        åˆ·æ–°
      </button>
    </div>
    
    <div id="project_list" class="list" style="margin-top: 12px;">
      <div class="list-item text-center">
        <div class="loading"></div>
      </div>
    </div>
  </div>

  <!-- é¡¹ç›®ç»Ÿè®¡ -->
  <div class="card">
    <h2 class="card-title">é¡¹ç›®ç»Ÿè®¡</h2>
    
    <div class="grid grid-2">
      <div class="stat-card">
        <div class="stat-number" id="totalProjects">-</div>
        <div class="stat-label">é¡¹ç›®æ€»æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeProjects">-</div>
        <div class="stat-label">æ´»è·ƒé¡¹ç›®</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalCountries">-</div>
        <div class="stat-label">æ¶‰åŠå›½å®¶</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalParticipants">-</div>
        <div class="stat-label">æ€»å‚ä¸è€…</div>
      </div>
    </div>
  </div>

</div>

<script>
// éé—é¡¹ç›®ç®¡ç†ç‰¹å®šåŠŸèƒ½

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  loadProjects();
  loadProjectStats();
});

// ä¿å­˜/æ›´æ–°é¡¹ç›®
$('#btnSaveProject').addEventListener('click', async () => {
  if (!ensureAuth()) return;
  
  const formData = getFormData('projectForm');
  const errors = validateForm(formData, ['name', 'category', 'country', 'status']);
  
  if (errors.length > 0) {
    toast(errors.join(', '), 'error');
    return;
  }
  
  const btn = $('#btnSaveProject');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const payload = {
      id: formData.id || undefined,
      name: formData.name.trim(),
      name_en: formData.name_en.trim(),
      category: formData.category,
      country: formData.country.trim(),
      description: formData.description.trim(),
      status: formData.status
    };
    
    // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„API
    // const result = await apiJSONmulti(['/admin/project-upsert'], {
    //   method: 'POST',
    //   body: JSON.stringify(payload)
    // });
    
    // æ¨¡æ‹ŸAPIè°ƒç”¨
    const result = { ok: true, id: payload.id || 'new_project_' + Date.now() };
    
    if (result.ok) {
      toast('å·²ä¿å­˜é¡¹ç›® / ID: ' + result.id);
      clearProjectForm();
      loadProjects();
      loadProjectStats();
    } else {
      toast('ä¿å­˜å¤±è´¥: ' + (result.error || 'unknown'), 'error');
    }
    
  } catch (error) {
    console.error('ä¿å­˜é¡¹ç›®å¤±è´¥:', error);
    toast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
});

// æ¸…ç©ºé¡¹ç›®è¡¨å•
$('#btnClearProjectForm').addEventListener('click', clearProjectForm);

// åˆ·æ–°é¡¹ç›®åˆ—è¡¨
$('#btnRefreshProjects').addEventListener('click', loadProjects);

// åŠ è½½é¡¹ç›®åˆ—è¡¨
async function loadProjects() {
  if (!ensureAuth()) return;
  
  try {
    // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„API
    // const result = await apiJSONmulti(['/admin/projects']);
    
    // æ¨¡æ‹Ÿæ•°æ®
    const mockProjects = [
      {
        id: 'qipao_001',
        name: 'æ——è¢æ–‡åŒ–',
        name_en: 'Qipao Culture',
        category: 'traditional_craft',
        country: 'ä¸­å›½',
        status: 'active',
        description: 'ä¸­å›½ä¼ ç»Ÿæ——è¢æ–‡åŒ–ä¼ æ‰¿ä¸åˆ›æ–°',
        participants: 1200,
        created_at: Date.now() / 1000 - 86400 * 30
      },
      {
        id: 'ceramics_001',
        name: 'é™¶ç“·å·¥è‰º',
        name_en: 'Ceramics Craft',
        category: 'traditional_craft',
        country: 'ä¸­å›½',
        status: 'active',
        description: 'ä¸­å›½ä¼ ç»Ÿé™¶ç“·åˆ¶ä½œå·¥è‰º',
        participants: 800,
        created_at: Date.now() / 1000 - 86400 * 15
      },
      {
        id: 'silk_001',
        name: 'ä¸ç»¸ç»‡é€ ',
        name_en: 'Silk Weaving',
        category: 'traditional_craft',
        country: 'ä¸­å›½',
        status: 'inactive',
        description: 'ä¼ ç»Ÿä¸ç»¸ç»‡é€ æŠ€è‰º',
        participants: 600,
        created_at: Date.now() / 1000 - 86400 * 7
      }
    ];
    
    displayProjects(mockProjects);
  } catch (error) {
    console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
    $('#project_list').innerHTML = '<div class="list-item text-center">åŠ è½½å¤±è´¥</div>';
  }
}

// æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
function displayProjects(projects) {
  const container = $('#project_list');
  
  if (!projects || projects.length === 0) {
    container.innerHTML = '<div class="list-item text-center">æš‚æ— é¡¹ç›®</div>';
    return;
  }
  
  container.innerHTML = projects.map(project => {
    const statusClass = getProjectStatusClass(project.status);
    const statusText = getProjectStatusText(project.status);
    const categoryText = getCategoryText(project.category);
    
    return `
      <div class="list-item">
        <div style="flex: 1;">
          <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
            ${project.name}
            <span class="pill ${statusClass}" style="font-size: 10px;">${statusText}</span>
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            ${categoryText} | ${project.country} | å‚ä¸è€…: ${project.participants || 0}
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
            ${project.description || 'æš‚æ— æè¿°'} | ID: ${project.id}
          </div>
        </div>
        <div>
          <button onclick="editProject('${project.id}')" class="btn btn-sm btn-secondary">
            ç¼–è¾‘
          </button>
        </div>
      </div>
    `;
  }).join('');
}

// è·å–é¡¹ç›®çŠ¶æ€æ ·å¼ç±»
function getProjectStatusClass(status) {
  switch (status) {
    case 'active': return 'pill-ok';
    case 'inactive': return 'pill-warning';
    case 'archived': return 'pill-error';
    default: return 'pill';
  }
}

// è·å–é¡¹ç›®çŠ¶æ€æ–‡æœ¬
function getProjectStatusText(status) {
  switch (status) {
    case 'active': return 'æ´»è·ƒ';
    case 'inactive': return 'æš‚åœ';
    case 'archived': return 'å½’æ¡£';
    default: return status;
  }
}

// è·å–åˆ†ç±»æ–‡æœ¬
function getCategoryText(category) {
  const categoryMap = {
    'traditional_craft': 'ä¼ ç»Ÿæ‰‹å·¥è‰º',
    'performing_arts': 'è¡¨æ¼”è‰ºæœ¯',
    'festivals': 'èŠ‚åº†æ´»åŠ¨',
    'oral_tradition': 'å£å¤´ä¼ ç»Ÿ',
    'social_practice': 'ç¤¾ä¼šå®è·µ',
    'traditional_knowledge': 'ä¼ ç»ŸçŸ¥è¯†'
  };
  return categoryMap[category] || category;
}

// ç¼–è¾‘é¡¹ç›®
function editProject(projectId) {
  // è¿™é‡Œåº”è¯¥ä»åˆ—è¡¨ä¸­è·å–é¡¹ç›®æ•°æ®ï¼Œæˆ–è€…é‡æ–°åŠ è½½å•ä¸ªé¡¹ç›®
  loadProjects().then(() => {
    toast('è¯·ä»æœåŠ¡å™¨é‡æ–°åŠ è½½é¡¹ç›®æ•°æ®', 'error');
  });
}

// æ¸…ç©ºé¡¹ç›®è¡¨å•
function clearProjectForm() {
  clearForm('projectForm');
  $('#project_id').value = '';
  $('#project_id_display').value = '';
}

// å¡«å……é¡¹ç›®è¡¨å•
function fillProjectForm(project) {
  $('#project_id').value = project.id || '';
  $('#project_id_display').value = project.id || '';
  $('#project_name').value = project.name || '';
  $('#project_name_en').value = project.name_en || '';
  $('#project_category').value = project.category || '';
  $('#project_country').value = project.country || '';
  $('#project_description').value = project.description || '';
  $('#project_status').value = project.status || '';
}

// åŠ è½½é¡¹ç›®ç»Ÿè®¡
async function loadProjectStats() {
  if (!ensureAuth()) return;
  
  try {
    // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„APIè·å–ç»Ÿè®¡æ•°æ®
    // æ¨¡æ‹Ÿæ•°æ®
    $('#totalProjects').textContent = '3';
    $('#activeProjects').textContent = '2';
    $('#totalCountries').textContent = '1';
    $('#totalParticipants').textContent = '2,600';
  } catch (error) {
    console.error('åŠ è½½é¡¹ç›®ç»Ÿè®¡å¤±è´¥:', error);
  }
}

// å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
window.editProject = editProject;
window.fillProjectForm = fillProjectForm;
window.clearProjectForm = clearProjectForm;
</script>
</body>
</html>
