<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Merkle Tree ç”Ÿæˆ Â· ç®¡ç†åå°</title>
<script src="/poap.config.js"></script>
<link rel="stylesheet" href="common/admin-common.css"/>
<script src="common/admin-common.js"></script>
<style>
  .merkle-card { background: var(--card); border-radius: 16px; padding: 20px; margin: 20px 0; }
  .merkle-info { background: #1a1a1a; padding: 15px; border-radius: 12px; margin: 10px 0; font-family: monospace; font-size: 13px; }
  .status { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
  .status.pending { background: #fef3c7; color: #92400e; }
  .status.ready { background: #d1fae5; color: #065f46; }
  .status.error { background: #fee2e2; color: #991b1b; }
  .btn-generate { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .log-panel { background: #0d0d0d; border: 1px solid #222; border-radius: 12px; padding: 12px; font: 13px/1.6 ui-monospace, Menlo, monospace; color: #a0aec0; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
</style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ³ Merkle Tree ç”Ÿæˆå·¥å…·</h1>
    <p class="subtitle">ä¸ºæ´»åŠ¨ç”Ÿæˆ Merkle Treeï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿé¢†å–ä»£å¸ç©ºæŠ•</p>

    <div class="merkle-card">
      <h2>æ­¥éª¤ 1ï¼šé€‰æ‹©æ´»åŠ¨</h2>
      <div class="form-group">
        <label>æ´»åŠ¨ ID / Slug</label>
        <input type="text" id="eventId" placeholder="è¾“å…¥ event_idï¼ˆå¦‚ï¼š24ï¼‰æˆ– slugï¼ˆå¦‚ï¼šairdrop-2025ï¼‰" />
      </div>
      <button class="btn btn-secondary" onclick="loadEventInfo()">ğŸ“‹ åŠ è½½æ´»åŠ¨ä¿¡æ¯</button>
    </div>

      <div id="eventInfo" class="merkle-card" style="display:none">
      <h2>æ´»åŠ¨ä¿¡æ¯</h2>
      <div class="merkle-info">
        <div><strong>æ´»åŠ¨åç§°ï¼š</strong><span id="eventName">-</span></div>
        <div><strong>æ´»åŠ¨ IDï¼š</strong><span id="eventIdDisplay">-</span></div>
        <div><strong>å½“å‰ç­¾åˆ°äººæ•°ï¼š</strong><span id="checkinCount">0</span> äºº</div>
        <div><strong>Merkle çŠ¶æ€ï¼š</strong><span id="merkleStatus" class="status pending">å¾…ç”Ÿæˆ</span></div>
      </div>
      <div style="margin-top: 12px; padding: 10px; background: #e0f2fe; border-radius: 8px; color: #075985; font-size: 12px;">
        â„¹ï¸ ç­¾åˆ°äººæ•°ä»…ä¾›å‚è€ƒï¼Œç”Ÿæˆ Merkle Tree ä¸éœ€è¦ç­‰å¾…ç­¾åˆ°ã€‚
      </div>
    </div>

    <div id="generateSection" class="merkle-card" style="display:none">
      <h2>æ­¥éª¤ 2ï¼šç”Ÿæˆ Merkle Tree</h2>
      <p style="color: var(--muted); font-size: 14px;">
        ç”Ÿæˆ Merkle Tree åï¼Œç”¨æˆ·ç­¾åˆ°å³å¯é¢†å–ä»£å¸ï¼ˆæ— éœ€é¢„å…ˆçŸ¥é“ç­¾åˆ°åå•ï¼‰ã€‚
      </p>
      <div class="form-group" style="margin-bottom: 16px;">
        <label>é¢„è®¡æœ€å¤§å‚ä¸äººæ•°</label>
        <input type="number" id="maxClaimers" value="10000" min="1" placeholder="ç”¨äºè®¡ç®—éœ€è¦å‡†å¤‡çš„ä»£å¸æ€»é‡" />
        <small style="color: var(--muted); font-size: 12px; display: block; margin-top: 4px;">
          æ¯äººå¯é¢†å– 1000 ä¸ªä»£å¸ï¼Œæ­¤å‚æ•°ç”¨äºè®¡ç®—éœ€è¦è½¬å…¥åˆçº¦çš„æ€»ä»£å¸é‡
        </small>
      </div>
      <button class="btn btn-generate" onclick="generateMerkle()">ğŸš€ ç”Ÿæˆ Merkle Tree</button>
    </div>

    <div id="resultSection" class="merkle-card" style="display:none">
      <h2>ç”Ÿæˆç»“æœ</h2>
      <div class="merkle-info" id="merkleResult"></div>
      <p style="margin-top: 10px; color: var(--muted); font-size: 13px;">
        âš ï¸ è¯·è®°å½• Merkle Rootï¼Œéƒ¨ç½²åˆçº¦æ—¶éœ€è¦ä½¿ç”¨
      </p>
    </div>

    <div class="merkle-card">
      <h2>æ“ä½œæ—¥å¿—</h2>
      <div class="log-panel" id="logPanel">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div class="merkle-card">
      <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
      <ol style="color: var(--muted); line-height: 1.8;">
        <li><strong>è¾“å…¥æ´»åŠ¨ ID</strong>ï¼ŒåŠ è½½æ´»åŠ¨ä¿¡æ¯ï¼ˆåªè¦æ´»åŠ¨å­˜åœ¨å³å¯ï¼‰</li>
        <li><strong>ç”Ÿæˆ Merkle Tree</strong>ï¼Œæ— éœ€ç­‰å¾…ç”¨æˆ·ç­¾åˆ°</li>
        <li><strong>è®°å½• Merkle Root</strong>ï¼Œç”¨äºéƒ¨ç½²åˆçº¦</li>
        <li><strong>éƒ¨ç½² ERC20MerkleDistributor åˆçº¦</strong>ï¼ˆä½¿ç”¨ç”Ÿæˆçš„ Rootï¼‰</li>
        <li><strong>è½¬è´¦ä»£å¸åˆ°åˆçº¦</strong>ï¼ˆæ ¹æ®é¢„è®¡å‚ä¸äººæ•°ï¼‰</li>
        <li><strong>ç”¨æˆ·ç­¾åˆ°åå³å¯é¢†å–</strong>ï¼Œåªè¦åˆçº¦æœ‰è¶³å¤Ÿä»£å¸</li>
      </ol>
      <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; color: #92400e; font-size: 13px;">
        ğŸ’¡ <strong>æ–°é€»è¾‘</strong>ï¼šä¸éœ€è¦ç­‰å¾…ç”¨æˆ·ç­¾åˆ°ï¼åªè¦æ´»åŠ¨åˆ›å»ºæˆåŠŸï¼Œå°±å¯ä»¥ç«‹å³ç”Ÿæˆ Merkle Tree å¹¶éƒ¨ç½²åˆçº¦ã€‚ç”¨æˆ·ç­¾åˆ°åä¼šè‡ªåŠ¨æ£€æŸ¥èµ„æ ¼å¹¶å…è®¸é¢†å–ã€‚
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.POAP_CONFIG?.WORKER_BASE_URL || 'https://songbrocade-api.petterbrand03.workers.dev';
    
    function log(message, type = 'info') {
      const panel = document.getElementById('logPanel');
      const time = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      panel.textContent += `[${time}] ${prefix} ${message}\n`;
      panel.scrollTop = panel.scrollHeight;
    }

    async function loadEventInfo() {
      const eventId = document.getElementById('eventId').value.trim();
      if (!eventId) {
        alert('è¯·è¾“å…¥æ´»åŠ¨ ID');
        return;
      }

      log(`åŠ è½½æ´»åŠ¨ä¿¡æ¯ï¼š${eventId}`);

      try {
        // åŠ è½½æ´»åŠ¨åŸºæœ¬ä¿¡æ¯
        const eventRes = await fetch(`${API_BASE}/api/events/get?slug=${eventId}`);
        const eventData = await eventRes.json();

        if (!eventData.ok) {
          log(`æ´»åŠ¨ä¸å­˜åœ¨ï¼š${eventId}`, 'error');
          return;
        }

        document.getElementById('eventName').textContent = eventData.event.name || eventId;
        document.getElementById('eventIdDisplay').textContent = eventData.event.id || eventId;

        // æŸ¥è¯¢ç­¾åˆ°äººæ•°
        const checkinRes = await fetch(`${API_BASE}/api/events/get?slug=${eventId}`);
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æœ‰ä¸“é—¨çš„ç»Ÿè®¡æ¥å£
        document.getElementById('checkinCount').textContent = 'æŸ¥è¯¢ä¸­...';

        // æ£€æŸ¥ Merkle çŠ¶æ€
        const statusSpan = document.getElementById('merkleStatus');
        statusSpan.textContent = 'å¾…ç”Ÿæˆ';
        statusSpan.className = 'status pending';

        document.getElementById('eventInfo').style.display = 'block';
        document.getElementById('generateSection').style.display = 'block';

        log('æ´»åŠ¨ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
      } catch (error) {
        log(`åŠ è½½å¤±è´¥ï¼š${error.message}`, 'error');
      }
    }

    async function generateMerkle() {
      const eventId = document.getElementById('eventId').value.trim();
      const maxClaimers = parseInt(document.getElementById('maxClaimers').value) || 10000;
      
      if (!eventId) {
        alert('è¯·å…ˆåŠ è½½æ´»åŠ¨ä¿¡æ¯');
        return;
      }

      if (maxClaimers < 1) {
        alert('é¢„è®¡å‚ä¸äººæ•°å¿…é¡»å¤§äº 0');
        return;
      }

      if (!confirm(`ç¡®å®šè¦ä¸ºæ´»åŠ¨ ${eventId} ç”Ÿæˆ Merkle Tree å—ï¼Ÿ\n\né¢„è®¡æœ€å¤§å‚ä¸äººæ•°ï¼š${maxClaimers} äºº\néœ€è¦å‡†å¤‡ä»£å¸ï¼š${maxClaimers * 1000} ä¸ª`)) {
        return;
      }

      log(`å¼€å§‹ç”Ÿæˆ Merkle Tree...`);
      log(`é¢„è®¡æœ€å¤§å‚ä¸äººæ•°: ${maxClaimers}`);

      try {
        const token = sessionStorage.getItem('qipao.admin.token') || 
                      localStorage.getItem('qipao.admin.token') || 
                      localStorage.getItem('bearer_token') || '';
        if (!token) {
          log('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç®¡ç†åå°', 'error');
          setTimeout(() => {
            window.location.href = '/admin/';
          }, 2000);
          return;
        }

        const response = await fetch(`${API_BASE}/admin/generate-merkle`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ 
            event_id: eventId,
            max_claimers: maxClaimers
          })
        });

        const data = await response.json();

        if (!data.ok) {
          log(`ç”Ÿæˆå¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
          return;
        }

        // è®¡ç®—ä»£å¸æ•°é‡ï¼ˆä» wei è½¬æ¢ä¸º tokensï¼‰
        const totalTokens = data.totalAmount ? (BigInt(data.totalAmount) / BigInt('1000000000000000000')).toString() : 'N/A';
        const amountPerUser = data.amountPerUser ? (BigInt(data.amountPerUser) / BigInt('1000000000000000000')).toString() : '1000';

        // æ˜¾ç¤ºç»“æœ
        const resultHtml = `
<strong>âœ… ç”ŸæˆæˆåŠŸï¼</strong>

æ´»åŠ¨ ID: ${data.eventId || eventId}
æ´»åŠ¨åç§°: ${data.eventName || '-'}
Merkle Root: ${data.merkleRoot || 'N/A'}

<strong>ä»£å¸é…ç½®ï¼š</strong>
æ¯äººå¯é¢†å–: ${amountPerUser} ä¸ªä»£å¸
æœ€å¤§å‚ä¸äººæ•°: ${data.maxClaimers || maxClaimers}
éœ€è¦å‡†å¤‡ä»£å¸æ€»é‡: ${totalTokens} ä¸ªä»£å¸
å½“å‰å·²ç­¾åˆ°: ${data.currentCheckins || 0} äºº

<strong>ä¸‹ä¸€æ­¥æ“ä½œï¼š</strong>
1. ğŸ“ è®°å½• Merkle Root: ${data.merkleRoot || 'N/A'}
2. ğŸš€ éƒ¨ç½² ERC20MerkleDistributor åˆçº¦ï¼ˆä½¿ç”¨æ­¤ Rootï¼‰
3. ğŸ’° è½¬è´¦ ${totalTokens} ä¸ªä»£å¸åˆ°åˆçº¦åœ°å€
4. âš™ï¸ æ›´æ–° frontend/poap.config.js ä¸­çš„ DISTRIBUTOR_CONTRACT
5. âœ… ç”¨æˆ·ç­¾åˆ°åå³å¯é¢†å–ä»£å¸ï¼

<strong>æç¤ºï¼š</strong>
${data.message || ''}
        `;

        document.getElementById('merkleResult').innerHTML = resultHtml.replace(/\n/g, '<br>');
        document.getElementById('resultSection').style.display = 'block';

        const statusSpan = document.getElementById('merkleStatus');
        statusSpan.textContent = 'å·²ç”Ÿæˆ';
        statusSpan.className = 'status ready';

        log('âœ… Merkle Tree ç”ŸæˆæˆåŠŸï¼', 'success');
        log(`Merkle Root: ${data.merkleRoot || 'N/A'}`);
        log(`æ¯äººå¯é¢†å–: ${amountPerUser} ä¸ªä»£å¸`);
        log(`æœ€å¤§å‚ä¸äººæ•°: ${data.maxClaimers || maxClaimers}`);
        log(`éœ€è¦å‡†å¤‡ä»£å¸: ${totalTokens} ä¸ª`);
        log(`å½“å‰å·²ç­¾åˆ°: ${data.currentCheckins || 0} äºº`);

      } catch (error) {
        log(`ç”Ÿæˆå¤±è´¥ï¼š${error.message}`, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    window.addEventListener('DOMContentLoaded', () => {
      const token = sessionStorage.getItem('qipao.admin.token') || 
                    localStorage.getItem('qipao.admin.token') || 
                    localStorage.getItem('bearer_token') || '';
      if (!token) {
        log('æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œè¯·å…ˆç™»å½•', 'error');
        if (confirm('éœ€è¦ç™»å½•ç®¡ç†åå°ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ')) {
          window.location.href = '/admin/';
        }
      } else {
        log('å·²ç™»å½•ï¼Œå¯ä»¥å¼€å§‹æ“ä½œ');
      }
    });
  </script>
</body>
</html>

