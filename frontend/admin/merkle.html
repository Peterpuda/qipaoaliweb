<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Merkle Tree ç”Ÿæˆ Â· ç®¡ç†åå°</title>
<script src="/poap.config.js"></script>
<link rel="stylesheet" href="common/admin-common.css"/>
<script src="common/admin-common.js"></script>
<style>
  .merkle-card { background: var(--card); border-radius: 16px; padding: 20px; margin: 20px 0; }
  .merkle-info { background: #1a1a1a; padding: 15px; border-radius: 12px; margin: 10px 0; font-family: monospace; font-size: 13px; }
  .status { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
  .status.pending { background: #fef3c7; color: #92400e; }
  .status.ready { background: #d1fae5; color: #065f46; }
  .status.error { background: #fee2e2; color: #991b1b; }
  .btn-generate { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .log-panel { background: #0d0d0d; border: 1px solid #222; border-radius: 12px; padding: 12px; font: 13px/1.6 ui-monospace, Menlo, monospace; color: #a0aec0; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
</style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ³ Merkle Tree ç”Ÿæˆå·¥å…·</h1>
    <p class="subtitle">ä¸ºæ´»åŠ¨ç”Ÿæˆ Merkle Treeï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿé¢†å–ä»£å¸ç©ºæŠ•</p>

    <div class="merkle-card">
      <h2>æ­¥éª¤ 1ï¼šé€‰æ‹©æ´»åŠ¨</h2>
      <div class="form-group">
        <label>æ´»åŠ¨ ID / Slug</label>
        <input type="text" id="eventId" placeholder="è¾“å…¥ event_idï¼ˆå¦‚ï¼š24ï¼‰æˆ– slugï¼ˆå¦‚ï¼šairdrop-2025ï¼‰" />
      </div>
      <button class="btn btn-secondary" onclick="loadEventInfo()">ğŸ“‹ åŠ è½½æ´»åŠ¨ä¿¡æ¯</button>
    </div>

    <div id="eventInfo" class="merkle-card" style="display:none">
      <h2>æ´»åŠ¨ä¿¡æ¯</h2>
      <div class="merkle-info">
        <div><strong>æ´»åŠ¨åç§°ï¼š</strong><span id="eventName">-</span></div>
        <div><strong>æ´»åŠ¨ IDï¼š</strong><span id="eventIdDisplay">-</span></div>
        <div><strong>ç­¾åˆ°äººæ•°ï¼š</strong><span id="checkinCount">-</span></div>
        <div><strong>Merkle çŠ¶æ€ï¼š</strong><span id="merkleStatus" class="status pending">å¾…ç”Ÿæˆ</span></div>
      </div>
    </div>

    <div id="generateSection" class="merkle-card" style="display:none">
      <h2>æ­¥éª¤ 2ï¼šç”Ÿæˆ Merkle Tree</h2>
      <p style="color: var(--muted); font-size: 14px;">
        ç”Ÿæˆ Merkle Tree åï¼Œæ¯ä¸ªç­¾åˆ°ç”¨æˆ·å°†è·å¾—ä¸€ä¸ªè¯æ˜ï¼ˆproofï¼‰ï¼Œç”¨äºåœ¨é“¾ä¸Šé¢†å–ä»£å¸ã€‚
      </p>
      <button class="btn btn-generate" onclick="generateMerkle()">ğŸš€ ç”Ÿæˆ Merkle Tree</button>
    </div>

    <div id="resultSection" class="merkle-card" style="display:none">
      <h2>ç”Ÿæˆç»“æœ</h2>
      <div class="merkle-info" id="merkleResult"></div>
      <p style="margin-top: 10px; color: var(--muted); font-size: 13px;">
        âš ï¸ è¯·è®°å½• Merkle Rootï¼Œéƒ¨ç½²åˆçº¦æ—¶éœ€è¦ä½¿ç”¨
      </p>
    </div>

    <div class="merkle-card">
      <h2>æ“ä½œæ—¥å¿—</h2>
      <div class="log-panel" id="logPanel">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div class="merkle-card">
      <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
      <ol style="color: var(--muted); line-height: 1.8;">
        <li>è¾“å…¥æ´»åŠ¨ IDï¼ŒåŠ è½½æ´»åŠ¨ä¿¡æ¯</li>
        <li>ç¡®è®¤ç­¾åˆ°äººæ•°æ­£ç¡®åï¼Œç‚¹å‡»ç”Ÿæˆ Merkle Tree</li>
        <li>è®°å½•ç”Ÿæˆçš„ Merkle Root</li>
        <li>ä½¿ç”¨ Merkle Root éƒ¨ç½² Sha256MerkleDistributor åˆçº¦</li>
        <li>å°†åˆçº¦åœ°å€å‘ŠçŸ¥ç”¨æˆ·ï¼Œç”¨æˆ·å³å¯é¢†å–ä»£å¸</li>
      </ol>
    </div>
  </div>

  <script>
    const API_BASE = window.POAP_CONFIG?.WORKER_BASE_URL || 'https://songbrocade-api.petterbrand03.workers.dev';
    
    function log(message, type = 'info') {
      const panel = document.getElementById('logPanel');
      const time = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      panel.textContent += `[${time}] ${prefix} ${message}\n`;
      panel.scrollTop = panel.scrollHeight;
    }

    async function loadEventInfo() {
      const eventId = document.getElementById('eventId').value.trim();
      if (!eventId) {
        alert('è¯·è¾“å…¥æ´»åŠ¨ ID');
        return;
      }

      log(`åŠ è½½æ´»åŠ¨ä¿¡æ¯ï¼š${eventId}`);

      try {
        // åŠ è½½æ´»åŠ¨åŸºæœ¬ä¿¡æ¯
        const eventRes = await fetch(`${API_BASE}/api/events/get?slug=${eventId}`);
        const eventData = await eventRes.json();

        if (!eventData.ok) {
          log(`æ´»åŠ¨ä¸å­˜åœ¨ï¼š${eventId}`, 'error');
          return;
        }

        document.getElementById('eventName').textContent = eventData.event.name || eventId;
        document.getElementById('eventIdDisplay').textContent = eventData.event.id || eventId;

        // æŸ¥è¯¢ç­¾åˆ°äººæ•°
        const checkinRes = await fetch(`${API_BASE}/api/events/get?slug=${eventId}`);
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æœ‰ä¸“é—¨çš„ç»Ÿè®¡æ¥å£
        document.getElementById('checkinCount').textContent = 'æŸ¥è¯¢ä¸­...';

        // æ£€æŸ¥ Merkle çŠ¶æ€
        const statusSpan = document.getElementById('merkleStatus');
        statusSpan.textContent = 'å¾…ç”Ÿæˆ';
        statusSpan.className = 'status pending';

        document.getElementById('eventInfo').style.display = 'block';
        document.getElementById('generateSection').style.display = 'block';

        log('æ´»åŠ¨ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
      } catch (error) {
        log(`åŠ è½½å¤±è´¥ï¼š${error.message}`, 'error');
      }
    }

    async function generateMerkle() {
      const eventId = document.getElementById('eventId').value.trim();
      if (!eventId) {
        alert('è¯·å…ˆåŠ è½½æ´»åŠ¨ä¿¡æ¯');
        return;
      }

      if (!confirm(`ç¡®å®šè¦ä¸ºæ´»åŠ¨ ${eventId} ç”Ÿæˆ Merkle Tree å—ï¼Ÿ`)) {
        return;
      }

      log(`å¼€å§‹ç”Ÿæˆ Merkle Tree...`);

      try {
        const token = sessionStorage.getItem('qipao.admin.token') || 
                      localStorage.getItem('qipao.admin.token') || 
                      localStorage.getItem('bearer_token') || '';
        if (!token) {
          log('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç®¡ç†åå°', 'error');
          setTimeout(() => {
            window.location.href = '/admin/';
          }, 2000);
          return;
        }

        const response = await fetch(`${API_BASE}/admin/generate-merkle`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ event_id: eventId })
        });

        const data = await response.json();

        if (!data.ok) {
          log(`ç”Ÿæˆå¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
          return;
        }

        // æ˜¾ç¤ºç»“æœï¼ˆä½¿ç”¨ camelCase å­—æ®µåï¼‰
        const resultHtml = `
<strong>âœ… ç”ŸæˆæˆåŠŸï¼</strong>

æ´»åŠ¨ ID: ${data.eventId || data.event_id || eventId}
Merkle Root: ${data.merkleRoot || data.merkle_root || 'N/A'}
æ€»åœ°å€æ•°: ${data.totalAddresses || data.total_addresses || 'N/A'}
æ€»ä»£å¸é‡: ${data.totalAmount || data.total_amount || 'N/A'} wei

<strong>ä¸‹ä¸€æ­¥ï¼š</strong>
1. è®°å½•ä¸Šé¢çš„ Merkle Root
2. éƒ¨ç½² ERC20MerkleDistributor åˆçº¦ï¼ˆä½¿ç”¨æ­¤ Rootï¼‰
3. å°†è¶³å¤Ÿçš„ä»£å¸è½¬å…¥åˆçº¦åœ°å€
4. åœ¨å‰ç«¯é…ç½®åˆçº¦åœ°å€ï¼ˆpoap.config.jsï¼‰
5. ç”¨æˆ·å³å¯åœ¨ç­¾åˆ°é¡µé¢é¢†å–ä»£å¸
        `;

        document.getElementById('merkleResult').innerHTML = resultHtml.replace(/\n/g, '<br>');
        document.getElementById('resultSection').style.display = 'block';

        const statusSpan = document.getElementById('merkleStatus');
        statusSpan.textContent = 'å·²ç”Ÿæˆ';
        statusSpan.className = 'status ready';

        log('Merkle Tree ç”ŸæˆæˆåŠŸï¼', 'success');
        log(`Merkle Root: ${data.merkleRoot || data.merkle_root || 'N/A'}`);
        log(`æ€»åœ°å€æ•°: ${data.totalAddresses || data.total_addresses || 'N/A'}`);
        log(`æ€»ä»£å¸é‡: ${data.totalAmount || data.total_amount || 'N/A'} wei`);

      } catch (error) {
        log(`ç”Ÿæˆå¤±è´¥ï¼š${error.message}`, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    window.addEventListener('DOMContentLoaded', () => {
      const token = sessionStorage.getItem('qipao.admin.token') || 
                    localStorage.getItem('qipao.admin.token') || 
                    localStorage.getItem('bearer_token') || '';
      if (!token) {
        log('æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œè¯·å…ˆç™»å½•', 'error');
        if (confirm('éœ€è¦ç™»å½•ç®¡ç†åå°ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ')) {
          window.location.href = '/admin/';
        }
      } else {
        log('å·²ç™»å½•ï¼Œå¯ä»¥å¼€å§‹æ“ä½œ');
      }
    });
  </script>
</body>
</html>

