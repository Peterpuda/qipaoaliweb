<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å•†å“ç®¡ç† - æ——è¢DAOç®¡ç†åå°</title>
  <link rel="stylesheet" href="/styles/app.css"/>
  <link rel="stylesheet" href="common/admin-common.css"/>
  <script src="/poap.config.js"></script>
</head>
<body>
<div class="wrap">
  <!-- å¯¼èˆªæ  -->
  <nav class="admin-nav">
    <div class="nav-brand">å•†å“ç®¡ç†</div>
    <button class="hamburger">â˜°</button>
    <div class="nav-user">
      <span id="authState" class="pill">æœªç™»å½•</span>
    </div>
  </nav>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ  -->
  <div class="sidebar-overlay"></div>
  <div class="sidebar">
    <div class="sidebar-header">
      <div>å¯¼èˆªèœå•</div>
      <button class="sidebar-close">Ã—</button>
    </div>
    <nav class="sidebar-nav">
      <a href="/admin/index.html" class="nav-item">
        <i>ğŸ“Š</i> ä»ªè¡¨æ¿
      </a>
      <a href="/admin/events.html" class="nav-item">
        <i>ğŸª</i> æ´»åŠ¨ç®¡ç†
      </a>
      <a href="/admin/artisans.html" class="nav-item">
        <i>ğŸ‘¨â€ğŸ¨</i> ä¼ æ‰¿äººç®¡ç†
      </a>
      <a href="/admin/products.html" class="nav-item">
        <i>ğŸ›ï¸</i> å•†å“ç®¡ç†
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i>ğŸ“¦</i> è®¢å•ç®¡ç†
      </a>
      <a href="../profile/" class="nav-item">
        <i>ğŸ‘¤</i> ä¸ªäººä¸­å¿ƒ
      </a>
      <a href="javascript:logout()" class="nav-item">
        <i>ğŸšª</i> é€€å‡ºç™»å½•
      </a>
    </nav>
  </div>

  <!-- å•†å“åˆ›å»º/ç¼–è¾‘è¡¨å• -->
  <div class="card">
    <h2 class="card-title">å•†å“ä¿¡æ¯</h2>
    
    <form id="productForm">
      <input type="hidden" id="product_id" name="id" />
      
      <div class="field">
        <label>å•†å“IDï¼ˆç¼–è¾‘æ—¶è‡ªåŠ¨å¡«å…¥ï¼‰</label>
        <input id="product_id_display" placeholder="æ–°å»ºæ—¶ç•™ç©º" readonly/>
      </div>
      
      <div class="field">
        <label>ä¼ æ‰¿äººID *</label>
        <select id="product_artisan_id" name="artisan_id" required>
          <option value="">è¯·é€‰æ‹©ä¼ æ‰¿äºº</option>
        </select>
      </div>
      
      <div class="field">
        <label>å•†å“ slug *</label>
        <input id="product_slug" name="slug" placeholder="å¦‚ï¼šqipao-001" required/>
      </div>
      
      <div class="field">
        <label>æ ‡é¢˜ï¼ˆä¸­æ–‡ï¼‰*</label>
        <input id="product_title_zh" name="title_zh" placeholder="å•†å“ä¸­æ–‡æ ‡é¢˜" required/>
      </div>
      
      <div class="field">
        <label>æ ‡é¢˜ï¼ˆè‹±æ–‡ï¼‰</label>
        <input id="product_title_en" name="title_en" placeholder="Product Title (English / å¯é€‰)"/>
      </div>
      
      <div class="field">
        <label>å•†å“æè¿°ï¼ˆMarkdownï¼‰</label>
        <textarea id="product_desc_md" name="desc_md" rows="4" placeholder="æ”¯æŒ Markdown æ ¼å¼"></textarea>
      </div>
      
      <div class="field">
        <label>å›¾ç‰‡ Keyï¼ˆR2 å­˜å‚¨è·¯å¾„ï¼‰</label>
        <input id="product_image_key" name="image_key" placeholder="å¦‚ï¼šproducts/qipao-001.jpg"/>
      </div>
      
      <div class="field">
        <label>ä¸Šä¼ å›¾ç‰‡åˆ° R2</label>
        <input id="product_image_file" type="file" accept="image/*" class="w-full"/>
        <button type="button" id="btnUploadImage" class="btn btn-sm btn-secondary mt-1">
          ä¸Šä¼ å›¾ç‰‡
        </button>
      </div>
      
      <div class="grid grid-2">
        <div class="field">
          <label>ä»·æ ¼ï¼ˆåŸç”Ÿä»£å¸ï¼‰*</label>
          <input id="product_price_native" name="price_native" type="number" step="0.000001" placeholder="0.001" required/>
        </div>
        <div class="field">
          <label>è´§å¸å•ä½ *</label>
          <input id="product_price_currency" name="price_currency" placeholder="ETH" required/>
        </div>
        <div class="field">
          <label>ç§¯åˆ†ä»·æ ¼</label>
          <input id="product_price_points" name="price_points" type="number" placeholder="1000"/>
        </div>
        <div class="field">
          <label>åº“å­˜æ•°é‡</label>
          <input id="product_stock" name="stock" type="number" placeholder="10"/>
        </div>
      </div>
      
      <div class="field">
        <label>å¾½ç« åˆçº¦åœ°å€</label>
        <input id="product_badge_contract" name="badge_contract" placeholder="0x... ç”¨äº POAP å¾½ç« "/>
      </div>
      
      <div class="row">
        <button type="button" id="btnSaveProduct" class="btn btn-primary btn-block">
          ä¿å­˜ / æ›´æ–° å•†å“
        </button>
        <button type="button" id="btnClearProductForm" class="btn btn-secondary btn-block">
          æ¸…ç©ºè¡¨å•
        </button>
      </div>
    </form>
  </div>

  <!-- å•†å“åˆ—è¡¨ -->
  <div class="card">
    <h2 class="card-title">å•†å“åˆ—è¡¨</h2>
    
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>å½“å‰å•†å“</div>
      <button id="btnRefreshProducts" class="btn btn-sm btn-secondary">
        åˆ·æ–°
      </button>
    </div>
    
    <div id="product_list" class="list" style="margin-top: 12px;">
      <div class="list-item text-center">
        <div class="loading"></div>
      </div>
    </div>
  </div>

</div>

<script src="common/admin-common.js"></script>
<script>
// å•†å“ç®¡ç†ç‰¹å®šåŠŸèƒ½

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  loadArtisans();
  loadProducts();
});

// åŠ è½½ä¼ æ‰¿äººåˆ—è¡¨ï¼ˆç”¨äºä¸‹æ‹‰é€‰æ‹©ï¼‰
async function loadArtisans() {
  if (!ensureAuth()) return;
  
  try {
    const result = await apiJSONmulti(['/admin/artisans']);
    const select = $('#product_artisan_id');
    
    if (result.artisans && result.artisans.length > 0) {
      select.innerHTML = '<option value="">è¯·é€‰æ‹©ä¼ æ‰¿äºº</option>' + 
        result.artisans.map(a => `<option value="${a.id}">${a.name_zh || a.name_en || a.id}</option>`).join('');
    }
  } catch (error) {
    console.error('åŠ è½½ä¼ æ‰¿äººåˆ—è¡¨å¤±è´¥:', error);
  }
}

// ä¸Šä¼ å›¾ç‰‡åˆ°R2
$('#btnUploadImage').addEventListener('click', async () => {
  if (!ensureAuth()) return;
  
  const fileInput = $('#product_image_file');
  const file = fileInput.files[0];
  
  if (!file) {
    toast('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
    return;
  }
  
  const btn = $('#btnUploadImage');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const formData = new FormData();
    formData.append('file', file);
    
    const result = await apiJSONmulti(['/admin/upload'], {
      method: 'POST',
      body: formData
    });
    
    if (result.ok && result.key) {
      $('#product_image_key').value = result.key;
      toast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ' + result.key);
    } else {
      toast('ä¸Šä¼ å¤±è´¥: ' + (result.error || 'unknown'), 'error');
    }
    
  } catch (error) {
    console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
    toast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
});

// ä¿å­˜/æ›´æ–°å•†å“
$('#btnSaveProduct').addEventListener('click', async () => {
  if (!ensureAuth()) return;
  
  const formData = getFormData('productForm');
  const errors = validateForm(formData, ['artisan_id', 'slug', 'title_zh', 'price_native', 'price_currency']);
  
  if (errors.length > 0) {
    toast(errors.join(', '), 'error');
    return;
  }
  
  const btn = $('#btnSaveProduct');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const payload = {
      id: formData.id || undefined,
      artisan_id: formData.artisan_id,
      slug: formData.slug.trim(),
      title_zh: formData.title_zh.trim(),
      title_en: formData.title_en.trim(),
      desc_md: formData.desc_md.trim(),
      image_key: formData.image_key.trim(),
      price_native: Number(formData.price_native),
      price_currency: formData.price_currency.trim(),
      price_points: Number(formData.price_points) || 0,
      stock: Number(formData.stock) || 0,
      badge_contract: formData.badge_contract.trim()
    };
    
    const result = await apiJSONmulti(['/admin/product-upsert'], {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    if (result.ok) {
      toast('å·²ä¿å­˜å•†å“ / ID: ' + result.id);
      clearProductForm();
      loadProducts();
    } else {
      toast('ä¿å­˜å¤±è´¥: ' + (result.error || 'unknown'), 'error');
    }
    
  } catch (error) {
    console.error('ä¿å­˜å•†å“å¤±è´¥:', error);
    toast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
});

// æ¸…ç©ºå•†å“è¡¨å•
$('#btnClearProductForm').addEventListener('click', clearProductForm);

// åˆ·æ–°å•†å“åˆ—è¡¨
$('#btnRefreshProducts').addEventListener('click', loadProducts);

// åŠ è½½å•†å“åˆ—è¡¨
async function loadProducts() {
  if (!ensureAuth()) return;
  
  try {
    const result = await apiJSONmulti(['/products']);
    displayProducts(result.products || []);
  } catch (error) {
    console.error('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥:', error);
    $('#product_list').innerHTML = '<div class="list-item text-center">åŠ è½½å¤±è´¥</div>';
  }
}

// æ˜¾ç¤ºå•†å“åˆ—è¡¨
function displayProducts(products) {
  const container = $('#product_list');
  
  if (!products || products.length === 0) {
    container.innerHTML = '<div class="list-item text-center">æš‚æ— å•†å“</div>';
    return;
  }
  
  container.innerHTML = products.map(product => {
    const priceText = `${product.price_native} ${product.price_currency}`;
    const pointsText = product.price_points ? ` / ${product.price_points} ç§¯åˆ†` : '';
    const stockText = product.stock ? `åº“å­˜: ${product.stock}` : 'æ— åº“å­˜';
    
    return `
      <div class="list-item">
        <div style="flex: 1;">
          <div style="font-weight: 600;">${product.title_zh || "(æœªå‘½å)"}</div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            ${product.slug} | ${priceText}${pointsText}
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
            ${stockText} | ä¼ æ‰¿äºº: ${product.artisan_id}
          </div>
        </div>
        <div>
          <button onclick="editProduct('${product.id}')" class="btn btn-sm btn-secondary">
            ç¼–è¾‘
          </button>
        </div>
      </div>
    `;
  }).join('');
}

// ç¼–è¾‘å•†å“
function editProduct(productId) {
  // è¿™é‡Œåº”è¯¥ä»åˆ—è¡¨ä¸­è·å–å•†å“æ•°æ®ï¼Œæˆ–è€…é‡æ–°åŠ è½½å•ä¸ªå•†å“
  // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬é‡æ–°åŠ è½½åˆ—è¡¨å¹¶æ‰¾åˆ°å¯¹åº”çš„å•†å“
  loadProducts().then(() => {
    // æ‰¾åˆ°å¯¹åº”çš„å•†å“å¹¶å¡«å……è¡¨å•
    const productElement = document.querySelector(`[onclick="editProduct('${productId}')"]`);
    if (productElement) {
      // è¿™é‡Œéœ€è¦ä»æœåŠ¡å™¨è·å–å®Œæ•´çš„å•†å“æ•°æ®
      // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬æ˜¾ç¤ºä¸€ä¸ªæç¤º
      toast('è¯·ä»æœåŠ¡å™¨é‡æ–°åŠ è½½å•†å“æ•°æ®', 'error');
    }
  });
}

// æ¸…ç©ºå•†å“è¡¨å•
function clearProductForm() {
  clearForm('productForm');
  $('#product_id').value = '';
  $('#product_id_display').value = '';
  $('#product_image_file').value = '';
}

// å¡«å……å•†å“è¡¨å•
function fillProductForm(product) {
  $('#product_id').value = product.id || '';
  $('#product_id_display').value = product.id || '';
  $('#product_artisan_id').value = product.artisan_id || '';
  $('#product_slug').value = product.slug || '';
  $('#product_title_zh').value = product.title_zh || '';
  $('#product_title_en').value = product.title_en || '';
  $('#product_desc_md').value = product.desc_md || '';
  $('#product_image_key').value = product.image_key || '';
  $('#product_price_native').value = product.price_native || '';
  $('#product_price_currency').value = product.price_currency || '';
  $('#product_price_points').value = product.price_points || '';
  $('#product_stock').value = product.stock || '';
  $('#product_badge_contract').value = product.badge_contract || '';
}

// å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
window.editProduct = editProduct;
window.fillProductForm = fillProductForm;
window.clearProductForm = clearProductForm;
</script>
</body>
</html>
