<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡åŒ–å™äº‹ç”Ÿæˆå·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./common/admin-common.css">
</head>
<body class="bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="./index.html" class="text-gray-500 hover:text-gray-700">â† è¿”å›æ§åˆ¶å°</a>
                    <span class="ml-4 text-gray-300">|</span>
                    <h1 class="ml-4 text-lg font-semibold">ğŸ“– æ–‡åŒ–å™äº‹ç”Ÿæˆå·¥å…·</h1>
                </div>
                <div class="flex items-center">
                    <span id="adminAddr" class="text-sm text-gray-600"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- å•†å“é€‰æ‹© -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ¯</span>
                é€‰æ‹©å•†å“
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">é€‰æ‹©è¦ç”Ÿæˆå™äº‹çš„å•†å“</label>
                    <select id="productSelect" class="w-full px-4 py-2 border rounded-lg" onchange="loadProduct()">
                        <option value="">-- è¯·é€‰æ‹©å•†å“ --</option>
                    </select>
                </div>
                
                <div id="productInfo" class="hidden bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-6">
                    <div class="flex gap-6">
                        <img id="productImage" src="" class="w-32 h-32 object-cover rounded-lg border-2 border-yellow-500">
                        <div class="flex-1">
                            <h3 id="productName" class="text-xl font-semibold mb-2"></h3>
                            <p id="productDesc" class="text-gray-600 text-sm mb-3"></p>
                            <div class="flex items-center gap-4 text-sm">
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full">
                                    <span id="productCategory"></span>
                                </span>
                                <span class="text-gray-600">
                                    <span class="font-medium">åŒ äººï¼š</span><span id="productArtisan"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”Ÿæˆé€‰é¡¹ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6" id="generateSection" style="display: none;">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span class="text-2xl mr-2">âš™ï¸</span>
                ç”Ÿæˆé€‰é¡¹
            </h2>
            
            <div class="space-y-4">
                <!-- å™äº‹ç±»å‹ -->
                <div>
                    <label class="block font-medium mb-2">é€‰æ‹©è¦ç”Ÿæˆçš„å™äº‹ç±»å‹ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="flex items-center gap-2 p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" name="narrativeType" value="story" class="w-5 h-5">
                            <div>
                                <div class="font-medium">ğŸ“– æ•…äº‹ç‰ˆ</div>
                                <div class="text-xs text-gray-500">åˆ›ä½œæ•…äº‹ä¸æ–‡åŒ–æ„ä¹‰</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center gap-2 p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" name="narrativeType" value="feature" class="w-5 h-5">
                            <div>
                                <div class="font-medium">âœ¨ ç‰¹ç‚¹ç‰ˆ</div>
                                <div class="text-xs text-gray-500">ç‰¹è‰²ä¸å·¥è‰ºäº®ç‚¹</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center gap-2 p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" name="narrativeType" value="heritage" class="w-5 h-5">
                            <div>
                                <div class="font-medium">ğŸ›ï¸ ä¼ æ‰¿ç‰ˆ</div>
                                <div class="text-xs text-gray-500">æ–‡åŒ–ä¼ æ‰¿ä¸å†å²</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center gap-2 p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" name="narrativeType" value="usage" class="w-5 h-5">
                            <div>
                                <div class="font-medium">ğŸ’¡ ä½¿ç”¨ç‰ˆ</div>
                                <div class="text-xs text-gray-500">ä½¿ç”¨åœºæ™¯ä¸ä¿å…»</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- è¯­è¨€å’ŒAIæä¾›å•† -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-medium mb-2">è¯­è¨€</label>
                        <select id="language" class="w-full px-4 py-2 border rounded-lg">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2">AI æä¾›å•†</label>
                        <select id="provider" class="w-full px-4 py-2 border rounded-lg">
                            <option value="openai">OpenAI GPT-4o</option>
                            <option value="claude">Claude 3.5 Sonnet</option>
                        </select>
                    </div>
                </div>

                <!-- å¤šåª’ä½“ç”Ÿæˆé€‰é¡¹ -->
                <div class="border-t pt-6 mt-6">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ¬</span>
                        å¤šåª’ä½“å†…å®¹ç”Ÿæˆï¼ˆå¯é€‰ï¼‰
                    </h3>
                    
                    <!-- éŸ³é¢‘ç”Ÿæˆ -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-4">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="generateAudio" class="w-6 h-6 mt-1" onchange="toggleAudioOptions()">
                            <div class="flex-1">
                                <div class="font-medium text-lg mb-1">ğŸµ ç”Ÿæˆè¯­éŸ³ç‰ˆï¼ˆTTSï¼‰</div>
                                <div class="text-sm text-gray-600 mb-3">
                                    ä½¿ç”¨ AI å°†æ–‡å­—è½¬æ¢ä¸ºè‡ªç„¶æµç•…çš„ä¸­æ–‡è¯­éŸ³ï¼Œè®©ç”¨æˆ·å¯ä»¥æ”¶å¬æ–‡åŒ–æ•…äº‹
                                </div>
                                <div id="audioOptions" class="hidden ml-0">
                                    <label class="block text-sm font-medium mb-2">è¯­éŸ³é£æ ¼</label>
                                    <select id="voiceStyle" class="w-full px-3 py-2 border rounded-lg bg-white">
                                        <option value="nova">æ¸©æŸ”å¥³å£° (Nova) - é€‚åˆæ•…äº‹å™è¿°</option>
                                        <option value="alloy">ä¸­æ€§ä¸“ä¸šå£° (Alloy) - é€‚åˆäº§å“ä»‹ç»</option>
                                        <option value="shimmer">æ¸…æ™°å¥³å£° (Shimmer) - é€‚åˆä½¿ç”¨æŒ‡å¯¼</option>
                                        <option value="onyx">æ²‰ç¨³ç”·å£° (Onyx) - é€‚åˆæ–‡åŒ–ä¼ æ‰¿</option>
                                    </select>
                                    <div class="mt-2 text-xs text-gray-500 flex items-center gap-2">
                                        <span>ğŸ’° æˆæœ¬: çº¦ Â¥0.06/ä¸ªå™äº‹</span>
                                        <span>â€¢</span>
                                        <span>â±ï¸ æ—¶é•¿: ~30ç§’</span>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- è§†é¢‘ç”Ÿæˆ -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 mb-4">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="generateVideo" class="w-6 h-6 mt-1" onchange="toggleVideoOptions()">
                            <div class="flex-1">
                                <div class="font-medium text-lg mb-1">ğŸ¬ ç”Ÿæˆè§†é¢‘ç‰ˆï¼ˆæ•°å­—äººè®²è§£ï¼‰</div>
                                <div class="text-sm text-gray-600 mb-3">
                                    ä½¿ç”¨ AI æ•°å­—äººæœ—è¯»æ–‡åŒ–å™äº‹å†…å®¹ï¼Œä»¥ç”ŸåŠ¨çš„è§†é¢‘å½¢å¼å±•ç°ä¼ ç»Ÿå·¥è‰ºæ•…äº‹
                                </div>
                                <div id="videoOptions" class="hidden ml-0">
                                    <label class="block text-sm font-medium mb-2">æ•°å­—äººé£æ ¼</label>
                                    <select id="videoStyle" class="w-full px-3 py-2 border rounded-lg bg-white">
                                        <option value="Anna_public_3_20240108">Anna - ä¼˜é›…äºšæ´²å¥³æ€§ï¼ˆæ¨èï¼‰</option>
                                        <option value="josh_lite3_20230714">Josh - ä¸“ä¸šç”·æ€§å½¢è±¡</option>
                                        <option value="Tyler-incasual-20220721">Tyler - å¹´è½»æ´»åŠ›å½¢è±¡</option>
                                    </select>
                                    <div class="mt-2 text-xs text-gray-500 flex items-center gap-2">
                                        <span>ğŸ’° æˆæœ¬: çº¦ Â¥5/ä¸ªå™äº‹</span>
                                        <span>â€¢</span>
                                        <span>â±ï¸ æ—¶é•¿: æ ¹æ®æ–‡å­—é•¿åº¦ï¼ˆçº¦30-90ç§’ï¼‰</span>
                                        <span>â€¢</span>
                                        <span>âš ï¸ ç”Ÿæˆéœ€è¦ 3-10 åˆ†é’Ÿ</span>
                                    </div>
                                    <div class="mt-2 text-xs text-blue-600 bg-blue-50 p-2 rounded">
                                        ğŸ’¡ æç¤ºï¼šä½¿ç”¨ HeyGen AI æ•°å­—äººæŠ€æœ¯ï¼Œè‡ªåŠ¨æœ—è¯»æ–‡åŒ–æ•…äº‹
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- æˆæœ¬ä¼°ç®— -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">ğŸ’¡</span>
                            <div class="flex-1 text-sm">
                                <div class="font-medium mb-1">æˆæœ¬æç¤ºï¼ˆHeyGen æ•°å­—äººè§†é¢‘ï¼‰</div>
                                <div id="costEstimate" class="text-gray-700">
                                    <p>â€¢ ä»…æ–‡å­—: çº¦ Â¥1.72ï¼ˆ4ç§å™äº‹ï¼‰</p>
                                    <p>â€¢ æ–‡å­— + è¯­éŸ³: çº¦ Â¥1.96ï¼ˆ4ç§å™äº‹ï¼‰</p>
                                    <p>â€¢ æ–‡å­— + è¯­éŸ³ + æ•°å­—äººè§†é¢‘: çº¦ Â¥21.96ï¼ˆ4ç§å™äº‹ï¼‰</p>
                                    <p class="text-xs mt-2 text-gray-600">* æ•°å­—äººè§†é¢‘æˆæœ¬è¾ƒé«˜ä½†æ•ˆæœæ›´ä¸“ä¸šç”ŸåŠ¨</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <button onclick="generateNarratives()" class="w-full px-6 py-4 bg-gradient-to-r from-yellow-500 to-red-600 text-white rounded-lg font-semibold text-lg hover:shadow-lg transition">
                    ğŸš€ å¼€å§‹ç”Ÿæˆæ–‡åŒ–å™äº‹
                </button>
            </div>
        </div>

        <!-- ç”Ÿæˆç»“æœ -->
        <div id="resultsSection" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold mb-4">ğŸ“ ç”Ÿæˆç»“æœ</h2>
            <div id="narrativeResults"></div>
        </div>

        <!-- å†å²ç‰ˆæœ¬ -->
        <div id="historySection" class="hidden">
            <h2 class="text-2xl font-semibold mb-4">ğŸ“š å†å²ç‰ˆæœ¬</h2>
            <div id="narrativeHistory" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-8 flex flex-col items-center max-w-md">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-lg font-semibold mb-2">AI æ­£åœ¨ç”Ÿæˆä¸­...</p>
            <p class="text-sm text-gray-600 text-center" id="loadingMessage">è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        </div>
    </div>

    <script src="./common/admin-common.js"></script>
    <script>
        // ADMIN_CONFIG å·²åœ¨ admin-common.js ä¸­å®šä¹‰ï¼Œç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡

        let currentProductId = null;
        let allProducts = [];  // ç¼“å­˜æ‰€æœ‰å•†å“åˆ—è¡¨

        // é¡µé¢åŠ è½½æ—¶
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadProductsList();
        });

        async function checkAuth() {
            try {
                const data = await apiJSON('/admin/whoami');
                if (data.ok) {
                    document.getElementById('adminAddr').textContent = `ç®¡ç†å‘˜: ${data.addr}`;
                } else {
                    alert('è¯·å…ˆç™»å½•');
                    window.location.href = './index.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                alert('è®¤è¯å¤±è´¥');
                window.location.href = './index.html';
            }
        }

        async function loadProductsList() {
            try {
                const data = await apiJSON('/products');
                
                if (data.ok && data.products) {
                    allProducts = data.products;  // ç¼“å­˜åˆ°å†…å­˜
                    
                    const select = document.getElementById('productSelect');
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•†å“ --</option>';
                    
                    data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.title_zh || product.name_zh} (${product.id})`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('No products data:', data);
                    alert('æœªæ‰¾åˆ°å•†å“æ•°æ®');
                }
            } catch (error) {
                console.error('Load products failed:', error);
                alert('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        async function loadProduct() {
            const productId = document.getElementById('productSelect').value;
            if (!productId) {
                document.getElementById('productInfo').classList.add('hidden');
                document.getElementById('generateSection').style.display = 'none';
                return;
            }

            // ä»å†…å­˜ç¼“å­˜ä¸­æŸ¥æ‰¾å•†å“
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                alert('æœªæ‰¾åˆ°å•†å“ä¿¡æ¯');
                return;
            }

            currentProductId = productId;
            showLoading(true, 'åŠ è½½å•†å“ä¿¡æ¯...');

            try {
                // æ˜¾ç¤ºå•†å“ä¿¡æ¯
                document.getElementById('productInfo').classList.remove('hidden');
                
                // æ„å»ºå›¾ç‰‡ URLï¼ˆå¦‚æœæœ‰ image_keyï¼Œåˆ™ä½¿ç”¨ R2 URLï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤å›¾ç‰‡ï¼‰
                const imageUrl = product.image_key 
                    ? `${ADMIN_CONFIG.API_BASE}/image/${product.image_key}` 
                    : '/image/hero.png';
                
                document.getElementById('productImage').src = imageUrl;
                document.getElementById('productName').textContent = product.title_zh || product.name_zh || 'æœªå‘½å';
                document.getElementById('productDesc').textContent = product.desc_md || product.description || 'æš‚æ— æè¿°';
                document.getElementById('productCategory').textContent = product.slug || product.category || 'æœªåˆ†ç±»';
                document.getElementById('productArtisan').textContent = product.artisan_name_zh || product.artisan_name || 'æœªæŒ‡å®š';
                
                // æ˜¾ç¤ºç”Ÿæˆé€‰é¡¹
                document.getElementById('generateSection').style.display = 'block';
                
                // åŠ è½½å†å²ç‰ˆæœ¬
                await loadNarrativeHistory(productId);

            } catch (error) {
                console.error('Load product failed:', error);
                alert('åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åˆ‡æ¢éŸ³é¢‘é€‰é¡¹æ˜¾ç¤º
        function toggleAudioOptions() {
            const checkbox = document.getElementById('generateAudio');
            const options = document.getElementById('audioOptions');
            if (checkbox.checked) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        // åˆ‡æ¢è§†é¢‘é€‰é¡¹æ˜¾ç¤º
        function toggleVideoOptions() {
            const checkbox = document.getElementById('generateVideo');
            const options = document.getElementById('videoOptions');
            if (checkbox.checked) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        async function generateNarratives() {
            const types = Array.from(document.querySelectorAll('input[name="narrativeType"]:checked'))
                .map(cb => cb.value);
            
            if (types.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§å™äº‹ç±»å‹');
                return;
            }

            if (!currentProductId) {
                alert('è¯·å…ˆé€‰æ‹©å•†å“');
                return;
            }

            const lang = document.getElementById('language').value;
            const provider = document.getElementById('provider').value;
            
            // è·å–å¤šåª’ä½“é€‰é¡¹
            const generateAudio = document.getElementById('generateAudio').checked;
            const generateVideo = document.getElementById('generateVideo').checked;
            const voiceStyle = generateAudio ? document.getElementById('voiceStyle').value : null;
            const videoStyle = generateVideo ? document.getElementById('videoStyle').value : null;

            let loadingMsg = `æ­£åœ¨ä½¿ç”¨ ${provider === 'openai' ? 'OpenAI GPT-4o' : 'Claude 3.5'} ç”Ÿæˆ ${types.length} ä¸ªå™äº‹ç‰ˆæœ¬`;
            if (generateAudio) loadingMsg += ' + è¯­éŸ³';
            if (generateVideo) loadingMsg += ' + æ•°å­—äººè§†é¢‘';
            loadingMsg += '...';

            showLoading(true, loadingMsg);

            try {
                const requestBody = {
                    product_id: currentProductId,
                    types: types,
                    lang: lang,
                    provider: provider,
                    generate_audio: generateAudio,
                    generate_video: generateVideo
                };

                if (voiceStyle) requestBody.voice_style = voiceStyle;
                if (videoStyle) requestBody.video_style = videoStyle;

                const response = await fetch(`${ADMIN_CONFIG.API_BASE}/ai/narrative/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders()
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (data.ok) {
                    // æ˜¾ç¤ºç”Ÿæˆç»“æœ
                    displayNarrativeResults(data.narratives, data.results);
                    
                    // é‡æ–°åŠ è½½å†å²
                    await loadNarrativeHistory(currentProductId);
                    
                    alert(`âœ… æˆåŠŸç”Ÿæˆ ${data.total} ä¸ªå™äº‹ç‰ˆæœ¬ï¼`);
                } else {
                    throw new Error(data.message || data.error || 'ç”Ÿæˆå¤±è´¥');
                }

            } catch (error) {
                console.error('Generate narratives failed:', error);
                alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayNarrativeResults(narratives, results) {
            const container = document.getElementById('narrativeResults');
            const section = document.getElementById('resultsSection');
            
            container.innerHTML = '';
            section.classList.remove('hidden');

            const typeNames = {
                story: 'ğŸ“– æ•…äº‹ç‰ˆ',
                feature: 'âœ¨ ç‰¹ç‚¹ç‰ˆ',
                heritage: 'ğŸ›ï¸ ä¼ æ‰¿ç‰ˆ',
                usage: 'ğŸ’¡ ä½¿ç”¨ç‰ˆ'
            };

            narratives.forEach(narrative => {
                const result = results[narrative.type];
                
                // æ„å»ºå¤šåª’ä½“é“¾æ¥
                let multimediaHTML = '';
                if (narrative.audio_url || narrative.video_url || narrative.generation_status === 'processing') {
                    multimediaHTML = '<div class="mt-4 pt-4 border-t">';
                    multimediaHTML += '<h4 class="font-medium text-sm mb-2">ğŸ¬ å¤šåª’ä½“å†…å®¹</h4>';
                    multimediaHTML += '<div class="flex gap-2 flex-wrap">';
                    
                    if (narrative.audio_url) {
                        multimediaHTML += `
                            <a href="${narrative.audio_url}" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 text-sm">
                                ğŸµ æ”¶å¬è¯­éŸ³ç‰ˆ
                            </a>
                        `;
                    }
                    
                    if (narrative.video_url) {
                        multimediaHTML += `
                            <a href="${narrative.video_url}" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 text-sm">
                                ğŸ¬ è§‚çœ‹è§†é¢‘ç‰ˆ
                            </a>
                        `;
                    }
                    
                    if (narrative.generation_status === 'processing') {
                        multimediaHTML += `
                            <span class="inline-flex items-center gap-2 px-3 py-2 bg-yellow-50 text-yellow-700 rounded-lg text-sm">
                                â³ è§†é¢‘ç”Ÿæˆä¸­...ï¼ˆ2-5åˆ†é’Ÿï¼‰
                            </span>
                        `;
                    }
                    
                    multimediaHTML += '</div></div>';
                }
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-6';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold">${typeNames[narrative.type]}</h3>
                            <p class="text-sm text-gray-500">
                                æ¨¡å‹: ${result.model} | Token: ${result.tokensUsed}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyNarrative('${narrative.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                            <button onclick="reviewNarrative('${narrative.id}', 'approve')" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm">
                                âœ… å‘å¸ƒ
                            </button>
                        </div>
                    </div>
                    <div class="prose max-w-none">
                        <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${narrative.content}</p>
                    </div>
                    ${multimediaHTML}
                `;
                
                container.appendChild(card);
            });
        }

        async function loadNarrativeHistory(productId) {
            try {
                const data = await apiJSON(`/ai/narrative/product/${productId}?status=all`);
                
                if (data.ok && data.narratives && data.narratives.length > 0) {
                    displayNarrativeHistory(data.narratives);
                    document.getElementById('historySection').classList.remove('hidden');
                } else {
                    document.getElementById('historySection').classList.add('hidden');
                }

            } catch (error) {
                console.error('Load history failed:', error);
                document.getElementById('historySection').classList.add('hidden');
            }
        }

        function displayNarrativeHistory(narratives) {
            const container = document.getElementById('narrativeHistory');
            container.innerHTML = '';

            const typeNames = {
                story: 'ğŸ“– æ•…äº‹ç‰ˆ',
                feature: 'âœ¨ ç‰¹ç‚¹ç‰ˆ',
                heritage: 'ğŸ›ï¸ ä¼ æ‰¿ç‰ˆ',
                usage: 'ğŸ’¡ ä½¿ç”¨ç‰ˆ'
            };

            const statusColors = {
                draft: 'bg-gray-100 text-gray-700',
                published: 'bg-green-100 text-green-700',
                archived: 'bg-red-100 text-red-700'
            };

            narratives.forEach(narrative => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-4';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold">${typeNames[narrative.type]}</h4>
                        <span class="px-2 py-1 rounded text-xs ${statusColors[narrative.status]}">
                            ${narrative.status}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 line-clamp-3 mb-3">${narrative.content}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>ç‰ˆæœ¬ ${narrative.version}</span>
                        <div class="flex gap-2">
                            ${narrative.status !== 'published' ? `
                                <button onclick="reviewNarrative('${narrative.id}', 'approve')" class="text-green-600 hover:underline">å‘å¸ƒ</button>
                            ` : ''}
                            <button onclick="deleteNarrative('${narrative.id}')" class="text-red-600 hover:underline">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function reviewNarrative(narrativeId, action) {
            if (!confirm(`ç¡®å®šè¦${action === 'approve' ? 'å‘å¸ƒ' : 'å½’æ¡£'}è¿™ä¸ªå™äº‹ç‰ˆæœ¬å—ï¼Ÿ`)) return;

            showLoading(true);

            try {
                const response = await fetch(`${ADMIN_CONFIG.API_BASE}/admin/narrative/review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders()
                    },
                    body: JSON.stringify({
                        narrative_id: narrativeId,
                        action: action
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    alert('âœ… æ“ä½œæˆåŠŸï¼');
                    await loadNarrativeHistory(currentProductId);
                } else {
                    throw new Error(data.error || 'æ“ä½œå¤±è´¥');
                }

            } catch (error) {
                console.error('Review failed:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteNarrative(narrativeId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå™äº‹ç‰ˆæœ¬å—ï¼Ÿ')) return;

            showLoading(true);

            try {
                const response = await fetch(`${ADMIN_CONFIG.API_BASE}/admin/narrative/${narrativeId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });

                const data = await response.json();
                
                if (data.ok) {
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                    await loadNarrativeHistory(currentProductId);
                } else {
                    throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
                }

            } catch (error) {
                console.error('Delete failed:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function copyNarrative(narrativeId) {
            const text = document.querySelector(`#narrativeResults .bg-white`).querySelector('.prose p').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
                alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }
        }

        function showLoading(show, message = 'å¤„ç†ä¸­...') {
            const loading = document.getElementById('loading');
            const loadingMessage = document.getElementById('loadingMessage');
            loading.classList.toggle('hidden', !show);
            if (message) loadingMessage.textContent = message;
        }

        function authHeaders() {
            const token = sessionStorage.getItem('qipao.admin.token') || 
                         localStorage.getItem('qipao.admin.token') || 
                         localStorage.getItem('bearer_token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }
    </script>
</body>
</html>

