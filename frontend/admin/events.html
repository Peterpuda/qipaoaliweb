<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æ´»åŠ¨ç®¡ç† - æ——è¢DAOç®¡ç†åå°</title>
  <link rel="stylesheet" href="/styles/app.css"/>
  <link rel="stylesheet" href="common/admin-common.css"/>
  <script src="/poap.config.js"></script>
</head>
<body>
<div class="wrap">
  <!-- å¯¼èˆªæ  -->
  <nav class="admin-nav">
    <div class="nav-brand">æ´»åŠ¨ç®¡ç†</div>
    <button class="hamburger">â˜°</button>
    <div class="nav-user">
      <span id="authState" class="pill">æœªç™»å½•</span>
    </div>
  </nav>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ  -->
  <div class="sidebar-overlay"></div>
  <div class="sidebar">
    <div class="sidebar-header">
      <div>å¯¼èˆªèœå•</div>
      <button class="sidebar-close">Ã—</button>
    </div>
    <nav class="sidebar-nav">
      <a href="/admin/index.html" class="nav-item">
        <i>ğŸ“Š</i> ä»ªè¡¨æ¿
      </a>
      <a href="/admin/events.html" class="nav-item">
        <i>ğŸª</i> æ´»åŠ¨ç®¡ç†
      </a>
      <a href="/admin/artisans.html" class="nav-item">
        <i>ğŸ‘¨â€ğŸ¨</i> ä¼ æ‰¿äººç®¡ç†
      </a>
      <a href="/admin/products.html" class="nav-item">
        <i>ğŸ›ï¸</i> å•†å“ç®¡ç†
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i>ğŸ“¦</i> è®¢å•ç®¡ç†
      </a>
      <a href="../profile/" class="nav-item">
        <i>ğŸ‘¤</i> ä¸ªäººä¸­å¿ƒ
      </a>
      <a href="javascript:logout()" class="nav-item">
        <i>ğŸšª</i> é€€å‡ºç™»å½•
      </a>
    </nav>
  </div>

  <!-- æ´»åŠ¨åˆ›å»º/ç¼–è¾‘ -->
  <div class="card">
    <h2 class="card-title">æ´»åŠ¨ç»´æŠ¤</h2>
    
    <form id="eventForm">
      <div class="grid grid-2">
        <div class="field">
          <label>æ´»åŠ¨ slug *</label>
          <input id="evSlug" name="slug" placeholder="å¦‚ï¼šqipao-20251208" required/>
        </div>
        <div class="field">
          <label>æ ‡é¢˜ *</label>
          <input id="evTitle" name="title" placeholder="æ´»åŠ¨æ ‡é¢˜" required/>
        </div>
        <div class="field">
          <label>å¼€å§‹æ—¥æœŸ</label>
          <input id="evStart" name="start_date" type="date" placeholder="é€‰æ‹©å¼€å§‹æ—¥æœŸ"/>
          <small style="color: var(--muted); font-size: 11px; margin-top: 4px; display: block;">
            ç•™ç©ºåˆ™ä½¿ç”¨ä»Šå¤©
          </small>
        </div>
        <div class="field">
          <label>ç»“æŸæ—¥æœŸ</label>
          <input id="evEnd" name="end_date" type="date" placeholder="é€‰æ‹©ç»“æŸæ—¥æœŸ"/>
          <small style="color: var(--muted); font-size: 11px; margin-top: 4px; display: block;">
            ç•™ç©ºåˆ™ä¸ºå¼€å§‹æ—¥æœŸ + 1 å¤©
          </small>
        </div>
      </div>
      
      <div class="row">
        <button type="button" id="btnSave" class="btn btn-primary btn-block">
          ä¿å­˜ / æ›´æ–°æ´»åŠ¨
        </button>
        <button type="button" id="btnGetCode" class="btn btn-secondary btn-block">
          è·å–å›ºå®šç­¾åˆ°ç 
        </button>
      </div>
    </form>
  </div>

  <!-- äºŒç»´ç ç”Ÿæˆ -->
  <div class="card">
    <h2 class="card-title">ç­¾åˆ°äºŒç»´ç </h2>
    
    <div class="row" style="align-items: flex-start;">
      <div class="qr" id="qrBox" style="position: relative; margin-right: 16px;">
        <img id="qrImg" alt="ç­¾åˆ°äºŒç»´ç " style="width: 200px; height: 200px; border-radius: 12px;"/>
      </div>
      <div style="flex: 1; min-width: 0;">
        <div class="mb-2">
          <strong>å›ºå®šç ï¼š</strong><span id="staticCode">ï¼ˆæœªè·å–ï¼‰</span>
        </div>
        <div class="mb-2">
          <label>æ‰«ç  URLï¼š</label>
          <pre id="qrUrl" class="mono" style="font-size: 11px; word-break: break-all;"></pre>
        </div>
        <div class="row">
          <button id="qrCopy" class="btn btn-sm btn-primary" style="flex: 1;">
            å¤åˆ¶ç­¾åˆ°é“¾æ¥
          </button>
          <a id="qrDownload" class="btn btn-sm btn-secondary" download style="flex: 1; text-align: center;">
            ä¸‹è½½äºŒç»´ç 
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- æ•°æ®å¯¼å‡º -->
  <div class="card">
    <h2 class="card-title">å¯¼å‡ºæ•°æ®</h2>
    
    <div class="row">
      <div class="field" style="flex: 1;">
        <input id="exportSlug" placeholder="æ´»åŠ¨ slug"/>
      </div>
      <button id="btnExport" class="btn btn-secondary">
        å¯¼å‡ºæŠ•ç¥¨ CSV
      </button>
    </div>
    
    <pre id="exportCmd" class="mono" style="margin-top: 12px; font-size: 11px;"></pre>
  </div>

  <!-- æ´»åŠ¨åˆ—è¡¨ -->
  <div class="card">
    <h2 class="card-title">æ´»åŠ¨åˆ—è¡¨</h2>
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>å½“å‰æ´»åŠ¨</div>
      <button id="btnRefreshEvents" class="btn btn-sm btn-secondary">
        åˆ·æ–°
      </button>
    </div>
    <div id="eventsList" class="list" style="margin-top: 12px;">
      <div class="list-item text-center">
        <div class="loading"></div>
      </div>
    </div>
  </div>

</div>

<script src="common/admin-common.js"></script>
<script>
// ===== æ—¥æœŸè½¬æ¢å·¥å…·å‡½æ•° =====

/**
 * å°†æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼‰è½¬æ¢ä¸ºå¤©æ•°æ—¶é—´æˆ³
 * @param {string} dateStr - æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ï¼šYYYY-MM-DD
 * @returns {number|null} - å¤©æ•°æ—¶é—´æˆ³ï¼ˆä» 1970-01-01 å¼€å§‹çš„å¤©æ•°ï¼‰
 */
function dateToTimestamp(dateStr) {
  if (!dateStr) return null;
  const date = new Date(dateStr + 'T00:00:00Z'); // UTC æ—¶é—´
  return Math.floor(date.getTime() / (1000 * 60 * 60 * 24));
}

/**
 * å°†å¤©æ•°æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼‰
 * @param {number} timestamp - å¤©æ•°æ—¶é—´æˆ³
 * @returns {string} - æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ï¼šYYYY-MM-DD
 */
function timestampToDate(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp * 24 * 60 * 60 * 1000);
  return date.toISOString().split('T')[0];
}

/**
 * è·å–ä»Šå¤©çš„å¤©æ•°æ—¶é—´æˆ³
 * @returns {number} - ä»Šå¤©çš„å¤©æ•°æ—¶é—´æˆ³
 */
function getTodayTimestamp() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  return Math.floor(today.getTime() / (1000 * 60 * 60 * 24));
}

// æ´»åŠ¨ç®¡ç†ç‰¹å®šåŠŸèƒ½
let currentEventSlug = '';

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  // ä»URLå‚æ•°è·å–æ´»åŠ¨slug
  const urlParams = new URLSearchParams(window.location.search);
  const eventSlug = urlParams.get('event') || urlParams.get('slug');
  if (eventSlug) {
    $('#evSlug').value = eventSlug;
    currentEventSlug = eventSlug;
    setQRAndLinks(eventSlug, '');
  }
  
  // åŠ è½½æ´»åŠ¨åˆ—è¡¨
  loadEvents();
  
  // âœ… ç»‘å®šæ‰€æœ‰æŒ‰é’®äº‹ä»¶
  const btnRefresh = $('#btnRefreshEvents');
  if (btnRefresh) {
    btnRefresh.addEventListener('click', loadEvents);
  }
  
  $('#btnSave')?.addEventListener('click', handleSaveEvent);
  $('#btnGetCode')?.addEventListener('click', handleGetCode);
  $('#btnExport')?.addEventListener('click', handleExport);
  
  // å¼€å§‹æ—¥æœŸå˜åŒ–æ—¶ï¼Œè‡ªåŠ¨è®¾ç½®ç»“æŸæ—¥æœŸä¸º +1 å¤©
  $('#evStart')?.addEventListener('change', function() {
    const endInput = $('#evEnd');
    if (!endInput.value && this.value) {
      const startDate = new Date(this.value);
      startDate.setDate(startDate.getDate() + 1);
      endInput.value = startDate.toISOString().split('T')[0];
    }
  });
});

// å®šä¹‰æŒ‰é’®äº‹ä»¶å¤„ç†å‡½æ•°
async function handleSaveEvent() {
  if (!ensureAuth()) return;
  
  const formData = getFormData('eventForm');
  const errors = validateForm(formData, ['slug', 'title']);
  
  if (errors.length > 0) {
    toast(errors.join(', '), 'error');
    return;
  }
  
  // è½¬æ¢æ—¥æœŸä¸ºå¤©æ•°æ—¶é—´æˆ³
  const startTs = dateToTimestamp(formData.start_date);
  const endTs = dateToTimestamp(formData.end_date);
  
  // éªŒè¯æ—¥æœŸé€»è¾‘
  if (startTs && endTs && startTs >= endTs) {
    toast('ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€å§‹æ—¥æœŸ', 'error');
    return;
  }
  
  const btn = $('#btnSave');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const payload = {
      slug: formData.slug.trim(),
      title: formData.title.trim(),
      start_ts: startTs,  // å¤©æ•°æ—¶é—´æˆ³
      end_ts: endTs       // å¤©æ•°æ—¶é—´æˆ³
    };
    
    const result = await apiJSONmulti(['/admin/event-upsert'], {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    toast('ä¿å­˜æˆåŠŸ');
    currentEventSlug = payload.slug;
    
    if (result.static_code) {
      $('#staticCode').textContent = result.static_code;
      setQRAndLinks(payload.slug, result.static_code);
    }
    
    // åˆ·æ–°æ´»åŠ¨åˆ—è¡¨
    loadEvents();
    
  } catch (error) {
    console.error('ä¿å­˜æ´»åŠ¨å¤±è´¥:', error);
    toast('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
}

async function handleGetCode() {
  if (!ensureAuth()) return;
  
  const slug = $('#evSlug').value.trim();
  if (!slug) {
    toast('è¯·å…ˆå¡«å†™æ´»åŠ¨ slug', 'error');
    return;
  }
  
  const btn = $('#btnGetCode');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const result = await apiJSONmulti([
      `/admin/event-code?event_slug=${encodeURIComponent(slug)}`
    ], { method: 'GET' });
    
    $('#staticCode').textContent = result.static_code || 'ï¼ˆæ— ï¼‰';
    setQRAndLinks(slug, result.static_code || '');
    currentEventSlug = slug;
    
  } catch (error) {
    console.error('è·å–ç­¾åˆ°ç å¤±è´¥:', error);
    toast('è·å–å¤±è´¥ï¼š' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
}

function handleExport() {
  if (!ensureAuth()) return;
  
  const slug = $('#exportSlug').value.trim();
  if (!slug) {
    toast('è¯·å…ˆå¡«å†™æ´»åŠ¨ slug', 'error');
    return;
  }
  
  const token = getBearer();
  const url1 = `${ADMIN_CONFIG.API_BASE}/admin/export/votes?event_slug=${encodeURIComponent(slug)}`;
  const url2 = `${ADMIN_CONFIG.API_BASE}/admin/export/votes?event_slug=${encodeURIComponent(slug)}`;
  
  const cmd = `# ä»»é€‰å…¶ä¸€ï¼ˆæ ¹æ®ä½ çš„ Worker è·¯ç”±ï¼‰
curl -H "Authorization: Bearer ${token}" "${url1}" -o votes_${slug}.csv
curl -H "Authorization: Bearer ${token}" "${url2}" -o votes_${slug}.csv`;
  
  $('#exportCmd').textContent = cmd;
  toast('å·²ç”Ÿæˆå¯¼å‡ºå‘½ä»¤ï¼Œå¤åˆ¶åˆ°ç»ˆç«¯æ‰§è¡Œå³å¯');
}


// åŠ è½½æ´»åŠ¨åˆ—è¡¨
async function loadEvents() {
  if (!ensureAuth()) return;
  
  try {
    const result = await apiJSONmulti(['/poap/events']);
    displayEvents(result.events || []);
  } catch (error) {
    console.error('åŠ è½½æ´»åŠ¨åˆ—è¡¨å¤±è´¥:', error);
    $('#eventsList').innerHTML = '<div class="list-item text-center">åŠ è½½å¤±è´¥</div>';
  }
}

// æ˜¾ç¤ºæ´»åŠ¨åˆ—è¡¨
function displayEvents(events) {
  const container = $('#eventsList');
  
  if (!events || events.length === 0) {
    container.innerHTML = '<div class="list-item text-center">æš‚æ— æ´»åŠ¨</div>';
    return;
  }
  
  const todayTs = getTodayTimestamp();
  
  container.innerHTML = events.map(event => {
    // åˆ¤æ–­æ´»åŠ¨çŠ¶æ€ï¼ˆåŸºäºå¤©æ•°æ—¶é—´æˆ³ï¼‰
    let statusClass = 'pill-warning';
    let statusText = 'æœªçŸ¥';
    
    if (event.start_ts && event.end_ts) {
      if (todayTs < event.start_ts) {
        statusClass = 'pill-info';
        statusText = 'æœªå¼€å§‹';
      } else if (todayTs >= event.start_ts && todayTs <= event.end_ts) {
        statusClass = 'pill-ok';
        statusText = 'è¿›è¡Œä¸­';
      } else {
        statusClass = 'pill-error';
        statusText = 'å·²ç»“æŸ';
      }
    } else if (event.start_ts) {
      statusClass = todayTs >= event.start_ts ? 'pill-ok' : 'pill-info';
      statusText = todayTs >= event.start_ts ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹';
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
    const startDate = event.start_ts ? timestampToDate(event.start_ts) : 'æœªè®¾ç½®';
    const endDate = event.end_ts ? timestampToDate(event.end_ts) : 'æœªè®¾ç½®';
    
    return `
      <div class="list-item">
        <div style="flex: 1;">
          <div style="font-weight: 600;">${event.name || 'æœªå‘½åæ´»åŠ¨'}</div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            Slug: ${event.slug || 'N/A'}
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
            å¼€å§‹: ${startDate} | ç»“æŸ: ${endDate}
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
          <span class="pill ${statusClass}">${statusText}</span>
          <button 
            class="btn btn-sm btn-secondary" 
            onclick="editEvent('${event.slug}')"
            style="font-size: 11px; padding: 4px 8px;"
          >
            ç¼–è¾‘
          </button>
        </div>
      </div>
    `;
  }).join('');
}

// ç¼–è¾‘æ´»åŠ¨
async function editEvent(slug) {
  if (!ensureAuth()) return;
  
  try {
    // ä»æ´»åŠ¨åˆ—è¡¨ä¸­æŸ¥æ‰¾
    const result = await apiJSONmulti(['/poap/events']);
    const event = result.events?.find(e => e.slug === slug);
    
    if (event) {
      // å¡«å……è¡¨å•
      $('#evSlug').value = event.slug || '';
      $('#evTitle').value = event.name || '';
      
      // å°†å¤©æ•°æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸ
      if (event.start_ts) {
        $('#evStart').value = timestampToDate(event.start_ts);
      }
      if (event.end_ts) {
        $('#evEnd').value = timestampToDate(event.end_ts);
      }
      
      currentEventSlug = slug;
      
      // æ»šåŠ¨åˆ°è¡¨å•
      document.querySelector('#eventForm').scrollIntoView({ behavior: 'smooth' });
      toast('å·²åŠ è½½æ´»åŠ¨ä¿¡æ¯ï¼Œå¯ä»¥ç¼–è¾‘');
    }
  } catch (error) {
    console.error('åŠ è½½æ´»åŠ¨å¤±è´¥:', error);
    toast('åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
  }
}

// åˆ·æ–°æŒ‰é’®äº‹ä»¶å·²åœ¨ DOMContentLoaded å›è°ƒä¸­ç»‘å®š
</script>
</body>
</html>
