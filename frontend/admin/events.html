<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æ´»åŠ¨ç®¡ç† - æ——è¢DAOç®¡ç†åå°</title>
  <link rel="stylesheet" href="/styles/app.css"/>
  <link rel="stylesheet" href="common/admin-common.css"/>
  <script src="/poap.config.js"></script>
</head>
<body>
<div class="wrap">
  <!-- å¯¼èˆªæ  -->
  <nav class="admin-nav">
    <div class="nav-brand">æ´»åŠ¨ç®¡ç†</div>
    <button class="hamburger">â˜°</button>
    <div class="nav-user">
      <span id="authState" class="pill">æœªç™»å½•</span>
    </div>
  </nav>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ  -->
  <div class="sidebar-overlay"></div>
  <div class="sidebar">
    <div class="sidebar-header">
      <div>å¯¼èˆªèœå•</div>
      <button class="sidebar-close">Ã—</button>
    </div>
    <nav class="sidebar-nav">
      <a href="/admin/index.html" class="nav-item">
        <i>ğŸ“Š</i> ä»ªè¡¨æ¿
      </a>
      <a href="/admin/events.html" class="nav-item">
        <i>ğŸª</i> æ´»åŠ¨ç®¡ç†
      </a>
      <a href="/admin/artisans.html" class="nav-item">
        <i>ğŸ‘¨â€ğŸ¨</i> ä¼ æ‰¿äººç®¡ç†
      </a>
      <a href="/admin/products.html" class="nav-item">
        <i>ğŸ›ï¸</i> å•†å“ç®¡ç†
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i>ğŸ“¦</i> è®¢å•ç®¡ç†
      </a>
      <a href="../profile/" class="nav-item">
        <i>ğŸ‘¤</i> ä¸ªäººä¸­å¿ƒ
      </a>
      <a href="javascript:logout()" class="nav-item">
        <i>ğŸšª</i> é€€å‡ºç™»å½•
      </a>
    </nav>
  </div>

  <!-- æ´»åŠ¨åˆ›å»º/ç¼–è¾‘ -->
  <div class="card">
    <h2 class="card-title">æ´»åŠ¨ç»´æŠ¤</h2>
    
    <form id="eventForm">
      <div class="grid grid-2">
        <div class="field">
          <label>æ´»åŠ¨ slug</label>
          <input id="evSlug" name="slug" placeholder="å¦‚ï¼šqipao-20251208" required/>
        </div>
        <div class="field">
          <label>æ ‡é¢˜</label>
          <input id="evTitle" name="title" placeholder="æ´»åŠ¨æ ‡é¢˜" required/>
        </div>
        <div class="field">
          <label>å¼€å§‹æ—¶é—´</label>
          <input id="evStart" name="start_ts" type="number" placeholder="ç•™ç©º=now"/>
        </div>
        <div class="field">
          <label>ç»“æŸæ—¶é—´</label>
          <input id="evEnd" name="end_ts" type="number" placeholder="ç•™ç©º=+1å¤©"/>
        </div>
      </div>
      
      <div class="row">
        <button type="button" id="btnSave" class="btn btn-primary btn-block">
          ä¿å­˜ / æ›´æ–°æ´»åŠ¨
        </button>
        <button type="button" id="btnGetCode" class="btn btn-secondary btn-block">
          è·å–å›ºå®šç­¾åˆ°ç 
        </button>
      </div>
    </form>
  </div>

  <!-- äºŒç»´ç ç”Ÿæˆ -->
  <div class="card">
    <h2 class="card-title">ç­¾åˆ°äºŒç»´ç </h2>
    
    <div class="row" style="align-items: flex-start;">
      <div class="qr" id="qrBox" style="position: relative; margin-right: 16px;">
        <img id="qrImg" alt="ç­¾åˆ°äºŒç»´ç " style="width: 200px; height: 200px; border-radius: 12px;"/>
      </div>
      <div style="flex: 1; min-width: 0;">
        <div class="mb-2">
          <strong>å›ºå®šç ï¼š</strong><span id="staticCode">ï¼ˆæœªè·å–ï¼‰</span>
        </div>
        <div class="mb-2">
          <label>æ‰«ç  URLï¼š</label>
          <pre id="qrUrl" class="mono" style="font-size: 11px; word-break: break-all;"></pre>
        </div>
        <div class="row">
          <button id="qrCopy" class="btn btn-sm btn-primary" style="flex: 1;">
            å¤åˆ¶ç­¾åˆ°é“¾æ¥
          </button>
          <a id="qrDownload" class="btn btn-sm btn-secondary" download style="flex: 1; text-align: center;">
            ä¸‹è½½äºŒç»´ç 
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- æ•°æ®å¯¼å‡º -->
  <div class="card">
    <h2 class="card-title">å¯¼å‡ºæ•°æ®</h2>
    
    <div class="row">
      <div class="field" style="flex: 1;">
        <input id="exportSlug" placeholder="æ´»åŠ¨ slug"/>
      </div>
      <button id="btnExport" class="btn btn-secondary">
        å¯¼å‡ºæŠ•ç¥¨ CSV
      </button>
    </div>
    
    <pre id="exportCmd" class="mono" style="margin-top: 12px; font-size: 11px;"></pre>
  </div>

  <!-- æ´»åŠ¨åˆ—è¡¨ -->
  <div class="card">
    <h2 class="card-title">æ´»åŠ¨åˆ—è¡¨</h2>
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>å½“å‰æ´»åŠ¨</div>
      <button id="btnRefreshEvents" class="btn btn-sm btn-secondary">
        åˆ·æ–°
      </button>
    </div>
    <div id="eventsList" class="list" style="margin-top: 12px;">
      <div class="list-item text-center">
        <div class="loading"></div>
      </div>
    </div>
  </div>

</div>

<script src="common/admin-common.js"></script>
<script>
// æ´»åŠ¨ç®¡ç†ç‰¹å®šåŠŸèƒ½
let currentEventSlug = '';

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  // ä»URLå‚æ•°è·å–æ´»åŠ¨slug
  const urlParams = new URLSearchParams(window.location.search);
  const eventSlug = urlParams.get('event') || urlParams.get('slug');
  if (eventSlug) {
    $('#evSlug').value = eventSlug;
    currentEventSlug = eventSlug;
    setQRAndLinks(eventSlug, '');
  }
  
  // åŠ è½½æ´»åŠ¨åˆ—è¡¨
  loadEvents();
  
  // âœ… ç»‘å®šæ‰€æœ‰æŒ‰é’®äº‹ä»¶
  const btnRefresh = $('#btnRefreshEvents');
  if (btnRefresh) {
    btnRefresh.addEventListener('click', loadEvents);
  }
  
  $('#btnSave')?.addEventListener('click', handleSaveEvent);
  $('#btnGetCode')?.addEventListener('click', handleGetCode);
  $('#btnExport')?.addEventListener('click', handleExport);
});

// å®šä¹‰æŒ‰é’®äº‹ä»¶å¤„ç†å‡½æ•°
async function handleSaveEvent() {
  if (!ensureAuth()) return;
  
  const formData = getFormData('eventForm');
  const errors = validateForm(formData, ['slug', 'title']);
  
  if (errors.length > 0) {
    toast(errors.join(', '), 'error');
    return;
  }
  
  const btn = $('#btnSave');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const payload = {
      slug: formData.slug.trim(),
      title: formData.title.trim(),
      start_ts: formData.start_ts ? Number(formData.start_ts) : null,
      end_ts: formData.end_ts ? Number(formData.end_ts) : null
    };
    
    const result = await apiJSONmulti(['/admin/event-upsert'], {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    toast('ä¿å­˜æˆåŠŸ');
    currentEventSlug = payload.slug;
    
    if (result.static_code) {
      $('#staticCode').textContent = result.static_code;
      setQRAndLinks(payload.slug, result.static_code);
    }
    
    // åˆ·æ–°æ´»åŠ¨åˆ—è¡¨
    loadEvents();
    
  } catch (error) {
    console.error('ä¿å­˜æ´»åŠ¨å¤±è´¥:', error);
    toast('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
}

async function handleGetCode() {
  if (!ensureAuth()) return;
  
  const slug = $('#evSlug').value.trim();
  if (!slug) {
    toast('è¯·å…ˆå¡«å†™æ´»åŠ¨ slug', 'error');
    return;
  }
  
  const btn = $('#btnGetCode');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const result = await apiJSONmulti([
      `/admin/event-code?event_slug=${encodeURIComponent(slug)}`
    ], { method: 'GET' });
    
    $('#staticCode').textContent = result.static_code || 'ï¼ˆæ— ï¼‰';
    setQRAndLinks(slug, result.static_code || '');
    currentEventSlug = slug;
    
  } catch (error) {
    console.error('è·å–ç­¾åˆ°ç å¤±è´¥:', error);
    toast('è·å–å¤±è´¥ï¼š' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
}

function handleExport() {
  if (!ensureAuth()) return;
  
  const slug = $('#exportSlug').value.trim();
  if (!slug) {
    toast('è¯·å…ˆå¡«å†™æ´»åŠ¨ slug', 'error');
    return;
  }
  
  const token = getBearer();
  const url1 = `${ADMIN_CONFIG.API_BASE}/admin/export/votes?event_slug=${encodeURIComponent(slug)}`;
  const url2 = `${ADMIN_CONFIG.API_BASE}/admin/export/votes?event_slug=${encodeURIComponent(slug)}`;
  
  const cmd = `# ä»»é€‰å…¶ä¸€ï¼ˆæ ¹æ®ä½ çš„ Worker è·¯ç”±ï¼‰
curl -H "Authorization: Bearer ${token}" "${url1}" -o votes_${slug}.csv
curl -H "Authorization: Bearer ${token}" "${url2}" -o votes_${slug}.csv`;
  
  $('#exportCmd').textContent = cmd;
  toast('å·²ç”Ÿæˆå¯¼å‡ºå‘½ä»¤ï¼Œå¤åˆ¶åˆ°ç»ˆç«¯æ‰§è¡Œå³å¯');
}


// åŠ è½½æ´»åŠ¨åˆ—è¡¨
async function loadEvents() {
  if (!ensureAuth()) return;
  
  try {
    const result = await apiJSONmulti(['/poap/events']);
    displayEvents(result.events || []);
  } catch (error) {
    console.error('åŠ è½½æ´»åŠ¨åˆ—è¡¨å¤±è´¥:', error);
    $('#eventsList').innerHTML = '<div class="list-item text-center">åŠ è½½å¤±è´¥</div>';
  }
}

// æ˜¾ç¤ºæ´»åŠ¨åˆ—è¡¨
function displayEvents(events) {
  const container = $('#eventsList');
  
  if (!events || events.length === 0) {
    container.innerHTML = '<div class="list-item text-center">æš‚æ— æ´»åŠ¨</div>';
    return;
  }
  
  container.innerHTML = events.map(event => {
    const isActive = event.start_ts && event.start_ts > Date.now() / 1000;
    const statusClass = isActive ? 'pill-ok' : 'pill-warning';
    const statusText = isActive ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ';
    
    return `
      <div class="list-item">
        <div>
          <div style="font-weight: 600;">${event.name || 'æœªå‘½åæ´»åŠ¨'}</div>
          <div style="font-size: 12px; color: var(--muted);">
            ID: ${event.id} | åˆ›å»ºæ—¶é—´: ${event.created_at ? formatDate(event.created_at) : 'æœªçŸ¥'}
          </div>
        </div>
        <div>
          <span class="pill ${statusClass}">${statusText}</span>
        </div>
      </div>
    `;
  }).join('');
}

// åˆ·æ–°æŒ‰é’®äº‹ä»¶å·²åœ¨ DOMContentLoaded å›è°ƒä¸­ç»‘å®š
</script>
</body>
</html>
