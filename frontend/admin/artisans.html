<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ä¼ æ‰¿äººç®¡ç† - æ——è¢DAOç®¡ç†åå°</title>
  <link rel="stylesheet" href="/styles/app.css"/>
  <link rel="stylesheet" href="common/admin-common.css"/>
  <script src="/poap.config.js"></script>
  <script src="common/admin-common.js"></script>
  <script src="common/admin-auth.js"></script>
</head>
<body>
<div class="wrap">
  <!-- å¯¼èˆªæ  -->
  <nav class="admin-nav">
    <div class="nav-brand">ä¼ æ‰¿äººç®¡ç†</div>
    <button class="hamburger">â˜°</button>
    <div class="nav-user">
      <span id="authState" class="pill">æœªç™»å½•</span>
      <button onclick="logout()" class="btn btn-sm btn-outline" style="margin-left: 12px;" title="é€€å‡ºç™»å½•">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </nav>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ  -->
  <div class="sidebar-overlay"></div>
  <div class="sidebar">
    <div class="sidebar-header">
      <div>å¯¼èˆªèœå•</div>
      <button class="sidebar-close">Ã—</button>
    </div>
    <nav class="sidebar-nav">
      <a href="/admin/index.html" class="nav-item">
        <i>ğŸ“Š</i> ä»ªè¡¨æ¿
      </a>
      <a href="/admin/events.html" class="nav-item">
        <i>ğŸª</i> æ´»åŠ¨ç®¡ç†
      </a>
      <a href="/admin/artisans.html" class="nav-item">
        <i>ğŸ‘¨â€ğŸ¨</i> ä¼ æ‰¿äººç®¡ç†
      </a>
      <a href="/admin/products.html" class="nav-item">
        <i>ğŸ›ï¸</i> å•†å“ç®¡ç†
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i>ğŸ“¦</i> è®¢å•ç®¡ç†
      </a>
      <a href="javascript:logout()" class="nav-item">
        <i>ğŸšª</i> é€€å‡ºç™»å½•
      </a>
    </nav>
  </div>

  <!-- ä¼ æ‰¿äººåˆ›å»º/ç¼–è¾‘è¡¨å• -->
  <div class="card">
    <h2 class="card-title">ä¼ æ‰¿äººä¿¡æ¯</h2>
    
    <form id="artisanForm">
      <input type="hidden" id="artisan_id" name="id" />
      
      <div class="field">
        <label>ä¼ æ‰¿äººIDï¼ˆç¼–è¾‘æ—¶è‡ªåŠ¨å¡«å…¥ï¼‰</label>
        <input id="artisan_id_display" placeholder="æ–°å»ºæ—¶ç•™ç©º" readonly/>
      </div>
      
      <div class="field">
        <label>é’±åŒ…åœ°å€ *</label>
        <input id="artisan_wallet" name="wallet" placeholder="0x... ç”¨äºæ”¶ç›Šåˆ†é…" required/>
      </div>
      
      <div class="field">
        <label>å§“åï¼ˆä¸­æ–‡ï¼‰*</label>
        <input id="artisan_name_zh" name="name_zh" placeholder="ä¼ æ‰¿äººä¸­æ–‡å§“å" required/>
      </div>
      
      <div class="field">
        <label>å§“åï¼ˆè‹±æ–‡ï¼‰</label>
        <input id="artisan_name_en" name="name_en" placeholder="Name (English / å¯é€‰)"/>
      </div>
      
      <div class="field">
        <label>äº§åœ° / é—¨æ´¾ / åŒºåŸŸ</label>
        <input id="artisan_region" name="region" placeholder="å¦‚ï¼šè‹å·ã€è‹ç»£ã€æ±Ÿå—"/>
      </div>
      
      <div class="field">
        <label>åŒ äººä»‹ç»</label>
        <textarea id="artisan_bio" name="bio" rows="3" placeholder="æ“…é•¿å·¥è‰º / ä¼ æ‰¿èƒŒæ™¯ / ä¸ªäººç®€ä»‹"></textarea>
      </div>
      
      <div class="field">
        <label class="flex items-center gap-2">
          <input id="artisan_verified" name="verified" type="checkbox" class="w-4 h-4"/>
          <span>å·²è®¤è¯ä¼ æ‰¿äººï¼ˆä¼šæ˜¾ç¤ºåœ¨å•†å“é¡µï¼‰</span>
        </label>
      </div>
      
      <div class="row">
        <button type="button" id="btnSaveArtisan" class="btn btn-primary btn-block">
          ä¿å­˜ / æ›´æ–° ä¼ æ‰¿äºº
        </button>
        <button type="button" id="btnClearForm" class="btn btn-secondary btn-block">
          æ¸…ç©ºè¡¨å•
        </button>
      </div>
    </form>
  </div>

  <!-- ä¼ æ‰¿äººåˆ—è¡¨ -->
  <div class="card">
    <h2 class="card-title">ä¼ æ‰¿äººåˆ—è¡¨</h2>
    
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>å½“å‰ä¼ æ‰¿äºº</div>
      <button id="btnRefreshArtisans" class="btn btn-sm btn-secondary">
        åˆ·æ–°
      </button>
    </div>
    
    <div id="artisan_list" class="list" style="margin-top: 12px;">
      <div class="list-item text-center">
        <div class="loading"></div>
      </div>
    </div>
  </div>

</div>

<script>
// ä¼ æ‰¿äººç®¡ç†ç‰¹å®šåŠŸèƒ½

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  loadArtisans();
});

// ä¿å­˜/æ›´æ–°ä¼ æ‰¿äºº
$('#btnSaveArtisan').addEventListener('click', async () => {
  if (!ensureAuth()) return;
  
  const formData = getFormData('artisanForm');
  const errors = validateForm(formData, ['wallet', 'name_zh']);
  
  if (errors.length > 0) {
    toast(errors.join(', '), 'error');
    return;
  }
  
  const btn = $('#btnSaveArtisan');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const payload = {
      id: formData.id || undefined,
      wallet: formData.wallet.trim(),
      name_zh: formData.name_zh.trim(),
      name_en: formData.name_en.trim(),
      region: formData.region.trim(),
      bio: formData.bio.trim(),
      verified: formData.verified ? 1 : 0
    };
    
    const result = await apiJSONmulti(['/admin/artisan-upsert'], {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    if (result.ok) {
      toast('å·²ä¿å­˜ä¼ æ‰¿äºº / ID: ' + result.id);
      clearArtisanForm();
      loadArtisans();
    } else {
      toast('ä¿å­˜å¤±è´¥: ' + (result.error || 'unknown'), 'error');
    }
    
  } catch (error) {
    console.error('ä¿å­˜ä¼ æ‰¿äººå¤±è´¥:', error);
    toast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
});

// æ¸…ç©ºè¡¨å•
$('#btnClearForm').addEventListener('click', clearArtisanForm);

// åˆ·æ–°ä¼ æ‰¿äººåˆ—è¡¨
$('#btnRefreshArtisans').addEventListener('click', loadArtisans);

// åŠ è½½ä¼ æ‰¿äººåˆ—è¡¨
async function loadArtisans() {
  if (!ensureAuth()) return;
  
  try {
    const result = await apiJSONmulti(['/admin/artisans']);
    displayArtisans(result.artisans || []);
  } catch (error) {
    console.error('åŠ è½½ä¼ æ‰¿äººåˆ—è¡¨å¤±è´¥:', error);
    $('#artisan_list').innerHTML = '<div class="list-item text-center">åŠ è½½å¤±è´¥</div>';
  }
}

// æ˜¾ç¤ºä¼ æ‰¿äººåˆ—è¡¨
function displayArtisans(artisans) {
  const container = $('#artisan_list');
  
  if (!artisans || artisans.length === 0) {
    container.innerHTML = '<div class="list-item text-center">æš‚æ— ä¼ æ‰¿äºº</div>';
    return;
  }
  
  container.innerHTML = artisans.map(artisan => {
    const verifiedBadge = artisan.verified ? 
      '<span class="pill pill-ok" style="font-size: 10px;">è®¤è¯</span>' : '';
    
    return `
      <div class="list-item">
        <div style="flex: 1;">
          <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
            ${artisan.name_zh || "(æœªå‘½å)"}
            ${verifiedBadge}
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            ${artisan.wallet ? artisan.wallet.slice(0, 6) + '...' + artisan.wallet.slice(-4) : 'æœªçŸ¥é’±åŒ…'}
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
            åœ°åŒº: ${artisan.region || "æœªè®¾ç½®"} | ID: ${artisan.id}
          </div>
        </div>
        <div>
          <button onclick="editArtisan('${artisan.id}')" class="btn btn-sm btn-secondary">
            ç¼–è¾‘
          </button>
        </div>
      </div>
    `;
  }).join('');
}

// ç¼–è¾‘ä¼ æ‰¿äºº
async function editArtisan(artisanId) {
  if (!ensureAuth()) return;
  
  try {
    // ä»æœåŠ¡å™¨åŠ è½½ä¼ æ‰¿äººåˆ—è¡¨
    const result = await apiJSONmulti(['/admin/artisans']);
    
    if (result.artisans && result.artisans.length > 0) {
      // æ‰¾åˆ°å¯¹åº”çš„ä¼ æ‰¿äºº
      const artisan = result.artisans.find(a => a.id === artisanId);
      
      if (artisan) {
        // å¡«å……è¡¨å•
        fillArtisanForm(artisan);
        
        // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
        const form = document.getElementById('artisanForm');
        if (form) {
          form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        toast('å·²åŠ è½½ä¼ æ‰¿äººä¿¡æ¯ï¼Œå¯ä»¥ç¼–è¾‘');
      } else {
        toast('æœªæ‰¾åˆ°è¯¥ä¼ æ‰¿äºº', 'error');
      }
    } else {
      toast('åŠ è½½ä¼ æ‰¿äººæ•°æ®å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('åŠ è½½ä¼ æ‰¿äººå¤±è´¥:', error);
    toast('åŠ è½½å¤±è´¥: ' + error.message, 'error');
  }
}

// æ¸…ç©ºä¼ æ‰¿äººè¡¨å•
function clearArtisanForm() {
  clearForm('artisanForm');
  $('#artisan_id').value = '';
  $('#artisan_id_display').value = '';
}

// å¡«å……ä¼ æ‰¿äººè¡¨å•
function fillArtisanForm(artisan) {
  $('#artisan_id').value = artisan.id || '';
  $('#artisan_id_display').value = artisan.id || '';
  $('#artisan_wallet').value = artisan.wallet || '';
  $('#artisan_name_zh').value = artisan.name_zh || '';
  $('#artisan_name_en').value = artisan.name_en || '';
  $('#artisan_region').value = artisan.region || '';
  $('#artisan_bio').value = artisan.bio || '';
  $('#artisan_verified').checked = !!artisan.verified;
}

// å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
window.editArtisan = editArtisan;
window.fillArtisanForm = fillArtisanForm;
window.clearArtisanForm = clearArtisanForm;
</script>
</body>
</html>
