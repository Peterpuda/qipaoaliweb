<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å†…å®¹å®¡æ ¸ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./common/admin-common.css">
</head>
<body class="bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="./index.html" class="text-gray-500 hover:text-gray-700">â† è¿”å›æ§åˆ¶å°</a>
                    <span class="ml-4 text-gray-300">|</span>
                    <h1 class="ml-4 text-lg font-semibold">ğŸ›¡ï¸ AI å†…å®¹å®¡æ ¸ç®¡ç†</h1>
                </div>
                <div class="flex items-center">
                    <span id="adminAddr" class="text-sm text-gray-600"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">å¾…å®¡æ ¸</p>
                        <p id="pendingCount" class="text-3xl font-bold text-red-600">0</p>
                    </div>
                    <div class="text-4xl">âš ï¸</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">ä»Šæ—¥å®¡æ ¸</p>
                        <p id="todayCount" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="text-4xl">ğŸ“</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">é€šè¿‡ç‡</p>
                        <p id="approvalRate" class="text-3xl font-bold text-green-600">0%</p>
                    </div>
                    <div class="text-4xl">âœ…</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">æ€»å¯¹è¯æ•°</p>
                        <p id="totalCount" class="text-3xl font-bold text-gray-600">0</p>
                    </div>
                    <div class="text-4xl">ğŸ’¬</div>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰ä¸æ‰¹é‡æ“ä½œ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="radio" name="viewMode" value="pending" checked onchange="switchMode()">
                        <span>å¾…å®¡æ ¸ (<span id="pendingBadge">0</span>)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="radio" name="viewMode" value="reviewed" onchange="switchMode()">
                        <span>å·²å®¡æ ¸ (<span id="reviewedBadge">0</span>)</span>
                    </label>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="selectAll()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                        å…¨é€‰
                    </button>
                    <button onclick="batchApprove()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm" id="btnBatchApprove">
                        âœ… æ‰¹é‡é€šè¿‡
                    </button>
                    <button onclick="batchDelete()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm" id="btnBatchDelete">
                        ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤
                    </button>
                    <button onclick="refreshList()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- å¯¹è¯åˆ—è¡¨ -->
        <div id="chatsList" class="space-y-4">
            <!-- å¯¹è¯å¡ç‰‡å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="hidden bg-white rounded-lg shadow p-12 text-center">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 class="text-xl font-semibold mb-2">å¤ªæ£’äº†ï¼</h3>
            <p class="text-gray-600">æš‚æ— å¾…å®¡æ ¸å†…å®¹</p>
        </div>

        <!-- åˆ†é¡µ -->
        <div id="pagination" class="mt-6 flex justify-center gap-2">
            <!-- åˆ†é¡µæŒ‰é’®å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-8 flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-lg font-semibold">å¤„ç†ä¸­...</p>
        </div>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold">å¯¹è¯è¯¦æƒ…</h3>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]" id="detailContent">
                <!-- è¯¦æƒ…å†…å®¹ -->
            </div>
            <div class="p-6 border-t flex justify-end gap-4">
                <button onclick="closeDetailModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script src="./common/admin-common.js"></script>
    <script>
        const ADMIN_CONFIG = {
            API_BASE: 'https://songbrocade-api.petterbrand03.workers.dev'
        };

        let currentMode = 'pending';
        let selectedChats = new Set();
        let allChats = [];

        // é¡µé¢åŠ è½½æ—¶
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadStats();
            await loadChatsList();
        });

        async function checkAuth() {
            try {
                const response = await fetch(`${ADMIN_CONFIG.API_BASE}/admin/whoami`, {
                    headers: authHeaders()
                });
                const data = await response.json();
                if (data.ok) {
                    document.getElementById('adminAddr').textContent = `ç®¡ç†å‘˜: ${data.addr}`;
                } else {
                    alert('è¯·å…ˆç™»å½•');
                    window.location.href = './index.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                alert('è®¤è¯å¤±è´¥');
                window.location.href = './index.html';
            }
        }

        async function loadStats() {
            try {
                // åŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥æœ‰ä¸“é—¨çš„ç»Ÿè®¡æ¥å£ï¼‰
                const pendingRes = await fetch(
                    `${ADMIN_CONFIG.API_BASE}/admin/moderation/flagged-chats?reviewed=false`,
                    { headers: authHeaders() }
                );
                const pendingData = await pendingRes.json();
                
                const reviewedRes = await fetch(
                    `${ADMIN_CONFIG.API_BASE}/admin/moderation/flagged-chats?reviewed=true`,
                    { headers: authHeaders() }
                );
                const reviewedData = await reviewedRes.json();

                const pendingCount = pendingData.ok ? pendingData.total : 0;
                const reviewedCount = reviewedData.ok ? reviewedData.total : 0;
                const totalCount = pendingCount + reviewedCount;

                document.getElementById('pendingCount').textContent = pendingCount;
                document.getElementById('todayCount').textContent = reviewedCount;
                document.getElementById('totalCount').textContent = totalCount;
                document.getElementById('approvalRate').textContent = 
                    totalCount > 0 ? Math.round((reviewedCount / totalCount) * 100) + '%' : '0%';
                
                document.getElementById('pendingBadge').textContent = pendingCount;
                document.getElementById('reviewedBadge').textContent = reviewedCount;

            } catch (error) {
                console.error('Load stats failed:', error);
            }
        }

        async function loadChatsList() {
            showLoading(true);
            selectedChats.clear();

            try {
                const reviewed = currentMode === 'reviewed';
                const response = await fetch(
                    `${ADMIN_CONFIG.API_BASE}/admin/moderation/flagged-chats?reviewed=${reviewed}`,
                    { headers: authHeaders() }
                );
                const data = await response.json();
                
                if (data.ok) {
                    allChats = data.chats || [];
                    displayChatsList(allChats);
                } else {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }

            } catch (error) {
                console.error('Load chats failed:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayChatsList(chats) {
            const container = document.getElementById('chatsList');
            const emptyState = document.getElementById('emptyState');
            
            if (chats.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            chats.forEach(chat => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-6';
                
                const flagColors = {
                    sensitive: 'bg-red-100 text-red-700',
                    spam: 'bg-yellow-100 text-yellow-700',
                    inappropriate: 'bg-orange-100 text-orange-700'
                };
                
                const flagColor = flagColors[chat.flag_type] || 'bg-gray-100 text-gray-700';
                const timestamp = new Date(chat.created_at * 1000).toLocaleString('zh-CN');

                card.innerHTML = `
                    <div class="flex items-start gap-4">
                        <input type="checkbox" 
                               class="chat-checkbox mt-1 w-5 h-5" 
                               data-chat-id="${chat.id}"
                               onchange="toggleSelection('${chat.id}')">
                        
                        <div class="flex-1">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-semibold">${chat.artisan_name || 'æœªçŸ¥åŒ äºº'}</span>
                                        <span class="px-2 py-1 rounded text-xs ${flagColor}">
                                            ${chat.flag_type || 'flagged'}
                                        </span>
                                        ${chat.reviewed ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">å·²å®¡æ ¸</span>' : ''}
                                    </div>
                                    <p class="text-sm text-gray-500">${timestamp}</p>
                                </div>
                                <button onclick="showDetail('${chat.id}')" class="text-blue-600 hover:text-blue-700 text-sm">
                                    æŸ¥çœ‹è¯¦æƒ… â†’
                                </button>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-500 mb-1">ç”¨æˆ·é—®é¢˜ï¼š</p>
                                    <p class="text-gray-700">${escapeHtml(chat.question)}</p>
                                </div>
                                
                                <div class="bg-blue-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-500 mb-1">AI å›ç­”ï¼š</p>
                                    <p class="text-gray-700">${escapeHtml(chat.answer)}</p>
                                </div>
                                
                                ${chat.flag_reason ? `
                                    <div class="bg-red-50 rounded-lg p-3">
                                        <p class="text-xs text-red-500 mb-1">æ ‡è®°åŸå› ï¼š</p>
                                        <p class="text-red-700">${escapeHtml(chat.flag_reason)}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${!chat.reviewed ? `
                                <div class="flex gap-2 mt-4">
                                    <button onclick="approveSingle('${chat.id}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                                        âœ… é€šè¿‡
                                    </button>
                                    <button onclick="deleteSingle('${chat.id}')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function toggleSelection(chatId) {
            if (selectedChats.has(chatId)) {
                selectedChats.delete(chatId);
            } else {
                selectedChats.add(chatId);
            }
            updateBatchButtons();
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('.chat-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                const chatId = cb.dataset.chatId;
                if (!allChecked) {
                    selectedChats.add(chatId);
                } else {
                    selectedChats.delete(chatId);
                }
            });
            updateBatchButtons();
        }

        function updateBatchButtons() {
            const hasSelection = selectedChats.size > 0;
            document.getElementById('btnBatchApprove').disabled = !hasSelection;
            document.getElementById('btnBatchDelete').disabled = !hasSelection;
        }

        async function approveSingle(chatId) {
            if (!confirm('ç¡®å®šè¦é€šè¿‡è¿™æ¡å¯¹è¯å—ï¼Ÿ')) return;

            showLoading(true);

            try {
                const response = await fetch(`${ADMIN_CONFIG.API_BASE}/admin/moderation/review-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders()
                    },
                    body: JSON.stringify({
                        log_id: chatId,
                        action: 'approve'
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    await loadStats();
                    await loadChatsList();
                } else {
                    throw new Error(data.error || 'æ“ä½œå¤±è´¥');
                }

            } catch (error) {
                console.error('Approve failed:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteSingle(chatId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;

            showLoading(true);

            try {
                const response = await fetch(`${ADMIN_CONFIG.API_BASE}/admin/moderation/review-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders()
                    },
                    body: JSON.stringify({
                        log_id: chatId,
                        action: 'delete'
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    await loadStats();
                    await loadChatsList();
                } else {
                    throw new Error(data.error || 'æ“ä½œå¤±è´¥');
                }

            } catch (error) {
                console.error('Delete failed:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function batchApprove() {
            if (selectedChats.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„å¯¹è¯');
                return;
            }

            if (!confirm(`ç¡®å®šè¦é€šè¿‡é€‰ä¸­çš„ ${selectedChats.size} æ¡å¯¹è¯å—ï¼Ÿ`)) return;

            showLoading(true);

            try {
                const response = await fetch(`${ADMIN_CONFIG.API_BASE}/admin/moderation/batch-review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders()
                    },
                    body: JSON.stringify({
                        log_ids: Array.from(selectedChats),
                        action: 'approve'
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    alert(`âœ… æˆåŠŸå¤„ç† ${data.processed} æ¡å¯¹è¯`);
                    await loadStats();
                    await loadChatsList();
                } else {
                    throw new Error(data.error || 'æ“ä½œå¤±è´¥');
                }

            } catch (error) {
                console.error('Batch approve failed:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function batchDelete() {
            if (selectedChats.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„å¯¹è¯');
                return;
            }

            if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedChats.size} æ¡å¯¹è¯å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) return;

            showLoading(true);

            try {
                const response = await fetch(`${ADMIN_CONFIG.API_BASE}/admin/moderation/batch-review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders()
                    },
                    body: JSON.stringify({
                        log_ids: Array.from(selectedChats),
                        action: 'delete'
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    alert(`âœ… æˆåŠŸåˆ é™¤ ${data.processed} æ¡å¯¹è¯`);
                    await loadStats();
                    await loadChatsList();
                } else {
                    throw new Error(data.error || 'æ“ä½œå¤±è´¥');
                }

            } catch (error) {
                console.error('Batch delete failed:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function switchMode() {
            const mode = document.querySelector('input[name="viewMode"]:checked').value;
            currentMode = mode;
            loadChatsList();
        }

        function refreshList() {
            loadStats();
            loadChatsList();
        }

        function showDetail(chatId) {
            const chat = allChats.find(c => c.id === chatId);
            if (!chat) return;

            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');
            
            const timestamp = new Date(chat.created_at * 1000).toLocaleString('zh-CN');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold mb-2">åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">åŒ äººï¼š</span>
                                <span>${chat.artisan_name || 'æœªçŸ¥'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">æ—¶é—´ï¼š</span>
                                <span>${timestamp}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">è¯­è¨€ï¼š</span>
                                <span>${chat.lang}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">æ¨¡å‹ï¼š</span>
                                <span>${chat.model_used || 'N/A'}</span>
                            </div>
                            ${chat.tokens_used ? `
                            <div>
                                <span class="text-gray-500">Token æ¶ˆè€—ï¼š</span>
                                <span>${chat.tokens_used}</span>
                            </div>
                            ` : ''}
                            ${chat.response_time_ms ? `
                            <div>
                                <span class="text-gray-500">å“åº”æ—¶é—´ï¼š</span>
                                <span>${chat.response_time_ms}ms</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold mb-2">å¯¹è¯å†…å®¹</h4>
                        <div class="bg-gray-50 rounded-lg p-4 mb-3">
                            <p class="text-xs text-gray-500 mb-2">ç”¨æˆ·é—®é¢˜ï¼š</p>
                            <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(chat.question)}</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-xs text-gray-500 mb-2">AI å›ç­”ï¼š</p>
                            <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(chat.answer)}</p>
                        </div>
                    </div>
                    
                    ${chat.flag_reason ? `
                    <div>
                        <h4 class="font-semibold mb-2">æ ‡è®°ä¿¡æ¯</h4>
                        <div class="bg-red-50 rounded-lg p-4">
                            <p class="text-xs text-red-500 mb-2">æ ‡è®°åŸå› ï¼š</p>
                            <p class="text-red-700">${escapeHtml(chat.flag_reason)}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${chat.user_feedback ? `
                    <div>
                        <h4 class="font-semibold mb-2">ç”¨æˆ·åé¦ˆ</h4>
                        <p class="text-sm text-gray-700">${chat.user_feedback}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function authHeaders() {
            const token = sessionStorage.getItem('qipao.admin.token') || 
                         localStorage.getItem('qipao.admin.token') || 
                         localStorage.getItem('bearer_token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>

