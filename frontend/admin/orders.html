<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>è®¢å•ç®¡ç† - æ——è¢DAOç®¡ç†åå°</title>
  <link rel="stylesheet" href="/styles/app.css"/>
  <link rel="stylesheet" href="common/admin-common.css"/>
  <script src="/poap.config.js"></script>
</head>
<body>
<div class="wrap">
  <!-- å¯¼èˆªæ  -->
  <nav class="admin-nav">
    <div class="nav-brand">è®¢å•ç®¡ç†</div>
    <button class="hamburger">â˜°</button>
    <div class="nav-user">
      <span id="authState" class="pill">æœªç™»å½•</span>
    </div>
  </nav>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ  -->
  <div class="sidebar-overlay"></div>
  <div class="sidebar">
    <div class="sidebar-header">
      <div>å¯¼èˆªèœå•</div>
      <button class="sidebar-close">Ã—</button>
    </div>
    <nav class="sidebar-nav">
      <a href="/admin/index.html" class="nav-item">
        <i>ğŸ“Š</i> ä»ªè¡¨æ¿
      </a>
      <a href="/admin/events.html" class="nav-item">
        <i>ğŸª</i> æ´»åŠ¨ç®¡ç†
      </a>
      <a href="/admin/artisans.html" class="nav-item">
        <i>ğŸ‘¨â€ğŸ¨</i> ä¼ æ‰¿äººç®¡ç†
      </a>
      <a href="/admin/products.html" class="nav-item">
        <i>ğŸ›ï¸</i> å•†å“ç®¡ç†
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i>ğŸ“¦</i> è®¢å•ç®¡ç†
      </a>
      <a href="javascript:logout()" class="nav-item">
        <i>ğŸšª</i> é€€å‡ºç™»å½•
      </a>
    </nav>
  </div>

  <!-- è®¢å•çŠ¶æ€æ›´æ–° -->
  <div class="card">
    <h2 class="card-title">è®¢å•çŠ¶æ€æ›´æ–°</h2>
    
    <form id="orderUpdateForm">
      <div class="field">
        <label>è®¢å•ID *</label>
        <input id="order_update_id" name="order_id" placeholder="è¾“å…¥è®¢å•ID" required/>
      </div>
      
      <div class="field">
        <label>æ–°çŠ¶æ€ *</label>
        <select id="order_update_status" name="status" required>
          <option value="">è¯·é€‰æ‹©çŠ¶æ€</option>
          <option value="pending">å¾…ä»˜æ¬¾</option>
          <option value="paid">å·²ä»˜æ¬¾</option>
          <option value="shipped">å·²å‘è´§</option>
          <option value="delivered">å·²é€è¾¾</option>
          <option value="cancelled">å·²å–æ¶ˆ</option>
        </select>
      </div>
      
      <div class="field">
        <label>äº¤æ˜“å“ˆå¸Œï¼ˆå¯é€‰ï¼‰</label>
        <input id="order_update_txhash" name="tx_hash" placeholder="0x... ç”¨äºè®°å½•é“¾ä¸Šäº¤æ˜“"/>
      </div>
      
      <div class="row">
        <button type="button" id="btnUpdateOrder" class="btn btn-primary btn-block">
          æ›´æ–°è®¢å•çŠ¶æ€
        </button>
        <button type="button" id="btnClearOrderForm" class="btn btn-secondary btn-block">
          æ¸…ç©ºè¡¨å•
        </button>
      </div>
    </form>
  </div>

  <!-- è®¢å•åˆ—è¡¨ -->
  <div class="card">
    <h2 class="card-title">è®¢å•åˆ—è¡¨</h2>
    
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>å½“å‰è®¢å•</div>
      <button id="btnRefreshOrders" class="btn btn-sm btn-secondary">
        åˆ·æ–°
      </button>
    </div>
    
    <div id="order_list" class="list" style="margin-top: 12px;">
      <div class="list-item text-center">
        <div class="loading"></div>
      </div>
    </div>
  </div>

</div>

<script src="common/admin-common.js"></script>
<script>
// è®¢å•ç®¡ç†ç‰¹å®šåŠŸèƒ½

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  loadOrdersAdmin();
});

// æ›´æ–°è®¢å•çŠ¶æ€
$('#btnUpdateOrder').addEventListener('click', async () => {
  if (!ensureAuth()) return;
  
  const formData = getFormData('orderUpdateForm');
  const errors = validateForm(formData, ['order_id', 'status']);
  
  if (errors.length > 0) {
    toast(errors.join(', '), 'error');
    return;
  }
  
  const btn = $('#btnUpdateOrder');
  const originalText = btn.textContent;
  showLoading(btn);
  
  try {
    const payload = {
      order_id: formData.order_id.trim(),
      status: formData.status,
      tx_hash: formData.tx_hash.trim() || undefined
    };
    
    const result = await apiJSONmulti(['/admin/order-update'], {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    if (result.ok) {
      toast('è®¢å•çŠ¶æ€å·²æ›´æ–°');
      clearOrderForm();
      loadOrdersAdmin();
    } else {
      toast('æ›´æ–°å¤±è´¥: ' + (result.error || 'unknown'), 'error');
    }
    
  } catch (error) {
    console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
    toast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
  } finally {
    hideLoading(btn, originalText);
  }
});

// æ¸…ç©ºè®¢å•è¡¨å•
$('#btnClearOrderForm').addEventListener('click', clearOrderForm);

// åˆ·æ–°è®¢å•åˆ—è¡¨
$('#btnRefreshOrders').addEventListener('click', loadOrdersAdmin);

// åŠ è½½è®¢å•åˆ—è¡¨ï¼ˆç®¡ç†å‘˜è§†å›¾ï¼‰
async function loadOrdersAdmin() {
  if (!ensureAuth()) return;
  
  try {
    const result = await apiJSONmulti(['/orders']);
    displayOrders(result.orders || []);
  } catch (error) {
    console.error('åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥:', error);
    $('#order_list').innerHTML = '<div class="list-item text-center">åŠ è½½å¤±è´¥</div>';
  }
}

// æ˜¾ç¤ºè®¢å•åˆ—è¡¨
function displayOrders(orders) {
  const container = $('#order_list');
  
  if (!orders || orders.length === 0) {
    container.innerHTML = '<div class="list-item text-center">æš‚æ— è®¢å•</div>';
    return;
  }
  
  container.innerHTML = orders.map(order => {
    const statusClass = getStatusClass(order.status);
    const statusText = getStatusText(order.status);
    const priceText = `${order.price_native} ${order.price_currency}`;
    const pointsText = order.price_points ? ` / ${order.price_points} ç§¯åˆ†` : '';
    
    return `
      <div class="list-item">
        <div style="flex: 1;">
          <div style="font-weight: 600;">è®¢å• #${order.id}</div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            ${order.buyer_wallet ? order.buyer_wallet.slice(0, 6) + '...' + order.buyer_wallet.slice(-4) : 'æœªçŸ¥ä¹°å®¶'}
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
            ${priceText}${pointsText} | å•†å“: ${order.product_title_zh || order.product_slug || 'æœªçŸ¥å•†å“'}
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
            åˆ›å»ºæ—¶é—´: ${order.created_at ? formatDate(order.created_at) : 'æœªçŸ¥'}
          </div>
        </div>
        <div style="text-align: right;">
          <div class="pill ${statusClass} mb-1">${statusText}</div>
          <button onclick="prefillOrderStatus('${order.id}', '${order.status}')" class="btn btn-sm btn-secondary">
            ç¼–è¾‘
          </button>
        </div>
      </div>
    `;
  }).join('');
}

// è·å–çŠ¶æ€æ ·å¼ç±»
function getStatusClass(status) {
  switch (status) {
    case 'pending': return 'pill-warning';
    case 'paid': return 'pill-ok';
    case 'shipped': return 'pill-ok';
    case 'delivered': return 'pill-ok';
    case 'cancelled': return 'pill-error';
    default: return 'pill';
  }
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
  switch (status) {
    case 'pending': return 'å¾…ä»˜æ¬¾';
    case 'paid': return 'å·²ä»˜æ¬¾';
    case 'shipped': return 'å·²å‘è´§';
    case 'delivered': return 'å·²é€è¾¾';
    case 'cancelled': return 'å·²å–æ¶ˆ';
    default: return status;
  }
}

// é¢„å¡«å……è®¢å•çŠ¶æ€è¡¨å•
function prefillOrderStatus(orderId, currentStatus) {
  $('#order_update_id').value = orderId;
  $('#order_update_status').value = currentStatus;
  $('#order_update_txhash').value = '';
  
  // æ»šåŠ¨åˆ°è¡¨å•
  document.querySelector('#orderUpdateForm').scrollIntoView({ behavior: 'smooth' });
}

// æ¸…ç©ºè®¢å•è¡¨å•
function clearOrderForm() {
  clearForm('orderUpdateForm');
}

// å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
window.prefillOrderStatus = prefillOrderStatus;
window.clearOrderForm = clearOrderForm;
</script>
</body>
</html>
