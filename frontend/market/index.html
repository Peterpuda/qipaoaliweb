<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
  />
  <title>非遗文化商城｜限量手作 · 真实传承</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #f9f6f0 0%, #fefdfb 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "PingFang SC",
        "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
    }
    
    /* 顶部导航栏 */
    .top-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(213, 189, 175, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    /* 容器 */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }
    
    /* 主布局 */
    .main-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 32px;
      padding: 32px 0;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* 侧边栏 */
    .sidebar {
      position: sticky;
      top: 100px;
      height: fit-content;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    }
    
    .sidebar-section {
      margin-bottom: 24px;
    }
    
    .sidebar-section:last-child {
      margin-bottom: 0;
    }
    
    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: #4A403A;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* 筛选按钮 */
    .filter-btn {
      display: block;
      width: 100%;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid #E5E7EB;
      background: white;
      color: #4A403A;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      margin-bottom: 8px;
    }
    
    .filter-btn:hover {
      background: #F9F6F0;
      border-color: #D5BDAF;
    }
    
    .filter-btn.active {
      background: #9E2A2B;
      color: white;
      border-color: #9E2A2B;
    }
    
    .filter-btn i {
      margin-right: 8px;
      width: 16px;
      text-align: center;
    }
    
    /* 下拉选择器 */
    select.filter-select {
      width: 100%;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid #E5E7EB;
      background: white;
      color: #4A403A;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    select.filter-select:hover {
      border-color: #D5BDAF;
    }
    
    select.filter-select:focus {
      outline: none;
      border-color: #9E2A2B;
      box-shadow: 0 0 0 3px rgba(158, 42, 43, 0.1);
    }
    
    /* 商品网格 */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
    }
    
    /* 商品卡片 */
    .product-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }
    
    .product-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 32px rgba(158, 42, 43, 0.15);
    }
    
    .product-image {
      width: 100%;
      height: 280px;
      object-fit: cover;
      background: #F9F6F0;
    }
    
    .product-content {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .product-title {
      font-size: 16px;
      font-weight: 600;
      color: #2D2A26;
      margin-bottom: 8px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .product-price {
      font-size: 24px;
      font-weight: 700;
      color: #9E2A2B;
      margin-bottom: 12px;
    }
    
    .product-price-currency {
      font-size: 14px;
      font-weight: 500;
      margin-left: 4px;
    }
    
    .product-meta {
      font-size: 13px;
      color: #6B7280;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .product-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-certified {
      background: #ECFDF5;
      color: #059669;
    }
    
    .badge-artisan {
      background: #EFF6FF;
      color: #2563EB;
    }
    
    .badge-region {
      background: #F3E8FF;
      color: #7C3AED;
    }
    
    .product-actions {
      display: flex;
      gap: 12px;
      margin-top: auto;
    }
    
    .btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-align: center;
    }
    
    .btn-primary {
      background: #9E2A2B;
      color: white;
    }
    
    .btn-primary:hover {
      background: #7a1b1c;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(158, 42, 43, 0.3);
    }
    
    .btn-secondary {
      background: white;
      color: #9E2A2B;
      border: 2px solid #9E2A2B;
    }
    
    .btn-secondary:hover {
      background: #9E2A2B;
      color: white;
    }
    
    /* 搜索框 */
    .search-box {
      position: relative;
      margin-bottom: 24px;
    }
    
    .search-input {
      width: 100%;
      padding: 14px 48px 14px 48px;
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #9E2A2B;
      box-shadow: 0 0 0 4px rgba(158, 42, 43, 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #9CA3AF;
      font-size: 18px;
    }
    
    /* 统计信息 */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: white;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .stats-text {
      font-size: 14px;
      color: #6B7280;
    }
    
    .stats-count {
      font-weight: 600;
      color: #9E2A2B;
    }
    
    /* 响应式设计 */
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: static;
        margin-bottom: 24px;
      }
      
      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 0 16px;
      }
      
      .main-layout {
        padding: 16px 0;
        gap: 16px;
      }
      
      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
      }
      
      .product-image {
        height: 200px;
      }
      
      .product-content {
        padding: 12px;
      }
      
      .product-title {
        font-size: 14px;
      }
      
      .product-price {
        font-size: 18px;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <!-- 顶部导航栏 -->
  <header class="top-nav">
    <div class="container" style="padding: 16px 24px;">
      <div class="flex items-center justify-between">
        <!-- Logo 和标题 -->
        <a href="../index.html" class="flex items-center gap-3 hover:opacity-80 transition">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#9E2A2B] to-[#7a1b1c] flex items-center justify-center text-white shadow-lg">
            <i class="fas fa-chess-rook text-lg"></i>
          </div>
          <div>
            <div class="text-[#9E2A2B] font-bold text-lg">
              非遗文化商城
            </div>
            <div class="text-xs text-[#4A403A]/60">
              每一件商品都绑定链上真品凭证
            </div>
          </div>
        </a>

        <!-- 右侧操作 -->
        <div class="flex items-center gap-4">
          <button id="connectBtn"
            class="px-6 py-2.5 rounded-lg border-2 border-[#9E2A2B] text-[#9E2A2B] font-semibold hover:bg-[#9E2A2B] hover:text-white transition-all duration-200">
            <i class="fas fa-wallet mr-2"></i>
            连接钱包
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- 主内容区域 -->
  <div class="container main-layout">
    <!-- 左侧筛选栏 -->
    <aside class="sidebar">
      <!-- 搜索 -->
      <div class="sidebar-section">
        <div class="sidebar-title">
          <i class="fas fa-search"></i>
          搜索商品
        </div>
        <div class="search-box">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="searchInput" placeholder="搜索商品、匠人..." 
                 class="search-input">
        </div>
      </div>

      <!-- 商品分类 -->
      <div class="sidebar-section">
        <div class="sidebar-title">
          <i class="fas fa-th-large"></i>
          商品分类
        </div>
        <button class="filter-btn active" data-filter="all">
          <i class="fas fa-border-all"></i>
          全部商品
        </button>
        <button class="filter-btn" data-filter="qipao">
          <i class="fas fa-tshirt"></i>
          旗袍服饰
        </button>
        <button class="filter-btn" data-filter="ceramics">
          <i class="fas fa-mug-hot"></i>
          陶瓷艺术
        </button>
        <button class="filter-btn" data-filter="silk">
          <i class="fas fa-scroll"></i>
          丝绸制品
        </button>
      </div>

      <!-- 认证筛选 -->
      <div class="sidebar-section">
        <div class="sidebar-title">
          <i class="fas fa-certificate"></i>
          认证状态
        </div>
        <button class="filter-btn" data-filter="certified">
          <i class="fas fa-check-circle"></i>
          已认证商品
        </button>
        <button class="filter-btn" data-filter="verified-artisan">
          <i class="fas fa-user-check"></i>
          认证匠人
        </button>
        <button class="filter-btn" data-filter="rwa">
          <i class="fas fa-shield-alt"></i>
          RWA 资产
        </button>
      </div>

      <!-- 产地筛选 -->
      <div class="sidebar-section">
        <div class="sidebar-title">
          <i class="fas fa-map-marker-alt"></i>
          产地筛选
        </div>
        <select id="regionFilter" class="filter-select">
          <option value="">全部产地</option>
          <option value="苏州">苏州</option>
          <option value="景德镇">景德镇</option>
          <option value="杭州">杭州</option>
          <option value="北京">北京</option>
          <option value="上海">上海</option>
        </select>
      </div>

      <!-- 匠人筛选 -->
      <div class="sidebar-section">
        <div class="sidebar-title">
          <i class="fas fa-user"></i>
          匠人筛选
        </div>
        <select id="artisanFilter" class="filter-select">
          <option value="">全部匠人</option>
        </select>
      </div>
    </aside>

    <!-- 右侧商品列表 -->
    <main>
      <!-- 统计信息栏 -->
      <div class="stats-bar">
        <div class="stats-text">
          找到 <span class="stats-count" id="productCount">0</span> 件商品
        </div>
        <div class="stats-text text-sm">
          <i class="fas fa-filter mr-1"></i>
          筛选已激活
        </div>
      </div>

      <!-- 商品网格 -->
      <div id="product_list" class="product-grid"></div>
    </main>
  </div>

  <!-- 下单弹层背景 -->
  <div id="order_modal_backdrop"
       class="fixed inset-0 bg-black/40 hidden items-end justify-center z-50">
    <!-- 下单卡片 -->
    <div class="w-full max-w-md bg-white rounded-t-2xl shadow-xl p-4">
      <div class="flex items-start justify-between mb-3">
        <div class="text-[#9E2A2B] font-semibold text-sm">
          确认下单
        </div>
        <button class="text-xs text-gray-500" onclick="closeOrderModal()">关闭</button>
      </div>

      <div class="text-xs text-gray-600 leading-relaxed mb-4" id="order_product_info">
        <!-- 动态填：商品名、价格等 -->
      </div>

      <div class="grid gap-3 text-xs">
        <input id="order_qty" class="w-full border rounded-lg p-3 text-sm" placeholder="购买数量 (整数)" />

        <div class="border rounded-lg p-3">
          <div class="text-[11px] text-gray-500 mb-1">收件信息</div>
          <input id="ship_name" class="w-full border rounded-lg p-2 mb-2 text-sm" placeholder="姓名 / Name" />
          <input id="ship_phone" class="w-full border rounded-lg p-2 mb-2 text-sm" placeholder="电话 / Phone" />
          <textarea id="ship_addr"
            class="w-full border rounded-lg p-2 text-sm"
            rows="3"
            placeholder="详细地址 / Address (含国家, 州, 城市, 邮编)">
          </textarea>
        </div>

        <button
          onclick="submitOrder()"
          class="bg-[#9E2A2B] text-white rounded-xl py-3 font-semibold text-sm active:opacity-80">
          提交订单
        </button>

        <div class="text-[10px] text-gray-400 leading-relaxed">
          我确认：本订单为真实非遗手作/小批量作品，支付后由节点统一发货。
          收货后我将有资格领取链上正品认证徽章（不可伪造）。
        </div>
      </div>
    </div>
  </div>


  <script src="../common/auth.js"></script>
  <script>
    // ========= 配置区域 =========
    // API_BASE 已在 auth.js 中定义，这里直接使用全局变量
    
    // 使用通用认证模块
    const auth = window.authModule;

    let currentWallet = "";
    let productsCache = [];
    let selectedProduct = null; // {id,title_zh,price_native,...}

    // 短地址显示函数
    function shortAddr(addr) {
      if (!addr) return "";
      return addr.slice(0,6) + "..." + addr.slice(-4);
    }

    // ========= 钱包连接逻辑 =========
    async function connectWallet() {
      try {
        if (!auth || !auth.walletLogin) {
          throw new Error('认证模块未正确加载');
        }
        
        const result = await auth.walletLogin();
        if (result.success) {
          currentWallet = result.wallet;
          document.getElementById("connectBtn").innerText = shortAddr(currentWallet);
          if (auth.showToast) {
            auth.showToast('钱包连接成功', 'success');
          } else {
            alert('钱包连接成功');
          }
        }
      } catch (error) {
        console.error('钱包连接失败:', error);
        if (auth && auth.showToast) {
          auth.showToast('钱包连接失败: ' + error.message, 'error');
        } else {
          alert('钱包连接失败: ' + error.message);
        }
      }
    }

    // ========= 加载商品列表 =========
    async function loadProducts() {
      const res = await fetch(API_BASE + "/products", { method: "GET" });
      const data = await res.json();
      if (!data.ok) {
        console.error("loadProducts error", data);
        document.getElementById("product_list").innerHTML =
          `<div class="text-xs text-red-600">商品加载失败：${data.error || "unknown"}</div>`;
        return;
      }

      productsCache = data.products || [];
      allProducts = [...productsCache];
      filteredProducts = [...allProducts];
      renderProductList();
    }

    function renderProductList() {
      const wrap = document.getElementById("product_list");
      const countEl = document.getElementById("productCount");
      wrap.innerHTML = "";
      
      // 更新商品数量
      if (countEl) {
        countEl.textContent = filteredProducts.length;
      }

      if (!filteredProducts.length) {
        wrap.innerHTML = `
          <div class="col-span-full text-center py-20">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-box-open text-3xl text-gray-400"></i>
            </div>
            <p class="text-lg font-semibold text-gray-600 mb-2">暂无商品</p>
            <p class="text-sm text-gray-400">请尝试调整筛选条件</p>
          </div>
        `;
        return;
      }

      filteredProducts.forEach(p => {
        // 卡片UI
        const card = document.createElement("div");
        card.className = "product-card";

        // 商品主图
        const imgBlock = p.image_key ? `
          <img src="${API_BASE}/image/${p.image_key}" 
               alt="${p.title_zh || '商品图片'}" 
               class="product-image"
               onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Crect fill=\\'%23F9F6F0\\' width=\\'400\\' height=\\'300\\'/%3E%3Ctext fill=\\'%239E2A2B\\' font-family=\\'Arial\\' font-size=\\'18\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3E暂无图片%3C/text%3E%3C/svg%3E';">
        ` : `
          <div class="product-image flex items-center justify-center">
            <div class="text-center text-gray-400">
              <i class="fas fa-image text-5xl mb-2"></i>
              <p class="text-sm">暂无图片</p>
            </div>
          </div>
        `;

        // 徽章
        const badges = [];
        if (p.badge_contract) {
          badges.push(`
            <span class="badge badge-certified">
              <i class="fas fa-certificate"></i>
              已认证
            </span>
          `);
        }
        if (p.artisan_verified) {
          badges.push(`
            <span class="badge badge-artisan">
              <i class="fas fa-user-check"></i>
              认证匠人
            </span>
          `);
        }
        if (p.artisan_region) {
          badges.push(`
            <span class="badge badge-region">
              <i class="fas fa-map-marker-alt"></i>
              ${p.artisan_region}
            </span>
          `);
        }

        card.innerHTML = `
          ${imgBlock}
          <div class="product-content">
            <h3 class="product-title">${p.title_zh || "(未命名商品)"}</h3>
            
            <div class="product-price">
              ${p.price_native}
              <span class="product-price-currency">${p.price_currency}</span>
            </div>
            
            <div class="product-meta">
              <div>
                <i class="fas fa-user text-xs mr-1"></i>
                传承人：${p.artisan_name_zh || "-"}
              </div>
              <div>
                <i class="fas fa-boxes text-xs mr-1"></i>
                库存：${p.stock} 件
              </div>
            </div>
            
            ${badges.length ? `<div class="product-badges">${badges.join('')}</div>` : ''}
            
            <div class="product-actions">
              <button
                class="btn btn-primary"
                onclick='openOrderModal(${JSON.stringify({
                  id: p.id,
                  title_zh: p.title_zh,
                  slug: p.slug,
                  price_native: p.price_native,
                  price_currency: p.price_currency
                })})'>
                <i class="fas fa-shopping-cart mr-1"></i>
                立即购买
              </button>
              <button
                class="btn btn-secondary"
                onclick='viewProductDetail("${p.id}")'>
                查看详情
              </button>
            </div>
          </div>
        `;

        wrap.appendChild(card);
      });
    }

    function escapeHtml(str) {
      return (str || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    // ========= 下单弹层 =========
    function openOrderModal(prodInfo) {
      // 检查钱包连接状态
      if (!currentWallet) {
        showWalletConnectPrompt();
        return;
      }
      
      selectedProduct = prodInfo;
      document.getElementById("order_product_info").innerHTML = `
        <div class="text-[#4A403A] font-semibold text-sm mb-1">
          ${prodInfo.title_zh}
        </div>
        <div class="text-[11px] text-[#4A403A]/70 mb-2">
          商品编号：${prodInfo.slug}
        </div>
        <div class="text-[11px] text-[#9E2A2B] font-medium">
          价格 ${prodInfo.price_native} ${prodInfo.price_currency}
        </div>
        <div class="text-[10px] text-green-600 mt-2">
          <i class="fas fa-wallet mr-1"></i>
          钱包已连接：${shortAddr(currentWallet)}
        </div>
      `;
      document.getElementById("order_modal_backdrop").classList.remove("hidden");
      document.getElementById("order_modal_backdrop").classList.add("flex");
    }

    // 显示钱包连接提示
    function showWalletConnectPrompt() {
      const promptHtml = `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="walletPrompt">
          <div class="bg-white rounded-2xl p-6 max-w-sm mx-4">
            <div class="text-center">
              <div class="w-16 h-16 bg-[#9E2A2B]/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-wallet text-2xl text-[#9E2A2B]"></i>
              </div>
              <h3 class="text-lg font-semibold text-[#4A403A] mb-2">需要连接钱包</h3>
              <p class="text-sm text-[#4A403A]/70 mb-6">
                购买商品需要连接钱包以完成身份验证和支付
              </p>
              <div class="flex gap-3">
                <button onclick="closeWalletPrompt()" class="flex-1 px-4 py-2 border border-[#D5BDAF] rounded-xl text-sm">
                  取消
                </button>
                <button onclick="connectWalletAndContinue()" class="flex-1 bg-[#9E2A2B] text-white rounded-xl py-2 text-sm font-semibold">
                  连接钱包
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', promptHtml);
    }

    function closeWalletPrompt() {
      const prompt = document.getElementById('walletPrompt');
      if (prompt) prompt.remove();
    }

    async function connectWalletAndContinue() {
      await connectWallet();
      closeWalletPrompt();
      // 如果连接成功，重新打开下单弹层
      if (currentWallet && selectedProduct) {
        openOrderModal(selectedProduct);
      }
    }

    function closeOrderModal() {
      selectedProduct = null;
      document.getElementById("order_qty").value = "";
      document.getElementById("ship_name").value = "";
      document.getElementById("ship_phone").value = "";
      document.getElementById("ship_addr").value = "";
      document.getElementById("order_modal_backdrop").classList.add("hidden");
      document.getElementById("order_modal_backdrop").classList.remove("flex");
    }

    // ========= 搜索和筛选功能 =========
    let allProducts = [];
    let filteredProducts = [];

    function setupSearchAndFilter() {
      const searchInput = document.getElementById('searchInput');
      const filterBtns = document.querySelectorAll('.filter-btn');
      const regionFilter = document.getElementById('regionFilter');
      const artisanFilter = document.getElementById('artisanFilter');

      // 搜索功能
      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        filterProducts(query);
      });

      // 筛选功能
      filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          filterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const filter = this.dataset.filter;
          filterProducts('', filter);
        });
      });

      // 产地筛选
      regionFilter.addEventListener('change', function() {
        filterProducts();
      });

      // 匠人筛选
      artisanFilter.addEventListener('change', function() {
        filterProducts();
      });
    }

    // 动态加载匠人列表
    function loadArtisanOptions() {
      const artisanFilter = document.getElementById('artisanFilter');
      const artisans = [...new Set(allProducts.map(p => p.artisan_name_zh).filter(Boolean))];
      
      artisans.forEach(artisan => {
        const option = document.createElement('option');
        option.value = artisan;
        option.textContent = artisan;
        artisanFilter.appendChild(option);
      });
    }

    function filterProducts(searchQuery = '', categoryFilter = 'all') {
      const regionFilter = document.getElementById('regionFilter').value;
      const artisanFilter = document.getElementById('artisanFilter').value;
      
      filteredProducts = allProducts.filter(product => {
        // 搜索匹配
        const matchesSearch = !searchQuery || 
          (product.title_zh && product.title_zh.toLowerCase().includes(searchQuery)) ||
          (product.artisan_name_zh && product.artisan_name_zh.toLowerCase().includes(searchQuery)) ||
          (product.desc_md && product.desc_md.toLowerCase().includes(searchQuery));
        
        // 类别筛选
        const matchesCategory = categoryFilter === 'all' || 
          (categoryFilter === 'certified' && product.badge_contract) ||
          (categoryFilter === 'verified-artisan' && product.artisan_verified) ||
          (categoryFilter === 'rwa' && product.badge_contract) ||
          (categoryFilter !== 'certified' && categoryFilter !== 'verified-artisan' && categoryFilter !== 'rwa' && 
           product.desc_md && product.desc_md.toLowerCase().includes(categoryFilter));
        
        // 产地筛选
        const matchesRegion = !regionFilter || 
          (product.artisan_region && product.artisan_region.includes(regionFilter));
        
        // 匠人筛选
        const matchesArtisan = !artisanFilter || 
          (product.artisan_name_zh && product.artisan_name_zh.includes(artisanFilter));
        
        return matchesSearch && matchesCategory && matchesRegion && matchesArtisan;
      });
      
      renderProductList();
    }

    function viewProductDetail(productId) {
      window.location.href = `../product.html?id=${productId}`;
    }

    // ========= 提交订单 =========
    async function submitOrder() {
      if (!currentWallet) {
        alert("请先连接钱包");
        return;
      }
      
      if (!auth || !auth.isLoggedIn || !auth.isLoggedIn()) {
        alert("请先完成钱包签名登录");
        return;
      }
      
      if (!selectedProduct) {
        alert("未选择商品");
        return;
      }

      const qty = document.getElementById("order_qty").value.trim();
      const ship_name = document.getElementById("ship_name").value.trim();
      const ship_phone = document.getElementById("ship_phone").value.trim();
      const ship_addr = document.getElementById("ship_addr").value.trim();

      if (!qty || !ship_name || !ship_phone || !ship_addr) {
        alert("请完整填写数量和收货信息");
        return;
      }

      // 验证数量
      const quantity = Number(qty);
      if (isNaN(quantity) || quantity <= 0 || !Number.isInteger(quantity)) {
        alert("请输入有效的购买数量（正整数）");
        return;
      }

      // 验证手机号格式
      const phoneRegex = /^1[3-9]\d{9}$/;
      if (!phoneRegex.test(ship_phone)) {
        alert("请输入有效的手机号码");
        return;
      }

      // 获取提交按钮并保存原始文本
      const submitBtn = document.querySelector('button[onclick="submitOrder()"]');
      const originalText = submitBtn ? submitBtn.textContent : '提交订单';

      const body = {
        product_id: selectedProduct.id,
        qty: quantity,
        buyer_wallet: currentWallet,
        shipping_info: {
          name: ship_name,
          phone: ship_phone,
          address: ship_addr
        }
      };

      try {
        // 显示加载状态
        if (submitBtn) {
          submitBtn.textContent = '提交中...';
          submitBtn.disabled = true;
        }

        let data;
        if (auth && auth.apiFetch) {
          data = await auth.apiFetch("/order/create", {
            method: "POST",
            body: JSON.stringify(body)
          });
        } else {
          // 回退到直接fetch
          const res = await fetch(API_BASE + "/order/create", {
            method: "POST",
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('bearer_token')}`
            },
            body: JSON.stringify(body)
          });
          data = await res.json();
        }
        console.log("order/create result", data);

        if (!data.ok) {
          if (data.error === 'AUTH_REQUIRED') {
            // 认证失败，引导用户重新登录
            closeOrderModal();
            showWalletConnectPrompt();
          } else {
            alert("下单失败：" + (data.error || "unknown"));
          }
          return;
        }

        // 成功提示
        showOrderSuccessModal(data.order_id, data.status);
        closeOrderModal();

      } catch (error) {
        console.error("下单失败:", error);
        alert("下单失败：" + error.message);
      } finally {
        // 恢复按钮状态
        if (submitBtn) {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }
    }

    // 显示订单成功模态框
    function showOrderSuccessModal(orderId, status) {
      const successHtml = `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="orderSuccessModal">
          <div class="bg-white rounded-2xl p-6 max-w-sm mx-4">
            <div class="text-center">
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-2xl text-green-600"></i>
              </div>
              <h3 class="text-lg font-semibold text-[#4A403A] mb-2">订单提交成功！</h3>
              <div class="text-sm text-[#4A403A]/70 mb-4">
                <p>订单号：${orderId}</p>
                <p>状态：${status}</p>
              </div>
              <p class="text-xs text-[#4A403A]/60 mb-6">
                请保持联系方式畅通，等待发货确认。您可以在个人中心查看订单状态。
              </p>
              <div class="flex gap-3">
                <button onclick="closeOrderSuccessModal()" class="flex-1 px-4 py-2 border border-[#D5BDAF] rounded-xl text-sm">
                  继续购物
                </button>
                <button onclick="goToOrders()" class="flex-1 bg-[#9E2A2B] text-white rounded-xl py-2 text-sm font-semibold">
                  查看订单
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', successHtml);
    }

    function closeOrderSuccessModal() {
      const modal = document.getElementById('orderSuccessModal');
      if (modal) modal.remove();
    }

    function goToOrders() {
      closeOrderSuccessModal();
      window.location.href = '../orders/';
    }

    // ========= 页面初始化 =========
    window.addEventListener("DOMContentLoaded", async () => {
      await loadProducts();
      loadArtisanOptions(); // 加载匠人选项
      setupSearchAndFilter();
      
      // 自动尝试连接钱包显示短地址（不会强签）
      if (window.ethereum) {
        try {
          const accs = await window.ethereum.request({ method: "eth_accounts" });
          if (accs && accs[0]) {
            currentWallet = accs[0];
            document.getElementById("connectBtn").innerText = shortAddr(currentWallet);
          }
        } catch(e){}
      }

      document.getElementById("connectBtn").addEventListener("click", connectWallet);
    });
  </script>
</body>
</html>

