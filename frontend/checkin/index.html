<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>é“¾ä¸Šé“­åˆ» Â· ä¸€æ¬¡å‡ºå¸­ï¼Œä¸€ç”Ÿç•™å</title>
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../styles/app.css"/>
  <style>
    :root{
      --brand:#9E2A2B; /* ä¸­å›½çº¢ */
      --brand2:#D5BDAF; /* æ¬¡è‰² */
      --bg:#F9F6F0; /* å®£çº¸è‰²èƒŒæ™¯ */
      --card:rgba(255,255,255,0.85); /* ç™½è‰²åŠé€æ˜å¡ç‰‡èƒŒæ™¯ */
      --line:#D5BDAF; /* è¾¹æ¡†æµ…è‰² */
      --muted:#A89B91; /* æŸ”å’Œç°è‰² */
      --ok:#9E2A2B; /* ä¸»è‰²ï¼Œçº¢è‰² */
      --err:#D32F2F; /* é”™è¯¯è‰²ï¼Œæ·±çº¢ */
      --text:#2D2A26; /* å­—ä½“ä¸»è‰²ï¼Œæ·±ç° */
      --shadow: 0 8px 24px rgba(158, 42, 43, 0.15);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      background:#F9F6F0; /* å®£çº¸è‰²çº¯èƒŒæ™¯ */
      /* å¦‚æœéœ€è¦æµ…çº¹ç†èƒŒæ™¯ï¼Œå¯åœ¨æ­¤æ·»åŠ èƒŒæ™¯å›¾ç‰‡æˆ–çº¹ç† */
      color:var(--text);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
    }
    .wrap{
      max-width:560px;
      margin:0 auto;
      padding:14px;
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:16px;
      margin:14px 0;
    }
    .heroTitle{
      font-weight:800;
      font-size:24px;
      margin-bottom:4px;
      color: var(--brand);
      line-height:1.3;
    }
    .heroSubtitle{
      font-weight:600;
      font-size:16px;
      margin-bottom:8px;
      color: var(--brand);
      opacity:0.85;
    }
    .sub{
      font-size:13px;
      color: var(--muted);
      line-height:1.5;
    }
    .header-top{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding-bottom:16px;
      border-bottom:1px solid rgba(213, 189, 175, 0.3);
    }
    .header-icon{
      width:48px;
      height:48px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      flex-shrink:0;
      box-shadow: 0 4px 12px rgba(158, 42, 43, 0.3);
    }
    .header-content{
      flex:1;
      min-width:0;
    }
    .network-badge{
      background:rgba(213, 189, 175, 0.3);
      border:1px solid var(--line);
      border-radius:8px;
      padding:6px 12px;
      font-size:11px;
      font-weight:600;
      color:var(--text);
      text-align:center;
      flex-shrink:0;
      white-space:nowrap;
    }
    .wallet-section{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid rgba(213, 189, 175, 0.3);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:10px 0;
    }
    input,select,button{
      height:48px;
      border-radius:14px;
      font-size:15px;
    }
    input,select{
      flex:1;
      background:rgba(255,255,255,0.85);
      border:1px solid var(--line);
      color:var(--text);
      padding:0 12px;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
      transition: all 0.3s ease;
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow: 0 0 0 2px rgba(158, 42, 43, 0.2);
    }
    .btn{
      flex:1;
      border:none;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      color:#fff;
      font-weight:600;
      box-shadow: 0 3px 14px rgba(158, 42, 43, 0.6);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn:hover {
      background: linear-gradient(90deg, #7a1b1c, #bba997);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(158, 42, 43, 0.4);
    }
    .ghost{
      flex:1;
      background:rgba(213, 189, 175, 0.3);
      border:1px solid var(--line);
      color:var(--text);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight:600;
    }
    .ghost:hover {
      background:var(--brand2);
      border-color: var(--brand);
    }
    .eventH{
      font-size:16px;
      font-weight:700;
      margin:2px 0 8px;
      color: var(--brand);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
    .eventLine{
      color: var(--muted);
      font-size:13px;
      margin:4px 0;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
    .panel{
      background:rgba(255,255,255,0.85);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      font:14px/1.6 "Noto Serif SC", "Songti SC", "SimSun", serif;
      color:var(--text);
      min-height:48px;
      white-space:pre-wrap;
      box-shadow: inset 0 0 8px rgba(158, 42, 43, 0.15);
    }
    .hint{
      font-size:11px;
      color: var(--muted);
      text-align:center;
      margin-top:6px;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
    .qrBox{
      text-align:center;
      margin:12px 0;
    }
    .okdot{
      width:18px;
      height:18px;
      border-radius:50%;
      background:var(--ok);
      display:inline-block;
      margin-right:8px;
      box-shadow: 0 0 6px var(--ok);
    }
    .modalMask{
      position:fixed;
      inset:0;
      background:rgba(249, 246, 240, 0.95);
      display:none;
      align-items:center;
      justify-content:center;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
      color: var(--text);
    }
    .modal{
      width:min(92vw,520px);
      background:rgba(255,255,255,0.95);
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .modal h3{
      margin:0 0 8px;
      font-size:18px;
      color: var(--brand);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
    .modal p{
      margin:6px 0 12px;
      color: var(--muted);
      font-size:14px;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
  </style>
  <!-- ç»Ÿä¸€é…ç½®ï¼ˆæä¾› WORKER_BASE_URL/RPC ç­‰ï¼‰ -->
  <script src="/poap.config.js?v=20251014"></script>
</head>
<body>
<div class="wrap">

  <!-- å¡ç‰‡1ï¼šå£å· + é’±åŒ…è¿æ¥ -->
  <div class="card">
    <!-- é¡¶éƒ¨åŒºåŸŸï¼šæ ‡é¢˜ + ç½‘ç»œæ ‡ç­¾ -->
    <div class="header-top">
      <div class="header-icon">
        <i class="fas fa-stamp"></i>
      </div>
      <div class="header-content">
        <div class="heroTitle">é“¾ä¸Šé“­åˆ»</div>
        <div class="heroSubtitle">ä¸€æ¬¡å‡ºå¸­ï¼Œä¸€ç”Ÿç•™å</div>
        <div class="sub">ä½ çš„å‚ä¸ï¼Œå°†è¢«æ°¸ä¹…è®°å½•ï¼›æ¯ä¸€æ¬¡ç­¾åï¼Œéƒ½æ˜¯æ–‡åŒ–çš„å°è®°ã€‚</div>
      </div>
      <div class="network-badge">Base Sepolia</div>
    </div>
    
    <!-- é’±åŒ…è¿æ¥åŒºåŸŸ -->
    <div class="wallet-section">
      <div class="row" style="margin-top:0">
        <select id="walletSel">
          <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
          <option value="metamask">MetaMask</option>
          <option value="coinbase">Coinbase</option>
          <option value="phantom">Phantom</option>
          <option value="walletconnect">WalletConnectï¼ˆé€šç”¨ï¼‰</option>
        </select>
        <button class="btn" id="btnConnect">è¿æ¥é’±åŒ…</button>
      </div>
      <div id="addrLine" class="sub" style="margin-top:8px">æœªè¿æ¥</div>
    </div>
  </div>

  <!-- å¡ç‰‡2ï¼šæ´»åŠ¨è¯¦æƒ… + äºŒç»´ç  + é“­åˆ» -->
  <div class="card" id="eventCard" style="display:none">
    <div class="eventH" id="evTitle">æ´»åŠ¨ä¸»é¢˜</div>
    <div class="eventLine" id="evTime"></div>
    <div class="eventLine" id="evLoc"></div>
    <div class="eventLine" id="evPoap"></div>

    <div class="row" style="margin-top:12px">
      <input id="code" placeholder="ç­¾åˆ°ç ï¼ˆå›ºå®šæˆ–ä¸´æ—¶ï¼‰">
    </div>
    <div class="row">
      <input id="poapContract" placeholder="åˆçº¦åœ°å€ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰" readonly>
    </div>

    <div class="qrBox">
      <img id="qr" alt="æ´»åŠ¨äºŒç»´ç " style="width:220px;height:220px;border-radius:12px;border:1px solid var(--line);background:#fff"/>
    </div>

    <div class="row">
      <button class="btn" id="btnClaim">é“­åˆ»æˆ‘çš„åˆ°åœº</button>
    </div>
    <div class="row" id="claimButtonRow" style="display:none;margin-top:8px">
      <button class="btn" onclick="window.location.href='../claim/index.html'">ğŸ å‰å¾€é¢†å–ä»£å¸</button>
    </div>

    <div class="panel" id="panel">å°±ç»ªã€‚</div>
    <div class="hint">æµç¨‹ï¼šè¿æ¥é’±åŒ… â†’ è¾“å…¥ç­¾åˆ°ç ï¼ˆæ´»åŠ¨å›ºå®šç æˆ–ä¸´æ—¶ç çš†å¯ï¼‰â†’ ç‚¹å‡»ã€Œé“­åˆ»æˆ‘çš„åˆ°åœºã€ã€‚</div>
  </div>

  <!-- å¡ç‰‡3ï¼šç­¾åˆ°å†å² -->
  <div class="card" id="historyCard" style="display:none">
    <div class="eventH">æˆ‘çš„ç­¾åˆ°å†å²</div>
    <div id="historyList" class="eventLine">åŠ è½½ä¸­...</div>
  </div>

</div>

<!-- å¼¹çª— -->
<div class="modalMask" id="mask">
  <div class="modal">
    <h3><span class="okdot"></span>é“­åˆ»æˆåŠŸ Â· ä½ çš„å‚ä¸å·²è¢«è®°å½•</h3>
    <p id="successText">å·²å®Œæˆç­¾åˆ°ã€‚</p>
    <div class="row">
      <button class="btn" id="btnShare">ä¸€é”®åˆ†äº«</button>
      <button class="ghost" id="btnClose">å…³é—­</button>
    </div>
  </div>
</div>

<script>
/** ===== å¸¸é‡ / å·¥å…· ===== **/
const WC_PROJECT_ID = "c793ffa242818d20b1b2173f14e8dab2";
const BASE_SEPOLIA = {
  chainId: 84532, chainIdHex: "0x14A34",
  rpcUrl: window.POAP_CONFIG?.RPC_URL || "https://sepolia.base.org",
  explorer: window.POAP_CONFIG?.EXPLORER || "https://sepolia.basescan.org"
};
const $ = id => document.getElementById(id);

// ä¿®å¤ï¼šç”¨æ­£ç¡®çš„æ­£åˆ™å»æ‰æœ«å°¾â€œæ–œæ â€ï¼Œä¸æ˜¯åæ–œæ 
const API_BASE = (window.POAP_CONFIG?.WORKER_BASE_URL || '').replace(/\/+$/,'');
// ä¿®å¤ï¼šæ¨¡æ¿å­—ç¬¦ä¸²å†…ä¸è¦å†åµŒå¥—åå¼•å·
const api = p => `${API_BASE}${p.startsWith('/') ? p : '/' + p}`;

function setPanel(t){$('panel').textContent=t;}
const shortAddr = a => a ? (a.slice(0,6)+"â€¦"+a.slice(-6)) : "";
function formatTime(s){const d=new Date(s);return isNaN(d.getTime())?s||"":d.toLocaleString();}
function buildQR(url){$('qr').src=`https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`;}

/** ===== æ´»åŠ¨åŠ è½½ï¼ˆå…¼å®¹ event ä¸ slug å‚æ•°ï¼‰ ===== **/
async function fetchEventBySlug(slug){
  const paths=[
    `/api/events/get?slug=${encodeURIComponent(slug)}`,
    `/api/event?slug=${encodeURIComponent(slug)}`,
    `/api/events/${encodeURIComponent(slug)}`
  ];
  for(const p of paths){
    try{
      const r=await fetch(api(p));
      if(!r.ok) continue;
      const j=await r.json();
      if(j?.ok && j.event) return j.event;
    }catch(_){}
  }
  return null;
}

async function loadEvent(){
  const u = new URLSearchParams(location.search);
  const slug = (u.get("event") || u.get("slug") || "").trim();
  const code = (u.get("code") || "").trim();
  const title = u.get("title") || "";
  const loc = u.get("loc") || "";
  const start = u.get("start") || "";
  const poap = u.get("poap") || "";

  if(code) $("code").value = code.toUpperCase();
  $("eventCard").style.display="block";
  $("evTitle").textContent=title||slug||"æ´»åŠ¨ä¸»é¢˜";
  $("evTime").textContent=start?("æ—¶é—´ï¼š"+formatTime(start)):"";
  $("evLoc").textContent=loc?("åœ°ç‚¹ï¼š"+loc):"";
  $("evPoap").textContent=poap?("åˆçº¦åœ°å€ï¼š"+poap):"";
  if(poap)$("poapContract").value=poap;

  buildQR(location.href.split("#")[0]);

  if(slug){
    try{
      const evt=await fetchEventBySlug(slug);
      if(evt){
        $("evTitle").textContent=evt.name||$("evTitle").textContent;
        $("evTime").textContent=evt.start_time?("æ—¶é—´ï¼š"+formatTime(evt.start_time)):$("evTime").textContent;
        $("evLoc").textContent=evt.location?("åœ°ç‚¹ï¼š"+evt.location):$("evLoc").textContent;
        if(evt.poap_contract){
          $("evPoap").textContent="åˆçº¦åœ°å€ï¼š"+evt.poap_contract;
          $("poapContract").value=evt.poap_contract;
        }
      }
    }catch(e){ setPanel("æ´»åŠ¨ä¿¡æ¯åŠ è½½å¤±è´¥ï¼š"+(e?.message||e)); }
  }
}

/** ===== é’±åŒ…è¿æ¥ï¼ˆæ³¨å…¥ä¼˜å…ˆï¼ŒWalletConnect å›é€€ï¼‰ ===== **/
let SELECTED_PROVIDER=null,WC_PROVIDER=null;

async function detectInjected(choice="auto"){
  const eth=window.ethereum;const list=(eth&&Array.isArray(eth.providers))?eth.providers:[];
  const pick=f=>list.find(p=>p&&p[f])||(eth&&eth[f]?eth:null);
  if(choice==="metamask")return pick("isMetaMask");
  if(choice==="coinbase")return pick("isCoinbaseWallet")||window.coinbaseWalletExtension;
  if(choice==="phantom")return window.phantom?.ethereum;
  if(list.length)return pick("isMetaMask")||pick("isCoinbaseWallet")||list[0];
  return eth||window.coinbaseWalletExtension||window.phantom?.ethereum||null;
}
async function getWalletConnectProvider(){
  if (!window.EthereumProvider) {
    await new Promise((resolve, reject)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2/dist/umd/index.min.js';
      s.onload = resolve;
      s.onerror = ()=>reject(new Error('WalletConnect UMD load failed'));
      document.head.appendChild(s);
    });
  }
  if (WC_PROVIDER) return WC_PROVIDER;
  WC_PROVIDER = await window.EthereumProvider.init({
    projectId: WC_PROJECT_ID,
    chains: [BASE_SEPOLIA.chainId],
    showQrModal: true,
    rpcMap: { [BASE_SEPOLIA.chainId]: BASE_SEPOLIA.rpcUrl },
    metadata: {
      name: "POAP Check-in",
      description: "é“¾ä¸Šé“­åˆ»ç­¾åˆ°",
      url: location.origin,
      icons: ["https://walletconnect.com/walletconnect-logo.png"]
    }
  });
  return WC_PROVIDER;
}
async function ensureBaseSepolia(p){
  try{
    const id=await p.request({method:"eth_chainId"});
    if(id.toLowerCase()!==BASE_SEPOLIA.chainIdHex.toLowerCase()){
      await p.request({method:"wallet_switchEthereumChain",params:[{chainId:BASE_SEPOLIA.chainIdHex}]});
    }
  }catch{
    try{await p.request({method:"wallet_addEthereumChain",
      params:[{chainId:BASE_SEPOLIA.chainIdHex,chainName:"Base Sepolia",
      nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},rpcUrls:[BASE_SEPOLIA.rpcUrl],
      blockExplorerUrls:[BASE_SEPOLIA.explorer]}]});}catch(_){}
  }
}
async function connect(){
  const choice=$("walletSel").value||"auto";
  try{
    if(choice==="walletconnect" || (!window.ethereum && /Android|iPhone|iPad/i.test(navigator.userAgent))){
      const p=await getWalletConnectProvider();await p.connect();SELECTED_PROVIDER=p;
    }else{
      const p=await detectInjected(choice);
      if(!p){$("addrLine").textContent="æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œå°è¯•è‡ªåŠ¨å”¤èµ·â€¦"; openMetaMask();return;}
      SELECTED_PROVIDER=p;await p.request({method:"eth_requestAccounts"});
    }
    await ensureBaseSepolia(SELECTED_PROVIDER);
    const acc=await SELECTED_PROVIDER.request({method:"eth_accounts"});
    $("addrLine").textContent=acc[0]?`å·²è¿æ¥ï¼š${shortAddr(acc[0])}`:"è¿æ¥å¤±è´¥";
  }catch(e){$("addrLine").textContent="è¿æ¥é”™è¯¯ï¼š"+(e?.message||e);}
}
function openMetaMask(){
  const deep="metamask://dapp/"+location.host;
  const fallback="https://metamask.app.link/dapp/"+location.host;
  window.location.href=deep;
  setTimeout(()=>{window.location.href=fallback;},1000);
}

/** ===== ç­¾åˆ° ===== **/
function beepOk(){try{const c=new(AudioContext||webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();
o.type="sine";o.frequency.value=880;g.gain.setValueAtTime(0.0001,c.currentTime);
g.gain.exponentialRampToValueAtTime(0.12,c.currentTime+.03);
g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+.35);
o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+.42);}catch(_){ }}
function openModal(t){$("successText").textContent=t||"ä½ å·²å®Œæˆæ´»åŠ¨ç­¾åˆ°ï¼Œæ„Ÿè°¢å‚ä¸ã€‚";$("mask").style.display="flex";beepOk();}
$("btnClose").onclick=()=>{$("mask").style.display="none";};
$("btnShare").onclick=async()=>{
  const url=location.href.split("#")[0];const title=$("evTitle").textContent||"POAPç­¾åˆ°";
  const text="æˆ‘å·²å®Œæˆé“¾ä¸Šåˆ°åœºé“­åˆ»ï¼Œä¸ä½ å…±äº«è¿™ä¸€åˆ»ã€‚";
  if(navigator.share){try{await navigator.share({title,text,url});return;}catch(_){ }}
  try{await navigator.clipboard.writeText(url);alert("å·²å¤åˆ¶åˆ†äº«é“¾æ¥");}catch{alert(url);}
};

async function postJSONWithFallbacks(paths, body){
  let lastErr = null;
  for(const p of paths){
    try{
      const r = await fetch(api(p), {
        method: "POST",
        headers: {"content-type":"application/json"},
        body: JSON.stringify(body)
      });
      const txt = await r.text(); let j={}; try{ j=JSON.parse(txt) }catch{};
      if(r.ok && (j?.ok===true || j?.ok==="true")) return {ok:true, data:j};
      lastErr = j?.error || `${r.status} ${txt}` || "UNKNOWN_ERROR";
    }catch(e){ lastErr = e?.message || String(e); }
  }
  return {ok:false, error:lastErr};
}

async function claim(){
  const p=SELECTED_PROVIDER;
  if(!p){ setPanel("è¯·å…ˆè¿æ¥é’±åŒ…"); return; }

  const acc = await p.request({method:"eth_accounts"});
  const address = acc?.[0];
  if(!address){ setPanel("é’±åŒ…æœªæˆæƒåœ°å€"); return; }

  const code = $("code").value.trim().toUpperCase();
  const poap = $("poapContract").value.trim();

  const params = new URLSearchParams(location.search);
  const slug = (params.get("event") || params.get("slug") || "").trim();
  if (!slug){ setPanel("é“¾æ¥ç¼ºå°‘ event/slug å‚æ•°"); return; }
  if (!code){ setPanel("è¯·è¾“å…¥ç­¾åˆ°ç ï¼ˆæˆ–ä½¿ç”¨äºŒç»´ç æºå¸¦çš„ codeï¼‰"); return; }

  setPanel("è¯·æ±‚æœåŠ¡å™¨æ ¡éªŒä¸­â€¦");

  const payload = { slug, code, address, poapContract: poap };
  const tries = [
    "/api/poap/checkin",
    "/poap/checkin"
  ];
  const res = await postJSONWithFallbacks(tries, payload);

  if(!res.ok){ setPanel("é¢†å–å¤±è´¥ï¼š"+ (res.error || "UNKNOWN_ERROR")); return; }

  // âœ… æ˜¾ç¤ºç§¯åˆ†å’Œç©ºæŠ•èµ„æ ¼
  const points = res.data?.points || 0;
  const eligible = res.data?.eligible || false;
  
  if (eligible && points > 0) {
    setPanel(`ç­¾åˆ°æˆåŠŸï¼è·å¾— ${points} ç§¯åˆ† ğŸ å·²è·å¾—ç©ºæŠ•èµ„æ ¼ ğŸ’`);
    $('claimButtonRow').style.display = 'flex';
    openModal(`ä½ çš„å‚ä¸å·²è¢«è®°å½•ã€‚\n\nğŸ è·å¾— ${points} ç§¯åˆ†ï¼\nğŸ’ å·²è·å¾—ç©ºæŠ•èµ„æ ¼ï¼\n\nå¯ä»¥å‰å¾€é¢†å–é¡µé¢é¢†å–ä»£å¸ã€‚`);
  } else if (points > 0) {
    setPanel(`ç­¾åˆ°æˆåŠŸï¼è·å¾— ${points} ç§¯åˆ†`);
    openModal(`ä½ çš„å‚ä¸å·²è¢«è®°å½•ã€‚ğŸ è·å¾— ${points} ç§¯åˆ†ï¼`);
  } else {
    setPanel("ç­¾åˆ°æˆåŠŸ");
    openModal("ä½ çš„å‚ä¸å·²è¢«è®°å½•ã€‚");
  }
}

// åŠ è½½ç­¾åˆ°å†å²
async function loadCheckinHistory() {
  const p = SELECTED_PROVIDER;
  if (!p) return;
  
  try {
    const acc = await p.request({method: "eth_accounts"});
    const address = acc?.[0];
    if (!address) return;
    
    const response = await fetch(api('/orders'), {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('bearer') || ''}`
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.orders && data.orders.length > 0) {
        displayCheckinHistory(data.orders);
        $('historyCard').style.display = 'block';
      }
    }
  } catch (error) {
    console.error('åŠ è½½ç­¾åˆ°å†å²å¤±è´¥:', error);
  }
}

function displayCheckinHistory(orders) {
  const historyList = $('historyList');
  
  if (orders.length === 0) {
    historyList.innerHTML = '<div class="sub">æš‚æ— ç­¾åˆ°è®°å½•</div>';
    return;
  }
  
  const historyHTML = orders.map(order => `
    <div style="border-bottom: 1px solid var(--line); padding: 8px 0; margin-bottom: 8px;">
      <div style="font-weight: 600; color: var(--brand);">${order.event_title || 'æœªçŸ¥æ´»åŠ¨'}</div>
      <div class="sub">æ—¶é—´: ${formatTime(order.created_at)}</div>
      <div class="sub">çŠ¶æ€: ${order.status || 'æœªçŸ¥'}</div>
      ${order.poap_contract ? `<div class="sub">POAP: ${order.poap_contract.slice(0,10)}...</div>` : ''}
    </div>
  `).join('');
  
  historyList.innerHTML = historyHTML;
}

/** ===== äº‹ä»¶ç»‘å®š ===== **/
document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnClaim').onclick = claim;

/** åˆå§‹æ¸²æŸ“ **/
loadEvent();
loadCheckinHistory();
</script>
</body>
</html>