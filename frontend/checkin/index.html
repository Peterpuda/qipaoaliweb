<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>é“¾ä¸Šé“­åˆ» Â· ä¸€æ¬¡å‡ºå¸­ï¼Œä¸€ç”Ÿç•™å</title>
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../styles/app.css"/>
  <link rel="stylesheet" href="../common/wallet-connector.css"/>
  <style>
    :root{
      --brand:#9E2A2B; /* ä¸­å›½çº¢ */
      --brand2:#D5BDAF; /* æ¬¡è‰² */
      --bg:#F9F6F0; /* å®£çº¸è‰²èƒŒæ™¯ */
      --card:rgba(255,255,255,0.85); /* ç™½è‰²åŠé€æ˜å¡ç‰‡èƒŒæ™¯ */
      --line:#D5BDAF; /* è¾¹æ¡†æµ…è‰² */
      --muted:#A89B91; /* æŸ”å’Œç°è‰² */
      --ok:#9E2A2B; /* ä¸»è‰²ï¼Œçº¢è‰² */
      --err:#D32F2F; /* é”™è¯¯è‰²ï¼Œæ·±çº¢ */
      --text:#2D2A26; /* å­—ä½“ä¸»è‰²ï¼Œæ·±ç° */
      --shadow: 0 8px 24px rgba(158, 42, 43, 0.15);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      background:#F9F6F0; /* å®£çº¸è‰²çº¯èƒŒæ™¯ */
      /* å¦‚æœéœ€è¦æµ…çº¹ç†èƒŒæ™¯ï¼Œå¯åœ¨æ­¤æ·»åŠ èƒŒæ™¯å›¾ç‰‡æˆ–çº¹ç† */
      color:var(--text);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
    }
    .wrap{
      max-width:560px;
      margin:0 auto;
      padding:14px;
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:16px;
      margin:14px 0;
    }
    .heroTitle{
      font-weight:800;
      font-size:24px;
      margin-bottom:4px;
      color: var(--brand);
      line-height:1.3;
    }
    .heroSubtitle{
      font-weight:600;
      font-size:16px;
      margin-bottom:8px;
      color: var(--brand);
      opacity:0.85;
    }
    .sub{
      font-size:13px;
      color: var(--muted);
      line-height:1.5;
    }
    .header-top{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding-bottom:16px;
      border-bottom:1px solid rgba(213, 189, 175, 0.3);
    }
    .header-icon{
      width:48px;
      height:48px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      flex-shrink:0;
      box-shadow: 0 4px 12px rgba(158, 42, 43, 0.3);
    }
    .header-content{
      flex:1;
      min-width:0;
    }
    .network-badge{
      background:rgba(213, 189, 175, 0.3);
      border:1px solid var(--line);
      border-radius:8px;
      padding:6px 12px;
      font-size:11px;
      font-weight:600;
      color:var(--text);
      text-align:center;
      flex-shrink:0;
      white-space:nowrap;
    }
    .wallet-section{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid rgba(213, 189, 175, 0.3);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:10px 0;
    }
    input,select,button{
      height:48px;
      border-radius:14px;
      font-size:15px;
    }
    input,select{
      flex:1;
      background:rgba(255,255,255,0.85);
      border:1px solid var(--line);
      color:var(--text);
      padding:0 12px;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
      transition: all 0.3s ease;
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow: 0 0 0 2px rgba(158, 42, 43, 0.2);
    }
    .btn{
      flex:1;
      border:none;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      color:#fff;
      font-weight:600;
      box-shadow: 0 3px 14px rgba(158, 42, 43, 0.6);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn:hover {
      background: linear-gradient(90deg, #7a1b1c, #bba997);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(158, 42, 43, 0.4);
    }
    .ghost{
      flex:1;
      background:rgba(213, 189, 175, 0.3);
      border:1px solid var(--line);
      color:var(--text);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight:600;
    }
    .ghost:hover {
      background:var(--brand2);
      border-color: var(--brand);
    }
    .eventH{
      font-size:16px;
      font-weight:700;
      margin:2px 0 8px;
      color: var(--brand);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
    .eventLine{
      color: var(--muted);
      font-size:13px;
      margin:4px 0;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
    .panel{
      background:rgba(255,255,255,0.85);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      font:14px/1.6 "Noto Serif SC", "Songti SC", "SimSun", serif;
      color:var(--text);
      min-height:48px;
      white-space:pre-wrap;
      box-shadow: inset 0 0 8px rgba(158, 42, 43, 0.15);
    }
    .hint{
      font-size:11px;
      color: var(--muted);
      text-align:center;
      margin-top:6px;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
    .qrBox{
      text-align:center;
      margin:12px 0;
    }
    .okdot{
      width:18px;
      height:18px;
      border-radius:50%;
      background:var(--ok);
      display:inline-block;
      margin-right:8px;
      box-shadow: 0 0 6px var(--ok);
    }
    .modalMask{
      position:fixed;
      inset:0;
      background:rgba(249, 246, 240, 0.95);
      display:none;
      align-items:center;
      justify-content:center;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
      color: var(--text);
    }
    .modal{
      width:min(92vw,520px);
      background:rgba(255,255,255,0.95);
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .modal h3{
      margin:0 0 8px;
      font-size:18px;
      color: var(--brand);
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
    .modal p{
      margin:6px 0 12px;
      color: var(--muted);
      font-size:14px;
      font-family: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }
  </style>
  <!-- ç»Ÿä¸€é…ç½®ï¼ˆæä¾› WORKER_BASE_URL/RPC ç­‰ï¼‰ -->
  <script src="/poap.config.js?v=20251014"></script>
  <script src="../common/wallet-connector.js"></script>
  <link rel="stylesheet" href="/common/global-nav.css">
</head>
<body>
  <div id="globalNavContainer"></div>

<div class="wrap">

  <!-- å¡ç‰‡1ï¼šå£å· + é’±åŒ…è¿æ¥ -->
  <div class="card">
    <!-- é¡¶éƒ¨åŒºåŸŸï¼šæ ‡é¢˜ + ç½‘ç»œæ ‡ç­¾ -->
    <div class="header-top">
      <div class="header-icon">
        <i class="fas fa-stamp"></i>
      </div>
      <div class="header-content">
        <div class="heroTitle">é“¾ä¸Šé“­åˆ»</div>
        <div class="heroSubtitle">ä¸€æ¬¡å‡ºå¸­ï¼Œä¸€ç”Ÿç•™å</div>
        <div class="sub">ä½ çš„å‚ä¸ï¼Œå°†è¢«æ°¸ä¹…è®°å½•ï¼›æ¯ä¸€æ¬¡ç­¾åï¼Œéƒ½æ˜¯æ–‡åŒ–çš„å°è®°ã€‚</div>
      </div>
      <div class="network-badge">Base Sepolia</div>
    </div>
    
    <!-- é’±åŒ…è¿æ¥åŒºåŸŸ -->
    <div class="wallet-section">
      <div class="row" style="margin-top:0">
        <button class="btn" id="btnConnect">
          <i class="fas fa-wallet"></i> è¿æ¥é’±åŒ…
        </button>
      </div>
      <div id="addrLine" class="sub" style="margin-top:8px;text-align:center">æœªè¿æ¥</div>
      <div id="walletInfo" class="sub" style="margin-top:4px;text-align:center;display:none;"></div>
    </div>
  </div>

  <!-- å¡ç‰‡2ï¼šæ´»åŠ¨è¯¦æƒ… + äºŒç»´ç  + é“­åˆ» -->
  <div class="card" id="eventCard" style="display:none">
    <div class="eventH" id="evTitle">æ´»åŠ¨ä¸»é¢˜</div>
    <div class="eventLine" id="evTime"></div>
    <div class="eventLine" id="evLoc"></div>
    <div class="eventLine" id="evPoap"></div>

    <div class="row" style="margin-top:12px">
      <input id="code" placeholder="ç­¾åˆ°ç ï¼ˆå›ºå®šæˆ–ä¸´æ—¶ï¼‰">
    </div>
    <div class="row">
      <input id="poapContract" placeholder="åˆçº¦åœ°å€ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰" readonly>
    </div>

    <div class="qrBox">
      <img id="qr" alt="æ´»åŠ¨äºŒç»´ç " style="width:220px;height:220px;border-radius:12px;border:1px solid var(--line);background:#fff"/>
    </div>

    <div class="row">
      <button class="btn" id="btnClaim">é“­åˆ»æˆ‘çš„åˆ°åœº</button>
    </div>
    <div class="row" id="claimTokenRow" style="display:none;margin-top:8px">
      <button class="btn" id="btnClaimToken" style="background:linear-gradient(90deg,#ff8a3d,#ffd05a)">ğŸ é¢†å– 1000 æšä»£å¸</button>
    </div>

    <div class="panel" id="panel">å°±ç»ªã€‚</div>
    <div class="panel" id="claimPanel" style="display:none;margin-top:10px;background:#1a1a1a;border:1px solid #ff8a3d"></div>
    <div class="hint">æµç¨‹ï¼šè¿æ¥é’±åŒ… â†’ è¾“å…¥ç­¾åˆ°ç ï¼ˆæ´»åŠ¨å›ºå®šç æˆ–ä¸´æ—¶ç çš†å¯ï¼‰â†’ ç‚¹å‡»ã€Œé“­åˆ»æˆ‘çš„åˆ°åœºã€ã€‚</div>
  </div>

  <!-- å¡ç‰‡3ï¼šç­¾åˆ°å†å² -->
  <div class="card" id="historyCard" style="display:none">
    <div class="eventH">æˆ‘çš„ç­¾åˆ°å†å²</div>
    <div id="historyList" class="eventLine">åŠ è½½ä¸­...</div>
  </div>

</div>

<!-- å¼¹çª— -->
<div class="modalMask" id="mask">
  <div class="modal">
    <h3><span class="okdot"></span>é“­åˆ»æˆåŠŸ Â· ä½ çš„å‚ä¸å·²è¢«è®°å½•</h3>
    <p id="successText">å·²å®Œæˆç­¾åˆ°ã€‚</p>
    <div class="row">
      <button class="btn" id="btnShare">ä¸€é”®åˆ†äº«</button>
      <button class="ghost" id="btnClose">å…³é—­</button>
    </div>
  </div>
</div>

<script>
/** ===== å¸¸é‡ / å·¥å…· ===== **/
const WC_PROJECT_ID = "c793ffa242818d20b1b2173f14e8dab2";
const BASE_SEPOLIA = {
  chainId: 84532, chainIdHex: "0x14A34",
  rpcUrl: window.POAP_CONFIG?.RPC_URL || "https://sepolia.base.org",
  explorer: window.POAP_CONFIG?.EXPLORER || "https://sepolia.basescan.org"
};
const $ = id => document.getElementById(id);

// ä¿®å¤ï¼šç”¨æ­£ç¡®çš„æ­£åˆ™å»æ‰æœ«å°¾â€œæ–œæ â€ï¼Œä¸æ˜¯åæ–œæ 
const API_BASE = (window.POAP_CONFIG?.WORKER_BASE_URL || '').replace(/\/+$/,'');
// ä¿®å¤ï¼šæ¨¡æ¿å­—ç¬¦ä¸²å†…ä¸è¦å†åµŒå¥—åå¼•å·
const api = p => `${API_BASE}${p.startsWith('/') ? p : '/' + p}`;

function setPanel(t){$('panel').textContent=t;}
const shortAddr = a => a ? (a.slice(0,6)+"â€¦"+a.slice(-6)) : "";
function formatTime(s){const d=new Date(s);return isNaN(d.getTime())?s||"":d.toLocaleString();}
function buildQR(url){$('qr').src=`https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`;}

/** ===== æ´»åŠ¨åŠ è½½ï¼ˆå…¼å®¹ event ä¸ slug å‚æ•°ï¼‰ ===== **/
async function fetchEventBySlug(slug){
  const paths=[
    `/api/events/get?slug=${encodeURIComponent(slug)}`,
    `/api/event?slug=${encodeURIComponent(slug)}`,
    `/api/events/${encodeURIComponent(slug)}`
  ];
  for(const p of paths){
    try{
      const r=await fetch(api(p));
      if(!r.ok) continue;
      const j=await r.json();
      if(j?.ok && j.event) return j.event;
    }catch(_){}
  }
  return null;
}

async function loadEvent(){
  const u = new URLSearchParams(location.search);
  const slug = (u.get("event") || u.get("slug") || "").trim();
  const code = (u.get("code") || "").trim();
  const title = u.get("title") || "";
  const loc = u.get("loc") || "";
  const start = u.get("start") || "";
  const poap = u.get("poap") || "";

  if(code) $("code").value = code.toUpperCase();
  $("eventCard").style.display="block";
  $("evTitle").textContent=title||slug||"æ´»åŠ¨ä¸»é¢˜";
  $("evTime").textContent=start?("æ—¶é—´ï¼š"+formatTime(start)):"";
  $("evLoc").textContent=loc?("åœ°ç‚¹ï¼š"+loc):"";
  $("evPoap").textContent=poap?("åˆçº¦åœ°å€ï¼š"+poap):"";
  if(poap)$("poapContract").value=poap;

  buildQR(location.href.split("#")[0]);

  if(slug){
    try{
      const evt=await fetchEventBySlug(slug);
      if(evt){
        $("evTitle").textContent=evt.name||$("evTitle").textContent;
        $("evTime").textContent=evt.start_time?("æ—¶é—´ï¼š"+formatTime(evt.start_time)):$("evTime").textContent;
        $("evLoc").textContent=evt.location?("åœ°ç‚¹ï¼š"+evt.location):$("evLoc").textContent;
        if(evt.poap_contract){
          $("evPoap").textContent="åˆçº¦åœ°å€ï¼š"+evt.poap_contract;
          $("poapContract").value=evt.poap_contract;
        }
      }
    }catch(e){ setPanel("æ´»åŠ¨ä¿¡æ¯åŠ è½½å¤±è´¥ï¼š"+(e?.message||e)); }
  }
}

/** ===== é’±åŒ…è¿æ¥ï¼ˆä½¿ç”¨é€šç”¨é’±åŒ…è¿æ¥å™¨ï¼‰ ===== **/
let SELECTED_PROVIDER = null;
let currentWalletAddress = null;

async function connect() {
  try {
    $("addrLine").textContent = "è¿æ¥ä¸­...";
    if ($("walletInfo")) $("walletInfo").style.display = "none";
    
    // ä½¿ç”¨é€šç”¨é’±åŒ…è¿æ¥å™¨
    const result = await WalletConnector.connect({
      chainId: BASE_SEPOLIA.chainIdHex,
      chainConfig: {
        chainId: BASE_SEPOLIA.chainIdHex,
        chainName: "Base Sepolia",
        nativeCurrency: {
          name: "ETH",
          symbol: "ETH",
          decimals: 18
        },
        rpcUrls: [BASE_SEPOLIA.rpcUrl],
        blockExplorerUrls: [BASE_SEPOLIA.explorer]
      },
      onAccountChanged: (newAddress) => {
        currentWalletAddress = newAddress;
        $("addrLine").textContent = `âœ… å·²è¿æ¥ï¼š${WalletConnector.shortAddress(newAddress)}`;
        // é‡æ–°åŠ è½½ç­¾åˆ°å†å²
        loadCheckinHistory();
      },
      onChainChanged: () => {
        // ç½‘ç»œå˜åŒ–æ—¶é‡æ–°è¿æ¥
        setTimeout(() => connect(), 1000);
      }
    });
    
    SELECTED_PROVIDER = result.provider;
    currentWalletAddress = result.address;
    
    $("addrLine").textContent = `âœ… å·²è¿æ¥ï¼š${WalletConnector.shortAddress(result.address)}`;
    if ($("walletInfo")) {
      $("walletInfo").textContent = `é’±åŒ…ï¼š${result.wallet}`;
      $("walletInfo").style.display = "block";
    }
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    $("btnConnect").innerHTML = `<i class="fas fa-check-circle"></i> å·²è¿æ¥`;
    
    // åŠ è½½ç­¾åˆ°å†å²
    loadCheckinHistory();
    
  } catch (error) {
    console.error('è¿æ¥é”™è¯¯è¯¦æƒ…:', error);
    $("addrLine").textContent = "âŒ è¿æ¥å¤±è´¥ï¼š" + (error?.message || error);
    if ($("walletInfo")) $("walletInfo").style.display = "none";
    $("btnConnect").innerHTML = `<i class="fas fa-wallet"></i> è¿æ¥é’±åŒ…`;
  }
}

/** ===== ç­¾åˆ° ===== **/
function beepOk(){try{const c=new(AudioContext||webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();
o.type="sine";o.frequency.value=880;g.gain.setValueAtTime(0.0001,c.currentTime);
g.gain.exponentialRampToValueAtTime(0.12,c.currentTime+.03);
g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+.35);
o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+.42);}catch(_){ }}
function openModal(t){$("successText").textContent=t||"ä½ å·²å®Œæˆæ´»åŠ¨ç­¾åˆ°ï¼Œæ„Ÿè°¢å‚ä¸ã€‚";$("mask").style.display="flex";beepOk();}
$("btnClose").onclick=()=>{$("mask").style.display="none";};
$("btnShare").onclick=async()=>{
  const url=location.href.split("#")[0];const title=$("evTitle").textContent||"POAPç­¾åˆ°";
  const text="æˆ‘å·²å®Œæˆé“¾ä¸Šåˆ°åœºé“­åˆ»ï¼Œä¸ä½ å…±äº«è¿™ä¸€åˆ»ã€‚";
  if(navigator.share){try{await navigator.share({title,text,url});return;}catch(_){ }}
  try{await navigator.clipboard.writeText(url);alert("å·²å¤åˆ¶åˆ†äº«é“¾æ¥");}catch{alert(url);}
};

async function postJSONWithFallbacks(paths, body){
  let lastErr = null;
  for(const p of paths){
    try{
      const r = await fetch(api(p), {
        method: "POST",
        headers: {"content-type":"application/json"},
        body: JSON.stringify(body)
      });
      const txt = await r.text(); let j={}; try{ j=JSON.parse(txt) }catch{};
      if(r.ok && (j?.ok===true || j?.ok==="true")) return {ok:true, data:j};
      lastErr = j?.error || `${r.status} ${txt}` || "UNKNOWN_ERROR";
    }catch(e){ lastErr = e?.message || String(e); }
  }
  return {ok:false, error:lastErr};
}

async function claim(){
  const p=SELECTED_PROVIDER;
  if(!p){ setPanel("è¯·å…ˆè¿æ¥é’±åŒ…"); return; }

  const address = currentWalletAddress;
  if(!address){ setPanel("é’±åŒ…æœªæˆæƒåœ°å€"); return; }

  const code = $("code").value.trim().toUpperCase();
  const poap = $("poapContract").value.trim();

  const params = new URLSearchParams(location.search);
  const slug = (params.get("event") || params.get("slug") || "").trim();
  if (!slug){ setPanel("é“¾æ¥ç¼ºå°‘ event/slug å‚æ•°"); return; }
  if (!code){ setPanel("è¯·è¾“å…¥ç­¾åˆ°ç ï¼ˆæˆ–ä½¿ç”¨äºŒç»´ç æºå¸¦çš„ codeï¼‰"); return; }

  setPanel("è¯·æ±‚æœåŠ¡å™¨æ ¡éªŒä¸­â€¦");

  const payload = { slug, code, address, poapContract: poap };
  
  // ç›´æ¥è°ƒç”¨æ­£ç¡®çš„APIè·¯å¾„
  let res;
  try {
    const r = await fetch(api("/api/poap/checkin"), {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    
    if(!r.ok || !data.ok) {
      const errorMsg = data.message || data.error || "UNKNOWN_ERROR";
      setPanel("ç­¾åˆ°å¤±è´¥ï¼š"+ errorMsg); 
      return;
    }
    
    res = { ok: true, data };
  } catch(e) {
    setPanel("ç½‘ç»œé”™è¯¯ï¼š"+ (e?.message || e)); 
    return;
  }

  // âœ… æ˜¾ç¤ºç§¯åˆ†ã€ç­¾åˆ°æ¬¡æ•°å’Œç©ºæŠ•èµ„æ ¼
  const points = res.data?.points || 0;
  const eligible = res.data?.eligible || false;
  const totalCheckins = res.data?.totalCheckins || 1;
  const totalTokens = res.data?.totalTokens || "0";
  const tokensAmount = totalTokens !== "0" ? (BigInt(totalTokens) / BigInt(10**18)).toString() : "1000";
  const message = res.data?.message || "";
  
  if (eligible && points > 0) {
    setPanel(`âœ… ${message || `ç­¾åˆ°æˆåŠŸï¼è·å¾— ${points} ç§¯åˆ†`}`);
    $('claimTokenRow').style.display = 'flex';
    openModal(`ğŸ‰ ç­¾åˆ°æˆåŠŸï¼\n\nğŸ“… è¿™æ˜¯æ‚¨çš„ç¬¬ ${totalCheckins} æ¬¡ç­¾åˆ°\nğŸ è·å¾— ${points} ç§¯åˆ†\nğŸ’ ç´¯è®¡å¯é¢†å– ${tokensAmount} æšä»£å¸\n\nå…³é—­æ­¤çª—å£åï¼Œç‚¹å‡»ä¸‹æ–¹ã€ŒğŸ é¢†å–ä»£å¸ã€æŒ‰é’®å®Œæˆé¢†å–ã€‚`);
  } else if (points > 0) {
    setPanel(`ç­¾åˆ°æˆåŠŸï¼è·å¾— ${points} ç§¯åˆ†`);
    openModal(`ä½ çš„å‚ä¸å·²è¢«è®°å½•ã€‚ğŸ è·å¾— ${points} ç§¯åˆ†ï¼`);
  } else {
    setPanel("ç­¾åˆ°æˆåŠŸ");
    openModal("ä½ çš„å‚ä¸å·²è¢«è®°å½•ã€‚");
  }
}

// åŠ è½½ç­¾åˆ°å†å²
async function loadCheckinHistory() {
  const p = SELECTED_PROVIDER;
  if (!p) return;
  
  try {
    const address = currentWalletAddress;
    if (!address) return;
    
    const response = await fetch(api('/orders'), {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('bearer') || ''}`
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.orders && data.orders.length > 0) {
        displayCheckinHistory(data.orders);
        $('historyCard').style.display = 'block';
      }
    }
  } catch (error) {
    console.error('åŠ è½½ç­¾åˆ°å†å²å¤±è´¥:', error);
  }
}

function displayCheckinHistory(orders) {
  const historyList = $('historyList');
  
  if (orders.length === 0) {
    historyList.innerHTML = '<div class="sub">æš‚æ— ç­¾åˆ°è®°å½•</div>';
    return;
  }
  
  const historyHTML = orders.map(order => `
    <div style="border-bottom: 1px solid var(--line); padding: 8px 0; margin-bottom: 8px;">
      <div style="font-weight: 600; color: var(--brand);">${order.event_title || 'æœªçŸ¥æ´»åŠ¨'}</div>
      <div class="sub">æ—¶é—´: ${formatTime(order.created_at)}</div>
      <div class="sub">çŠ¶æ€: ${order.status || 'æœªçŸ¥'}</div>
      ${order.poap_contract ? `<div class="sub">POAP: ${order.poap_contract.slice(0,10)}...</div>` : ''}
    </div>
  `).join('');
  
  historyList.innerHTML = historyHTML;
}

/** ===== ä»£å¸é¢†å–åŠŸèƒ½ ===== **/
// SimpleAirdropV2 ABIï¼ˆæ›´ç®€å•çš„ç©ºæŠ•åˆçº¦ï¼‰
const CLAIM_ABI = [
  {
    "inputs": [],
    "name": "claim",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
    "name": "isClaimed",
    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getContractBalance",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "amountPerClaim",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  }
];

// åˆçº¦åœ°å€é…ç½®ï¼ˆç®¡ç†å‘˜éƒ¨ç½²åˆçº¦åå¡«å…¥ï¼‰
const DISTRIBUTOR_CONTRACT = window.POAP_CONFIG?.DISTRIBUTOR_CONTRACT || "";

function setClaimLog(text) {
  const panel = $('claimPanel');
  panel.style.display = 'block';
  panel.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
}

async function claimTokens() {
  const p = SELECTED_PROVIDER;
  if(!p) {
    setClaimLog('è¯·å…ˆè¿æ¥é’±åŒ…');
    return;
  }

  const address = currentWalletAddress;
  if(!address) {
    setClaimLog('é’±åŒ…æœªæˆæƒåœ°å€');
    return;
  }

  // è·å–æ´»åŠ¨IDï¼ˆæ‰¹æ¬¡å·ï¼‰
  const params = new URLSearchParams(location.search);
  const slug = (params.get("event") || params.get("slug") || "").trim();
  if(!slug) {
    setClaimLog('æ— æ³•è·å–æ´»åŠ¨ID');
    return;
  }

  // è·å–åˆçº¦åœ°å€ï¼ˆä»é…ç½®æˆ–äº‹ä»¶ä¿¡æ¯ï¼‰
  const distributorContract = DISTRIBUTOR_CONTRACT || $("poapContract").value.trim();
  if(!distributorContract) {
    setClaimLog('é”™è¯¯ï¼šæœªé…ç½®åˆçº¦åœ°å€ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
    return;
  }

  setClaimLog('æ­£åœ¨æŸ¥è¯¢é¢†å–èµ„æ ¼...');

  try {
    // 1. æŸ¥è¯¢é¢†å–èµ„æ ¼
    const eligUrl = `${API_BASE}/rewards/v2/eligibility/${encodeURIComponent(slug)}/${encodeURIComponent(address)}`;
    const eligResp = await fetch(eligUrl);
    const eligData = await eligResp.json();

    if(!eligData.ok || !eligData.eligible) {
      setClaimLog('æ‚¨æš‚æ— é¢†å–èµ„æ ¼ï¼Œè¯·å…ˆå®Œæˆç­¾åˆ°');
      return;
    }

           if(!eligData.ready) {
             setClaimLog('ç®¡ç†å‘˜å°šæœªç”ŸæˆMerkleè¯æ˜ï¼Œè¯·ç¨åå†è¯•');
             return;
           }

           const claimableTokens = "1000";  // SimpleAirdropV2 å›ºå®šæ¯æ¬¡ 1000 ä»£å¸
           
           setClaimLog(`âœ… èµ„æ ¼éªŒè¯é€šè¿‡ï¼\nğŸ“Š ç´¯è®¡ç­¾åˆ° ${eligData.checkinCount || 0} æ¬¡\nğŸ’° å¯é¢†å–ï¼š${claimableTokens} æš QIPAO ä»£å¸\n\nå‡†å¤‡æäº¤é“¾ä¸Šäº¤æ˜“...`);

    // 2. åŠ è½½ ethers.jsï¼ˆå¦‚æœè¿˜æ²¡åŠ è½½ï¼‰
    if(!window.ethers) {
      setClaimLog('æ­£åœ¨åŠ è½½åŒºå—é“¾åº“...');
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/ethers@6.13.2/dist/ethers.umd.min.js';
        script.onload = resolve;
        script.onerror = () => reject(new Error('åŠ è½½å¤±è´¥'));
        document.head.appendChild(script);
      });
    }

    // 3. è¿æ¥åˆçº¦å¹¶é¢†å–ï¼ˆSimpleAirdropV2ï¼šæ— éœ€å‚æ•°ï¼‰
    setClaimLog('æ­£åœ¨æäº¤é“¾ä¸Šäº¤æ˜“...');
    const ethersProvider = new ethers.BrowserProvider(window.ethereum);
    const signer = await ethersProvider.getSigner();
    const contract = new ethers.Contract(distributorContract, CLAIM_ABI, signer);

    // âœ… SimpleAirdropV2 çš„ claim() å‡½æ•°ä¸éœ€è¦ä»»ä½•å‚æ•°
    const tx = await contract.claim();
    setClaimLog(`äº¤æ˜“å·²æäº¤ï¼š${tx.hash}\nç­‰å¾…ç¡®è®¤...`);

           const receipt = await tx.wait();
           const amountInTokens = "1000";  // SimpleAirdropV2 å›ºå®šæ¯æ¬¡ 1000 ä»£å¸

           setClaimLog(`ğŸ‰ é¢†å–æˆåŠŸï¼\nâœ… å·²åˆ°è´¦ ${amountInTokens} æšä»£å¸\nğŸ“¦ åŒºå—ï¼š${receipt.blockNumber}\nğŸ”— äº¤æ˜“ï¼š${tx.hash}`);
           
           // éšè—é¢†å–æŒ‰é’®
           $('claimTokenRow').style.display = 'none';
           
           // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
           const modalMsg = `ğŸ‰ æ­å–œï¼ä»£å¸é¢†å–æˆåŠŸï¼\n\nğŸ’° å·²åˆ°è´¦ï¼š${amountInTokens} æš QIPAO ä»£å¸\nğŸ“¦ åŒºå—é«˜åº¦ï¼š${receipt.blockNumber}\nğŸ”— äº¤æ˜“å“ˆå¸Œï¼š${tx.hash.slice(0, 10)}...${tx.hash.slice(-8)}\n\nè¯·åœ¨é’±åŒ…ä¸­æŸ¥çœ‹æ‚¨çš„èµ„äº§ã€‚`;
           
           openModal(modalMsg);

  } catch(error) {
    console.error('é¢†å–å¤±è´¥:', error);
    setClaimLog(`âŒ é¢†å–å¤±è´¥ï¼š${error.message || error}`);
  }
}

/** ===== äº‹ä»¶ç»‘å®š ===== **/
document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnClaim').onclick = claim;
document.getElementById('btnClaimToken').onclick = claimTokens;

/** åˆå§‹æ¸²æŸ“ **/
loadEvent();
loadCheckinHistory();
</script>
  <script src="/common/global-nav.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      await initGlobalNav({ currentPage: 'checkin' });
    });
  </script>
</body>
</html>