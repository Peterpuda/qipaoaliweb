<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title data-i18n="product.title">å•†å“è¯¦æƒ… - éé—ä¸Šé“¾å¹³å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="/poap.config.js"></script>
  <!-- i18n -->
  <script src="/i18n/index.js"></script>
  <script src="/common/i18n-helper.js"></script>
  <style>
    :root {
      --primary: #9E2A2B;
      --secondary: #4A403A;
      --accent: #D5BDAF;
      --gold: #D4AF37;
      --ink: #2D2A26;
      --paper: #F9F6F0;
      --line: #D5BDAF;
      --muted: #9E2A2B;
    }
    
    body {
      font-family: "Noto Serif SC", serif;
      background-color: var(--paper);
      color: var(--ink);
    }
    
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
    }
    
    .btn-primary {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: var(--paper);
      box-shadow: 0 3px 14px rgba(158, 42, 43, 0.6);
    }
    
    .btn-primary:hover {
      background: #7a1b1c;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: var(--paper);
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    .btn-secondary:hover {
      background: var(--accent);
      color: var(--ink);
    }
    
    .card {
      background: var(--paper);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(213, 189, 175, 0.4);
      padding: 20px;
      margin: 16px 0;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--line);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="min-h-screen max-w-[600px] mx-auto px-4 py-4" style="padding-bottom: 80px;">
    <!-- å¯¼èˆªæ  -->
    <header class="flex items-center justify-between py-4 mb-4">
      <div class="flex items-center gap-3">
        <button onclick="window.history.length > 1 ? window.history.back() : window.location.href='./mall/'" 
                class="w-10 h-10 rounded-full bg-line flex items-center justify-center text-ink hover:bg-primary hover:text-paper transition">
          <i class="fas fa-arrow-left"></i>
        </button>
        <a href="./index.html" class="flex items-center">
          <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-paper mr-3">
            <i class="fas fa-chess-rook text-lg"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-primary">éé—ä¸Šé“¾</h1>
            <p class="text-xs text-secondary" data-i18n="product.details">å•†å“è¯¦æƒ…</p>
          </div>
        </a>
      </div>
      <button id="connectWallet" class="btn btn-primary">
        <i class="fab fa-ethereum mr-2"></i>è¿æ¥é’±åŒ…
      </button>
    </header>

    <!-- å•†å“è¯¦æƒ… -->
    <div id="productDetail" class="card">
      <div class="text-center py-8">
        <div class="loading"></div>
        <p class="text-secondary mt-4">åŠ è½½ä¸­...</p>
      </div>
    </div>

    <!-- åŒ äººä¿¡æ¯ -->
    <div id="artisanInfo" class="card">
      <div class="text-center py-8">
        <div class="loading"></div>
        <p class="text-secondary mt-4">åŠ è½½åŒ äººä¿¡æ¯...</p>
      </div>
    </div>

    <!-- AI å¯¹è¯ç»„ä»¶å ä½ -->
    <div id="aiChatPlaceholder"></div>

    <!-- é“¾ä¸Šè®¤è¯ä¿¡æ¯ -->
    <div id="blockchainInfo" class="card">
      <h3 class="text-lg font-bold text-ink mb-4">é“¾ä¸Šè®¤è¯</h3>
      <div id="certificationStatus" class="text-center py-8">
        <div class="loading"></div>
        <p class="text-secondary mt-4">æ£€æŸ¥è®¤è¯çŠ¶æ€...</p>
      </div>
    </div>

    <!-- è´­ä¹°æŒ‰é’® -->
    <div class="fixed bottom-0 left-0 right-0 bg-paper border-t border-line p-4 max-w-[600px] mx-auto">
      <button id="buyButton" class="btn btn-primary w-full" disabled>
        <i class="fas fa-shopping-cart mr-2"></i>ç«‹å³è´­ä¹°
      </button>
    </div>
  </div>

  <script src="./common/auth.js"></script>
  <script src="./common/artisan-chat.js"></script>
  <script>
    // å…¨å±€å˜é‡
    let currentWallet = '';
    let currentProduct = null;
    
    // ä½¿ç”¨é€šç”¨è®¤è¯æ¨¡å—
    const auth = window.authModule;
    // ç›´æ¥ä½¿ç”¨å…¨å±€çš„ API_BASEï¼ˆæ¥è‡ª auth.jsï¼‰
    
    // è·å–URLå‚æ•°
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
    
    // åŠ è½½å•†å“è¯¦æƒ…
    async function loadProductDetail() {
        const productId = getUrlParameter('id');
        if (!productId) {
          document.getElementById('productDetail').innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-exclamation-triangle text-4xl text-secondary mb-4"></i>
              <h3 class="text-lg font-bold text-ink mb-2">å•†å“ä¸å­˜åœ¨</h3>
              <p class="text-secondary mb-4">è¯·æ£€æŸ¥å•†å“IDæ˜¯å¦æ­£ç¡®</p>
              <a href="./mall/" class="btn btn-primary">è¿”å›å•†åŸ</a>
            </div>
          `;
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE}/products`);
          const data = await response.json();
        
        if (data.products && data.products.length > 0) {
          const product = data.products.find(p => p.id === productId);
          if (product) {
            currentProduct = product; // ä¿å­˜å½“å‰å•†å“ä¿¡æ¯
            displayProductDetail(product);
            loadArtisanInfo(product.artisan_id);
            checkCertificationStatus(product);
          } else {
            throw new Error('å•†å“æœªæ‰¾åˆ°');
          }
        } else {
          throw new Error('å•†å“æ•°æ®åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å•†å“è¯¦æƒ…å¤±è´¥:', error);
        document.getElementById('productDetail').innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-exclamation-triangle text-4xl text-secondary mb-4"></i>
            <h3 class="text-lg font-bold text-ink mb-2">åŠ è½½å¤±è´¥</h3>
            <p class="text-secondary mb-4">${error.message}</p>
            <a href="./mall/" class="btn btn-primary">è¿”å›å•†åŸ</a>
          </div>
        `;
      }
    }
    
    // æ˜¾ç¤ºå•†å“è¯¦æƒ…
    function displayProductDetail(product) {
      // å•†å“å›¾åƒå¤„ç†
      const productImage = product.image_key ? 
        `<img src="${API_BASE}/image/${product.image_key}" 
             alt="${product.title_zh}" 
             class="w-full h-80 object-cover rounded-xl mb-4"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
         <div class="aspect-square bg-gradient-to-br from-primary/10 to-accent/20 rounded-xl items-center justify-center mb-4" style="display:none;">
           <div class="text-center">
             <i class="fas fa-image text-6xl text-primary/40 mb-2"></i>
             <p class="text-sm text-secondary">å›¾ç‰‡åŠ è½½å¤±è´¥</p>
           </div>
         </div>` :
        `<div class="aspect-square bg-gradient-to-br from-primary/10 to-accent/20 rounded-xl flex items-center justify-center mb-4">
          <div class="text-center">
            <i class="fas fa-image text-6xl text-primary/40 mb-2"></i>
            <p class="text-sm text-secondary">å•†å“å›¾ç‰‡</p>
          </div>
        </div>`;

      // è®¤è¯æ ‡è¯†
      const certificationBadge = product.badge_contract ? `
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center text-green-600">
            <i class="fas fa-certificate mr-2"></i>
            <span class="text-sm font-medium">å·²è®¤è¯ RWA æ•°å­—èµ„äº§</span>
          </div>
          <div class="flex items-center text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">
            <i class="fas fa-shield-alt mr-1"></i>
            <span>é“¾ä¸ŠéªŒè¯</span>
          </div>
        </div>
      ` : `
        <div class="flex items-center text-gray-400 mb-4">
          <i class="fas fa-clock mr-2"></i>
          <span class="text-sm">å¾…è®¤è¯</span>
        </div>
      `;

      // ä»·æ ¼ä¿¡æ¯
      const priceInfo = `
        <div class="bg-gradient-to-r from-primary/5 to-accent/5 rounded-xl p-4 mb-4">
          <div class="text-3xl font-bold text-primary mb-2">
            ${product.price_native} ${product.price_currency}
          </div>
          ${product.price_points ? `
            <div class="text-sm text-secondary">
              <i class="fas fa-coins mr-1"></i>
              å¯æŠµ ${product.price_points} ç§¯åˆ†
            </div>
          ` : ''}
        </div>
      `;

      // å•†å“æ ‡ç­¾
      const productTags = `
        <div class="flex flex-wrap gap-2 mb-4">
          <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm">
            <i class="fas fa-box mr-1"></i>
            åº“å­˜: ${product.stock || 0}
          </span>
          <span class="px-3 py-1 bg-accent/20 text-ink rounded-full text-sm">
            <i class="fas fa-hashtag mr-1"></i>
            ID: ${product.id}
          </span>
          ${product.slug ? `
            <span class="px-3 py-1 bg-secondary/10 text-secondary rounded-full text-sm">
              <i class="fas fa-tag mr-1"></i>
              ${product.slug}
            </span>
          ` : ''}
        </div>
      `;

      document.getElementById('productDetail').innerHTML = `
        <div class="mb-6">
          ${productImage}
          <h1 class="text-2xl font-bold text-ink mb-2">${product.title_zh || 'æœªçŸ¥å•†å“'}</h1>
          ${product.title_en ? `<p class="text-sm text-secondary mb-4">${product.title_en}</p>` : ''}
          ${certificationBadge}
          ${priceInfo}
          ${productTags}
        </div>
        <div class="border-t border-line pt-4">
          <h3 class="text-lg font-bold text-ink mb-3">
            <i class="fas fa-info-circle mr-2"></i>
            å•†å“æè¿°
          </h3>
          <div class="text-secondary leading-relaxed">
            ${product.desc_md || 'è¿™ä»¶ä½œå“èƒŒåæœ‰å®Œæ•´çš„æ‰‹å·¥å·¥åºä¸æ–‡åŒ–æ•…äº‹ï¼Œæ¯ä¸€é“å·¥åºéƒ½æ‰¿è½½ç€æ·±åšçš„æ–‡åŒ–å†…æ¶µã€‚'}
          </div>
        </div>
        
        <!-- æ–‡åŒ–æ•…äº‹å…¥å£ -->
        <div class="border-t border-line pt-4 mt-4">
          <button onclick="loadCulturalNarratives('${product.id}')" class="btn btn-secondary w-full flex items-center justify-center gap-2">
            <i class="fas fa-book-open"></i>
            <span data-i18n="product.culturalStory">äº†è§£æ–‡åŒ–æ•…äº‹</span>
            <span class="text-xs bg-primary/10 px-2 py-1 rounded-full ml-2">å¤šæ ¼å¼</span>
          </button>
          <p class="text-xs text-secondary text-center mt-2">
            ğŸ“– æ–‡å­— â€¢ ğŸµ è¯­éŸ³ â€¢ ğŸ¬ è§†é¢‘ ä¸‰ç§å½¢å¼æ·±åº¦äº†è§£
          </p>
        </div>
      `;
      
      // å¯ç”¨è´­ä¹°æŒ‰é’®
      document.getElementById('buyButton').disabled = false;
    }
    
    // åŠ è½½åŒ äººä¿¡æ¯
    async function loadArtisanInfo(artisanId) {
      if (!artisanId) {
        document.getElementById('artisanInfo').innerHTML = `
          <div class="text-center py-8">
            <p class="text-secondary">æš‚æ— åŒ äººä¿¡æ¯</p>
          </div>
        `;
        return;
      }
      
      try {
        // ä½¿ç”¨å…¬å¼€çš„åŒ äººAPIç«¯ç‚¹
        const response = await fetch(`${API_BASE}/artisans`);
        const data = await response.json();
        
        if (data.artisans && data.artisans.length > 0) {
          const artisan = data.artisans.find(a => a.id === artisanId);
          if (artisan) {
            displayArtisanInfo(artisan);
          } else {
            // å¦‚æœæ²¡æ‰¾åˆ°å…·ä½“åŒ äººï¼Œæ˜¾ç¤ºé€šç”¨åŒ äººä¿¡æ¯
            displayGenericArtisanInfo();
          }
        } else {
          throw new Error('åŒ äººæ•°æ®åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½åŒ äººä¿¡æ¯å¤±è´¥:', error);
        // æ˜¾ç¤ºé€šç”¨åŒ äººä¿¡æ¯ä½œä¸ºå¤‡é€‰
        displayGenericArtisanInfo();
      }
    }

    // æ˜¾ç¤ºé€šç”¨åŒ äººä¿¡æ¯
    function displayGenericArtisanInfo() {
      document.getElementById('artisanInfo').innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-ink">
            <i class="fas fa-user-tie mr-2"></i>
            åŒ äººä¿¡æ¯
          </h3>
          <button 
            onclick="alert('è¯¥å•†å“æš‚æ— å…³è”åŒ äººï¼Œæ— æ³•å¼€å¯å¯¹è¯')" 
            class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg text-sm font-medium flex items-center gap-2 cursor-not-allowed"
            disabled
          >
            <i class="fas fa-comment-dots"></i>
            <span>ä¸åŒ äººå¯¹è¯</span>
          </button>
        </div>
        <div class="flex items-center mb-4">
          <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center text-primary mr-4">
            <i class="fas fa-user-tie text-2xl"></i>
          </div>
          <div>
            <h4 class="text-lg font-semibold text-ink">ä¼ ç»ŸåŒ äºº</h4>
            <p class="text-sm text-secondary">éé—ä¼ æ‰¿äºº</p>
            <span class="text-xs px-2 py-1 bg-primary/10 text-primary rounded-full">
              è®¤è¯åŒ äºº
            </span>
          </div>
        </div>
        <div class="text-sm text-secondary leading-relaxed">
          è¿™ä»¶ä½œå“ç”±ç»éªŒä¸°å¯Œçš„ä¼ ç»ŸåŒ äººç²¾å¿ƒåˆ¶ä½œï¼Œæ¯ä¸€é“å·¥åºéƒ½éµå¾ªå¤æ³•å·¥è‰ºï¼Œæ‰¿è½½ç€æ·±åšçš„æ–‡åŒ–å†…æ¶µå’Œè‰ºæœ¯ä»·å€¼ã€‚
        </div>
      `;
    }
    
    // æ˜¾ç¤ºåŒ äººä¿¡æ¯
    function displayArtisanInfo(artisan) {
      // åŒ äººè®¤è¯çŠ¶æ€
      const verificationStatus = artisan.verified ? `
        <div class="flex items-center text-green-600 mb-2">
          <i class="fas fa-user-check mr-1"></i>
          <span class="text-xs font-medium">è®¤è¯åŒ äºº</span>
        </div>
      ` : `
        <div class="flex items-center text-gray-400 mb-2">
          <i class="fas fa-clock mr-1"></i>
          <span class="text-xs">å¾…è®¤è¯</span>
        </div>
      `;

      // åŒ äººæŠ€èƒ½æ ‡ç­¾
      const skillTags = artisan.skills ? artisan.skills.split(',').map(skill => 
        `<span class="px-2 py-1 bg-accent/20 text-ink rounded-full text-xs mr-1">${skill.trim()}</span>`
      ).join('') : '';

      document.getElementById('artisanInfo').innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-ink">
            <i class="fas fa-user-tie mr-2"></i>
            åŒ äººä¿¡æ¯
          </h3>
          <button 
            onclick="openArtisanChat('${artisan.id}', '${artisan.name_zh || artisan.name || 'ä¼ ç»ŸåŒ äºº'}')" 
            class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition text-sm font-medium flex items-center gap-2"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
          >
            <i class="fas fa-comment-dots"></i>
            <span>ä¸åŒ äººå¯¹è¯</span>
          </button>
        </div>
        <div class="flex items-start mb-4">
          <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center text-primary mr-4 flex-shrink-0">
            <i class="fas fa-user-tie text-2xl"></i>
          </div>
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-ink mb-1">${artisan.name_zh || artisan.name || 'ä¼ ç»ŸåŒ äºº'}</h4>
            <p class="text-sm text-secondary mb-2">
              <i class="fas fa-map-marker-alt mr-1"></i>
              ${artisan.region || 'ä¼ ç»Ÿå·¥è‰ºå‘æºåœ°'}
            </p>
            ${verificationStatus}
            ${skillTags ? `
              <div class="mt-2">
                <p class="text-xs text-secondary mb-1">æ“…é•¿æŠ€è‰ºï¼š</p>
                <div class="flex flex-wrap">
                  ${skillTags}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
        <div class="text-sm text-secondary leading-relaxed">
          ${artisan.bio || artisan.description || 'è¿™ä»¶ä½œå“ç”±ç»éªŒä¸°å¯Œçš„ä¼ ç»ŸåŒ äººç²¾å¿ƒåˆ¶ä½œï¼Œæ¯ä¸€é“å·¥åºéƒ½éµå¾ªå¤æ³•å·¥è‰ºï¼Œæ‰¿è½½ç€æ·±åšçš„æ–‡åŒ–å†…æ¶µå’Œè‰ºæœ¯ä»·å€¼ã€‚'}
        </div>
        ${artisan.experience ? `
          <div class="mt-3 text-xs text-secondary">
            <i class="fas fa-award mr-1"></i>
            ä»ä¸šç»éªŒï¼š${artisan.experience}
          </div>
        ` : ''}
      `;
    }
    
    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    async function checkCertificationStatus(product) {
      try {
        const isCertified = product.badge_contract && product.badge_contract !== '';
        
        // æ£€æŸ¥NFTé¢†å–çŠ¶æ€
        let nftClaimStatus = null;
        if (isCertified && getWalletStatus()) {
        try {
          const data = await auth.apiFetch(`/badge/claim-ticket?product_id=${product.id}&wallet=${getWalletAddress()}`);
          if (data.ok) {
            nftClaimStatus = data;
          } else {
            console.log('NFTé¢†å–çŠ¶æ€æ£€æŸ¥éœ€è¦ç™»å½•ï¼Œè·³è¿‡');
            nftClaimStatus = { claimable: false, reason: 'éœ€è¦ç™»å½•' };
          }
        } catch (error) {
          console.error('æ£€æŸ¥NFTé¢†å–çŠ¶æ€å¤±è´¥:', error);
          nftClaimStatus = { claimable: false, reason: 'æ£€æŸ¥å¤±è´¥' };
        }
        }

        // è®¤è¯çŠ¶æ€æ˜¾ç¤º
        const certificationStatus = `
          <div class="flex items-center justify-between mb-4">
            <span class="text-sm font-medium text-ink">é“¾ä¸Šè®¤è¯çŠ¶æ€</span>
            <span class="px-3 py-1 rounded-full text-xs font-medium ${isCertified ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
              ${isCertified ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}
            </span>
          </div>
        `;

        // åˆçº¦ä¿¡æ¯
        const contractInfo = `
          <div class="space-y-3 text-sm text-secondary mb-4">
            <div class="flex items-center">
              <i class="fas fa-link w-4 mr-2"></i>
              <span>åˆçº¦åœ°å€: ${product.badge_contract || 'æœªè®¾ç½®'}</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-shield-alt w-4 mr-2"></i>
              <span>è®¤è¯ç±»å‹: ${isCertified ? 'RWA æ•°å­—èµ„äº§' : 'å¾…è®¤è¯'}</span>
            </div>
            ${isCertified ? `
              <div class="flex items-center">
                <i class="fas fa-certificate w-4 mr-2"></i>
                <span>è®¤è¯çº§åˆ«: é“¾ä¸Šå¯éªŒè¯</span>
              </div>
            ` : ''}
          </div>
        `;

        // NFTé¢†å–åŠŸèƒ½
        let nftClaimSection = '';
        if (isCertified) {
          if (getWalletStatus()) {
            if (nftClaimStatus && nftClaimStatus.claimable) {
              nftClaimSection = `
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-4 mb-4">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-ink">NFTå¾½ç« é¢†å–</h4>
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">å¯é¢†å–</span>
                  </div>
                  <p class="text-xs text-secondary mb-3">
                    è´­ä¹°æ­¤å•†å“åï¼Œæ‚¨å°†è·å¾—ä¸“å±çš„é“¾ä¸Šè®¤è¯å¾½ç« NFT
                  </p>
                  <button onclick="claimNFT('${product.id}')" class="w-full bg-primary text-white rounded-lg py-2 text-sm font-medium">
                    <i class="fas fa-gift mr-1"></i>
                    é¢†å–NFTå¾½ç« 
                  </button>
                </div>
              `;
            } else if (nftClaimStatus && nftClaimStatus.claimed) {
              nftClaimSection = `
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 mb-4">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-ink">NFTå¾½ç« çŠ¶æ€</h4>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">å·²é¢†å–</span>
                  </div>
                  <p class="text-xs text-secondary mb-3">
                    æ‚¨å·²æˆåŠŸé¢†å–æ­¤å•†å“çš„é“¾ä¸Šè®¤è¯å¾½ç« 
                  </p>
                  <button onclick="viewNFT('${nftClaimStatus.token_id}')" class="w-full bg-accent text-ink rounded-lg py-2 text-sm font-medium">
                    <i class="fas fa-external-link-alt mr-1"></i>
                    æŸ¥çœ‹NFT
                  </button>
                </div>
              `;
            } else {
              nftClaimSection = `
                <div class="bg-gray-50 rounded-xl p-4 mb-4">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-ink">NFTå¾½ç« </h4>
                    <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">å¾…è´­ä¹°</span>
                  </div>
                  <p class="text-xs text-secondary">
                    è´­ä¹°æ­¤å•†å“åå³å¯é¢†å–ä¸“å±çš„é“¾ä¸Šè®¤è¯å¾½ç« NFT
                  </p>
                </div>
              `;
            }
          } else {
            nftClaimSection = `
              <div class="bg-yellow-50 rounded-xl p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-sm font-semibold text-ink">NFTå¾½ç« </h4>
                  <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">éœ€ç™»å½•</span>
                </div>
                <p class="text-xs text-secondary mb-3">
                  è¿æ¥é’±åŒ…åå¯æŸ¥çœ‹å’Œé¢†å–NFTå¾½ç« 
                </p>
                <button onclick="showWalletConnectPrompt()" class="w-full bg-primary text-white rounded-lg py-2 text-sm font-medium">
                  <i class="fas fa-wallet mr-1"></i>
                  è¿æ¥é’±åŒ…
                </button>
              </div>
            `;
          }
        } else {
          nftClaimSection = `
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-semibold text-ink">NFTå¾½ç« </h4>
                <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">æœªè®¤è¯</span>
              </div>
              <p class="text-xs text-secondary">
                æ­¤å•†å“å°šæœªå®Œæˆé“¾ä¸Šè®¤è¯ï¼Œæš‚ä¸æ”¯æŒNFTå¾½ç« 
              </p>
            </div>
          `;
        }

        document.getElementById('certificationStatus').innerHTML = `
          ${certificationStatus}
          ${contractInfo}
          ${nftClaimSection}
        `;
      } catch (error) {
        console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
        document.getElementById('certificationStatus').innerHTML = `
          <div class="text-center py-4">
            <p class="text-secondary">è®¤è¯çŠ¶æ€æ£€æŸ¥å¤±è´¥</p>
          </div>
        `;
      }
    }

    // é¢†å–NFT
    async function claimNFT(productId) {
      if (!getWalletStatus() || !getWalletAddress()) {
        auth.showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
        return;
      }

      try {
        const data = await auth.apiFetch('/badge/claim', {
          method: 'POST',
          body: JSON.stringify({
            product_id: productId,
            wallet: getWalletAddress()
          })
        });
        
        if (data.ok) {
          auth.showToast('NFTå¾½ç« é¢†å–æˆåŠŸï¼', 'success');
          // é‡æ–°æ£€æŸ¥è®¤è¯çŠ¶æ€
          const product = currentProduct || { id: productId, badge_contract: 'mock_contract' };
          checkCertificationStatus(product);
        } else {
          auth.showToast('NFTé¢†å–å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error('NFTé¢†å–å¤±è´¥:', error);
        auth.showToast('NFTé¢†å–å¤±è´¥', 'error');
      }
    }

    // æŸ¥çœ‹NFT
    function viewNFT(tokenId) {
      // è¿™é‡Œåº”è¯¥è·³è½¬åˆ°NFTæŸ¥çœ‹é¡µé¢æˆ–æ‰“å¼€åŒºå—é“¾æµè§ˆå™¨
      showToast('æ­£åœ¨æ‰“å¼€NFTæŸ¥çœ‹é¡µé¢...', 'info');
      // ç¤ºä¾‹ï¼šè·³è½¬åˆ°OpenSeaæˆ–Etherscan
      // window.open(`https://opensea.io/assets/ethereum/${contractAddress}/${tokenId}`, '_blank');
    }

    // è·å–é’±åŒ…è¿æ¥çŠ¶æ€
    function getWalletStatus() {
      return auth.isLoggedIn();
    }

    // è·å–é’±åŒ…åœ°å€
    function getWalletAddress() {
      return auth.getWalletAddress();
    }

    // æ›´æ–°é’±åŒ…è¿æ¥çŠ¶æ€æ˜¾ç¤º
    function updateWalletStatus() {
      const connectBtn = document.getElementById('connectWallet');
      const buyBtn = document.getElementById('buyButton');
      
      if (getWalletStatus() && getWalletAddress()) {
        currentWallet = getWalletAddress();
        connectBtn.innerHTML = `<i class="fab fa-ethereum mr-2"></i>${auth.shortAddr(currentWallet)}`;
        buyBtn.disabled = false;
        buyBtn.innerHTML = '<i class="fas fa-shopping-cart mr-2"></i>ç«‹å³è´­ä¹°';
      } else {
        connectBtn.innerHTML = '<i class="fab fa-ethereum mr-2"></i>è¿æ¥é’±åŒ…';
        buyBtn.disabled = true;
        buyBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>è¯·å…ˆè¿æ¥é’±åŒ…';
      }
    }

    // äº‹ä»¶ç›‘å¬å™¨å°†åœ¨DOMContentLoadedä¸­ç»‘å®š

    // æ˜¾ç¤ºé’±åŒ…è¿æ¥æç¤º
    function showWalletConnectPrompt() {
      const promptHtml = `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="walletPrompt">
          <div class="bg-white rounded-2xl p-6 max-w-sm mx-4">
            <div class="text-center">
              <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-wallet text-2xl text-primary"></i>
              </div>
              <h3 class="text-lg font-semibold text-ink mb-2">éœ€è¦è¿æ¥é’±åŒ…</h3>
              <p class="text-sm text-secondary mb-6">
                è´­ä¹°å•†å“éœ€è¦è¿æ¥é’±åŒ…ä»¥å®Œæˆèº«ä»½éªŒè¯å’Œæ”¯ä»˜
              </p>
              <div class="flex gap-3">
                <button onclick="closeWalletPrompt()" class="flex-1 px-4 py-2 border border-line rounded-xl text-sm">
                  å–æ¶ˆ
                </button>
                <button onclick="connectWallet()" class="flex-1 bg-primary text-white rounded-xl py-2 text-sm font-semibold">
                  è¿æ¥é’±åŒ…
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', promptHtml);
    }

    function closeWalletPrompt() {
      const prompt = document.getElementById('walletPrompt');
      if (prompt) prompt.remove();
    }

    // æ˜¾ç¤ºè®¢å•åˆ›å»ºè¡¨å•
    function showOrderForm(productId) {
      const orderFormHtml = `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="orderForm">
          <div class="bg-white rounded-2xl p-6 max-w-md mx-4 w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-ink">ç«‹å³ä¸‹å•</h3>
              <button onclick="closeOrderForm()" class="text-secondary hover:text-ink">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <form id="orderFormContent" onsubmit="submitOrder(event)">
              <input type="hidden" id="orderProductId" value="${productId}">
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-secondary mb-2">è´­ä¹°æ•°é‡</label>
                <input type="number" id="orderQty" min="1" value="1" required 
                       class="w-full p-3 border border-line rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary/30">
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-secondary mb-2">æ”¶è´§äººå§“å</label>
                <input type="text" id="orderName" required 
                       class="w-full p-3 border border-line rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary/30"
                       placeholder="è¯·è¾“å…¥æ”¶è´§äººå§“å">
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-secondary mb-2">è”ç³»ç”µè¯</label>
                <input type="tel" id="orderPhone" required 
                       class="w-full p-3 border border-line rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary/30"
                       placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
              </div>
              
              <div class="mb-6">
                <label class="block text-sm font-medium text-secondary mb-2">æ”¶è´§åœ°å€</label>
                <textarea id="orderAddress" required rows="3"
                          class="w-full p-3 border border-line rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 resize-none"
                          placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€"></textarea>
              </div>
              
              <div class="flex gap-3">
                <button type="button" onclick="closeOrderForm()" 
                        class="flex-1 px-4 py-3 border border-line rounded-xl text-sm font-medium">
                  å–æ¶ˆ
                </button>
                <button type="submit" id="submitOrderBtn"
                        class="flex-1 bg-primary text-white rounded-xl py-3 text-sm font-semibold">
                  <i class="fas fa-shopping-cart mr-2"></i>ç¡®è®¤ä¸‹å•
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', orderFormHtml);
    }

    // å…³é—­è®¢å•è¡¨å•
    function closeOrderForm() {
      const form = document.getElementById('orderForm');
      if (form) form.remove();
    }

    // æäº¤è®¢å•
    async function submitOrder(event) {
      event.preventDefault();
      
      const productId = document.getElementById('orderProductId').value;
      const qty = parseInt(document.getElementById('orderQty').value);
      const name = document.getElementById('orderName').value.trim();
      const phone = document.getElementById('orderPhone').value.trim();
      const address = document.getElementById('orderAddress').value.trim();
      
      // éªŒè¯è¡¨å•
      if (!productId || !qty || qty < 1 || !name || !phone || !address) {
        auth.showToast('è¯·å¡«å†™å®Œæ•´çš„è®¢å•ä¿¡æ¯', 'error');
        return;
      }
      
      // éªŒè¯æ‰‹æœºå·æ ¼å¼
      const phoneRegex = /^1[3-9]\d{9}$/;
      if (!phoneRegex.test(phone)) {
        auth.showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('submitOrderBtn');
      const originalText = submitBtn.textContent;
      
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æäº¤ä¸­...';
        submitBtn.disabled = true;
        
        // å‡†å¤‡è®¢å•æ•°æ®
        const orderData = {
          product_id: productId,
          qty: qty,
          shipping_info: {
            name: name,
            phone: phone,
            address: address
          }
        };
        
        // æäº¤è®¢å•
        const result = await auth.apiFetch('/order/create', {
          method: 'POST',
          body: JSON.stringify(orderData)
        });
        
        if (result.ok) {
          // è®¢å•åˆ›å»ºæˆåŠŸ
          closeOrderForm();
          showOrderSuccess(result.order_id, result.order_no);
        } else if (result.error === 'AUTH_REQUIRED') {
          // è®¤è¯å¤±è´¥ï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
          closeOrderForm();
          showWalletConnectPrompt();
        } else {
          throw new Error(result.error || 'è®¢å•åˆ›å»ºå¤±è´¥');
        }
        
      } catch (error) {
        console.error('è®¢å•æäº¤å¤±è´¥:', error);
        auth.showToast('è®¢å•æäº¤å¤±è´¥: ' + error.message, 'error');
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    // æ˜¾ç¤ºè®¢å•æˆåŠŸé¡µé¢
    function showOrderSuccess(orderId, orderNo) {
      const successHtml = `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="orderSuccess">
          <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-check text-2xl text-green-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-ink mb-2">è®¢å•æäº¤æˆåŠŸï¼</h3>
            <p class="text-sm text-secondary mb-4">
              è®¢å•å·ï¼š${orderNo}<br>
              æˆ‘ä»¬å°†åœ¨24å°æ—¶å†…å¤„ç†æ‚¨çš„è®¢å•
            </p>
            <div class="flex gap-3">
              <button onclick="closeOrderSuccess()" 
                      class="flex-1 px-4 py-2 border border-line rounded-xl text-sm">
                ç»§ç»­è´­ç‰©
              </button>
              <button onclick="viewOrder(orderId)" 
                      class="flex-1 bg-primary text-white rounded-xl py-2 text-sm font-semibold">
                æŸ¥çœ‹è®¢å•
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', successHtml);
    }

    // å…³é—­è®¢å•æˆåŠŸé¡µé¢
    function closeOrderSuccess() {
      const success = document.getElementById('orderSuccess');
      if (success) success.remove();
    }

    // æŸ¥çœ‹è®¢å•
    function viewOrder(orderId) {
      closeOrderSuccess();
      window.location.href = `./orders/?id=${orderId}`;
    }

    // è¿æ¥é’±åŒ…
    async function connectWallet() {
      try {
        const result = await auth.walletLogin();
        if (result.success) {
          currentWallet = result.wallet;
          updateWalletStatus();
          closeWalletPrompt();
          auth.showToast('é’±åŒ…è¿æ¥æˆåŠŸ', 'success');
        }
      } catch (error) {
        console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error);
        auth.showToast('é’±åŒ…è¿æ¥å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message, type = 'info') {
      const toastHtml = `
        <div class="fixed top-4 right-4 bg-white border border-line rounded-xl p-4 shadow-lg z-50 max-w-sm" id="toast">
          <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle text-green-600' : type === 'error' ? 'exclamation-circle text-red-600' : 'info-circle text-blue-600'} mr-2"></i>
            <span class="text-sm text-ink">${message}</span>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', toastHtml);
      
      setTimeout(() => {
        const toast = document.getElementById('toast');
        if (toast) toast.remove();
      }, 3000);
    }
    
    // åŠ è½½æ–‡åŒ–æ•…äº‹
    async function loadCulturalNarratives(productId) {
      try {
        // è·å–æ‰€æœ‰çŠ¶æ€çš„å™äº‹å†…å®¹ï¼ˆåŒ…æ‹¬ draft å’Œ publishedï¼‰
        const response = await fetch(`${API_BASE}/ai/narrative/product/${productId}?status=all`);
        const data = await response.json();
        
        if (data.ok && data.narratives && data.narratives.length > 0) {
          displayCulturalNarrativesModal(data.narratives);
        } else {
          alert('æš‚æ— æ–‡åŒ–æ•…äº‹å†…å®¹\n\nç®¡ç†å‘˜å¯åœ¨åå°ç”Ÿæˆæ–‡åŒ–å™äº‹å†…å®¹');
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡åŒ–æ•…äº‹å¤±è´¥:', error);
        alert('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }
    
    // æ˜¾ç¤ºæ–‡åŒ–æ•…äº‹æ¨¡æ€æ¡†
    function displayCulturalNarrativesModal(narratives) {
      const typeNames = {
        story: 'ğŸ“– æ•…äº‹ç‰ˆ',
        feature: 'âœ¨ ç‰¹ç‚¹ç‰ˆ',
        heritage: 'ğŸ›ï¸ ä¼ æ‰¿ç‰ˆ',
        usage: 'ğŸ’¡ ä½¿ç”¨ç‰ˆ'
      };
      
      // åˆ›å»ºæ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.id = 'culturalNarrativeModal';
      modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
      modal.onclick = (e) => {
        if (e.target === modal) closeCulturalNarrativeModal();
      };
      
      // æ„å»ºå™äº‹é€‰é¡¹å¡
      let tabsHTML = '<div class="flex gap-2 mb-4 overflow-x-auto">';
      narratives.forEach((narrative, index) => {
        tabsHTML += `
          <button onclick="switchNarrativeTab('${narrative.id}')" 
                  id="tab-${narrative.id}"
                  class="narrative-tab px-4 py-2 rounded-lg whitespace-nowrap transition ${index === 0 ? 'bg-primary text-paper' : 'bg-gray-200 text-ink hover:bg-gray-300'}">
            ${typeNames[narrative.type] || narrative.type}
          </button>
        `;
      });
      tabsHTML += '</div>';
      
      // æ„å»ºå™äº‹å†…å®¹
      let contentHTML = '';
      narratives.forEach((narrative, index) => {
        const contentData = typeof narrative.content_json === 'string' 
          ? JSON.parse(narrative.content_json) 
          : narrative.content_json;
        
        const textContent = contentData.content || narrative.content || 'æš‚æ— å†…å®¹';
        
        // æ„å»ºå¤šåª’ä½“é€‰é¡¹
        let mediaTabsHTML = '';
        let mediaContentHTML = '';
        
        // æ–‡å­—é»˜è®¤æ˜¾ç¤º
        mediaTabsHTML += `
          <button onclick="switchMediaTab('${narrative.id}', 'text', event)" 
                  class="media-tab media-tab-${narrative.id} px-3 py-2 rounded-lg text-sm bg-primary text-paper">
            ğŸ“– æ–‡å­—
          </button>
        `;
        mediaContentHTML += `
          <div id="media-${narrative.id}-text" class="media-content media-content-${narrative.id}">
            <div class="text-secondary leading-relaxed whitespace-pre-wrap">${textContent}</div>
          </div>
        `;
        
        // å¦‚æœæœ‰éŸ³é¢‘ï¼ˆç¡®ä¿ audio_url å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼‰
        if (narrative.audio_url && narrative.audio_url.trim()) {
          // å¤„ç†éŸ³é¢‘ URLï¼šå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè¡¥å…¨ä¸ºå®Œæ•´ URL
          const audioUrl = narrative.audio_url.startsWith('http') 
            ? narrative.audio_url 
            : `${API_BASE}${narrative.audio_url}`;
          
          mediaTabsHTML += `
            <button onclick="switchMediaTab('${narrative.id}', 'audio', event)" 
                    class="media-tab media-tab-${narrative.id} px-3 py-2 rounded-lg text-sm bg-gray-200 text-ink hover:bg-gray-300">
              ğŸµ è¯­éŸ³
            </button>
          `;
          mediaContentHTML += `
            <div id="media-${narrative.id}-audio" class="media-content media-content-${narrative.id}" style="display:none;">
              <audio controls class="w-full mb-4" preload="metadata">
                <source src="${audioUrl}" type="audio/mpeg">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
              </audio>
              <div class="text-sm text-secondary text-center">
                ğŸµ ç‚¹å‡»æ’­æ”¾æŒ‰é’®æ”¶å¬æ–‡åŒ–æ•…äº‹è¯­éŸ³ç‰ˆ
              </div>
              <div class="text-xs text-gray-400 text-center mt-2">
                æ—¶é•¿çº¦ ${narrative.audio_duration || 30} ç§’
              </div>
            </div>
          `;
        }
        
        // å¦‚æœæœ‰è§†é¢‘ï¼ˆç¡®ä¿ video_url å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼‰
        if (narrative.video_url && narrative.video_url.trim()) {
          // å¤„ç†è§†é¢‘ URLï¼šå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè¡¥å…¨ä¸ºå®Œæ•´ URL
          const videoUrl = narrative.video_url.startsWith('http') 
            ? narrative.video_url 
            : `${API_BASE}${narrative.video_url}`;
          
          // ç”Ÿæˆç¼©ç•¥å›¾ URLï¼ˆå¦‚æœæœ‰ï¼‰
          const thumbnailUrl = narrative.video_thumbnail 
            ? (narrative.video_thumbnail.startsWith('http') 
                ? narrative.video_thumbnail 
                : `${API_BASE}${narrative.video_thumbnail}`)
            : '';
          
          mediaTabsHTML += `
            <button onclick="switchMediaTab('${narrative.id}', 'video', event)" 
                    class="media-tab media-tab-${narrative.id} px-3 py-2 rounded-lg text-sm bg-gray-200 text-ink hover:bg-gray-300">
              ğŸ¬ è§†é¢‘
            </button>
          `;
          mediaContentHTML += `
            <div id="media-${narrative.id}-video" class="media-content media-content-${narrative.id}" style="display:none;">
              <video 
                id="video-${narrative.id}"
                controls 
                class="w-full rounded-lg mb-4" 
                preload="none"
                ${thumbnailUrl ? `poster="${thumbnailUrl}"` : ''}
                playsinline
                crossorigin="anonymous"
                style="max-height: 400px; object-fit: contain; background: #000;"
              >
                <source src="${videoUrl}" type="video/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
              </video>
              <div class="text-sm text-secondary text-center">
                ğŸ¬ è§‚çœ‹æ–‡åŒ–å™äº‹æ•°å­—äººè®²è§£è§†é¢‘
              </div>
              <div class="text-xs text-gray-400 text-center mt-2">
                æ—¶é•¿çº¦ ${narrative.video_duration || 30} ç§’
              </div>
            </div>
          `;
        }
        
        contentHTML += `
          <div id="content-${narrative.id}" class="narrative-content" style="display:${index === 0 ? 'block' : 'none'};">
            <div class="flex gap-2 mb-4">
              ${mediaTabsHTML}
            </div>
            ${mediaContentHTML}
          </div>
        `;
      });
      
      modal.innerHTML = `
        <div class="bg-paper rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-ink">æ–‡åŒ–æ•…äº‹</h2>
            <button onclick="closeCulturalNarrativeModal()" class="text-secondary hover:text-ink text-2xl">
              Ã—
            </button>
          </div>
          ${tabsHTML}
          ${contentHTML}
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // å…³é—­æ–‡åŒ–æ•…äº‹æ¨¡æ€æ¡†
    function closeCulturalNarrativeModal() {
      const modal = document.getElementById('culturalNarrativeModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // åˆ‡æ¢å™äº‹ç±»å‹é€‰é¡¹å¡
    function switchNarrativeTab(narrativeId) {
      // éšè—æ‰€æœ‰å†…å®¹
      document.querySelectorAll('.narrative-content').forEach(el => {
        el.style.display = 'none';
      });
      
      // é‡ç½®æ‰€æœ‰é€‰é¡¹å¡æ ·å¼
      document.querySelectorAll('.narrative-tab').forEach(el => {
        el.className = 'narrative-tab px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200 text-ink hover:bg-gray-300';
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
      document.getElementById(`content-${narrativeId}`).style.display = 'block';
      
      // é«˜äº®é€‰ä¸­çš„é€‰é¡¹å¡
      document.getElementById(`tab-${narrativeId}`).className = 'narrative-tab px-4 py-2 rounded-lg whitespace-nowrap transition bg-primary text-paper';
    }
    
    // åˆ‡æ¢åª’ä½“æ ¼å¼é€‰é¡¹å¡
    function switchMediaTab(narrativeId, mediaType, event) {
      // éšè—å½“å‰å™äº‹çš„æ‰€æœ‰åª’ä½“å†…å®¹
      document.querySelectorAll(`.media-content-${narrativeId}`).forEach(el => {
        el.style.display = 'none';
      });
      
      // æš‚åœæ‰€æœ‰è¯¥å™äº‹çš„è§†é¢‘æ’­æ”¾
      document.querySelectorAll(`.media-content-${narrativeId} video`).forEach(video => {
        if (video && !video.paused) {
          video.pause();
        }
      });
      
      // é‡ç½®æ‰€æœ‰åª’ä½“é€‰é¡¹å¡æ ·å¼
      document.querySelectorAll(`.media-tab-${narrativeId}`).forEach(el => {
        el.className = `media-tab media-tab-${narrativeId} px-3 py-2 rounded-lg text-sm bg-gray-200 text-ink hover:bg-gray-300`;
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„åª’ä½“å†…å®¹
      const mediaContent = document.getElementById(`media-${narrativeId}-${mediaType}`);
      if (mediaContent) {
        mediaContent.style.display = 'block';
        
        // å¦‚æœæ˜¯è§†é¢‘ï¼Œå¼€å§‹é¢„åŠ è½½å…ƒæ•°æ®
        if (mediaType === 'video') {
          const video = mediaContent.querySelector('video');
          if (video && video.networkState === HTMLMediaElement.NETWORK_IDLE) {
            // è§†é¢‘è¿˜æ²¡å¼€å§‹åŠ è½½ï¼Œæ‰‹åŠ¨è§¦å‘é¢„åŠ è½½
            video.load();
          }
        }
      }
      
      // é«˜äº®é€‰ä¸­çš„åª’ä½“é€‰é¡¹å¡
      event.target.className = `media-tab media-tab-${narrativeId} px-3 py-2 rounded-lg text-sm bg-primary text-paper`;
    }
    
    // æ‰“å¼€ AI åŒ äººå¯¹è¯
    function openArtisanChat(artisanId, artisanName) {
      // ç¡®ä¿ ArtisanChat ç»„ä»¶å·²åŠ è½½
      if (typeof ArtisanChat === 'undefined') {
        alert('AI å¯¹è¯ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }

      // æ„å»ºåŒ äººæ•°æ®å¯¹è±¡
      const artisanData = {
        id: artisanId,
        name_zh: artisanName,
        name_en: artisanName,
        avatar: null
      };

      // å¦‚æœæœ‰å½“å‰å•†å“ä¿¡æ¯ï¼Œå¯ä»¥æ·»åŠ åˆ° context
      if (currentProduct) {
        artisanData.current_product = {
          id: currentProduct.id,
          name: currentProduct.title_zh,
          description: currentProduct.desc_md
        };
      }

      // æ‰“å¼€å¯¹è¯æ¨¡æ€æ¡†
      ArtisanChat.open(artisanId, artisanData);
    }
    
    // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ–é’±åŒ…çŠ¶æ€
      updateWalletStatus();
      
      // åŠ è½½å•†å“è¯¦æƒ…
      loadProductDetail();
      
      // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      bindEventListeners();
      
      // åˆå§‹åŒ– AI å¯¹è¯ç»„ä»¶
      if (typeof ArtisanChat !== 'undefined') {
        ArtisanChat.init();
      }
    });
    
    // ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
    function bindEventListeners() {
      // è´­ä¹°æŒ‰é’®äº‹ä»¶
      const buyButton = document.getElementById('buyButton');
      if (buyButton) {
        buyButton.addEventListener('click', function() {
          const productId = getUrlParameter('id');
          if (!productId) {
            auth.showToast('å•†å“IDæ— æ•ˆ', 'error');
            return;
          }
          
          // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
          if (!getWalletStatus() || !getWalletAddress()) {
            showWalletConnectPrompt();
            return;
          }
          
          // æ˜¾ç¤ºè®¢å•åˆ›å»ºè¡¨å•
          showOrderForm(productId);
        });
      }
      
      // é’±åŒ…è¿æ¥äº‹ä»¶
      const connectWalletBtn = document.getElementById('connectWallet');
      if (connectWalletBtn) {
        connectWalletBtn.addEventListener('click', function() {
          if (getWalletStatus() && getWalletAddress()) {
            // å·²è¿æ¥ï¼Œæ˜¾ç¤ºæ–­å¼€é€‰é¡¹
            if (confirm('æ˜¯å¦æ–­å¼€é’±åŒ…è¿æ¥ï¼Ÿ')) {
              localStorage.removeItem('bearer_token');
              localStorage.removeItem('wallet_address');
              currentWallet = '';
              updateWalletStatus();
              showToast('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
            }
          } else {
            // æœªè¿æ¥ï¼Œæ˜¾ç¤ºè¿æ¥æç¤º
            showWalletConnectPrompt();
          }
        });
      }
    }
  </script>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <div style="position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e0e0e0; display: flex; align-items: center; padding: 8px 16px; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); z-index: 1000;">
    <div style="display: flex; gap: 24px; flex: 1;">
      <button onclick="window.location.href='/mall/'" style="display: flex; flex-direction: column; align-items: center; gap: 4px; border: none; background: none; color: #666; font-size: 11px; cursor: pointer;">
        <i class="fas fa-home" style="font-size: 20px;"></i>
        <span data-i18n="common.home">é¦–é¡µ</span>
      </button>
      <button onclick="openCustomerService()" style="display: flex; flex-direction: column; align-items: center; gap: 4px; border: none; background: none; color: #666; font-size: 11px; cursor: pointer;">
        <i class="fas fa-headset" style="font-size: 20px;"></i>
        <span data-i18n="common.customerService">å®¢æœ</span>
      </button>
      <button onclick="window.location.href='/mall/cart.html'" style="display: flex; flex-direction: column; align-items: center; gap: 4px; border: none; background: none; color: #666; font-size: 11px; cursor: pointer; position: relative;">
        <i class="fas fa-shopping-cart" style="font-size: 20px;"></i>
        <span data-i18n="common.cart">è´­ç‰©è½¦</span>
        <span id="cartBadge" style="position: absolute; top: -4px; right: -4px; background: #ff4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center; display: none;">0</span>
      </button>
    </div>
    <button id="buyNowBtn" onclick="quickBuy()" style="background: linear-gradient(135deg, #9E2A2B, #7a1b1c); color: white; border: none; border-radius: 24px; padding: 12px 32px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 3px 14px rgba(158, 42, 43, 0.6);">
      <i class="fas fa-shopping-bag" style="margin-right: 8px;"></i><span data-i18n="product.buyNow">ç«‹å³è´­ä¹°</span>
    </button>
  </div>

  <script>
    // æ‰“å¼€å®¢æœ
    function openCustomerService() {
      alert('å®¢æœåŠŸèƒ½å¼€å‘ä¸­...\n\næ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š\nğŸ“§ é‚®ç®±ï¼šsupport@example.com\nğŸ’¬ å¾®ä¿¡ï¼šheritage_support');
    }

    // å¿«é€Ÿè´­ä¹°
    function quickBuy() {
      const productId = getUrlParameter('id');
      if (!productId) {
        auth.showToast('å•†å“IDæ— æ•ˆ', 'error');
        return;
      }
      
      // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
      if (!getWalletStatus() || !getWalletAddress()) {
        showWalletConnectPrompt();
        return;
      }
      
      // æ˜¾ç¤ºè®¢å•åˆ›å»ºè¡¨å•
      showOrderForm(productId);
    }

    // æ›´æ–°è´­ç‰©è½¦å¾½ç« 
    function updateCartBadge() {
      const cart = JSON.parse(localStorage.getItem('shopping_cart') || '[]');
      const badge = document.getElementById('cartBadge');
      if (cart.length > 0) {
        badge.textContent = cart.length;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ›´æ–°å¾½ç« 
    window.addEventListener('DOMContentLoaded', async () => {
  // åˆå§‹åŒ– i18n
  await initI18n({
    autoDetect: true,
    translateOnInit: true,
    createSwitcher: true,
    switcherContainerId: 'languageSwitcher'
  });

      updateCartBadge();
    });

    // ç›‘å¬ storage å˜åŒ–
    window.addEventListener('storage', (e) => {
      if (e.key === 'shopping_cart') {
        updateCartBadge();
      }
    });
  </script>
</body>
</html>
