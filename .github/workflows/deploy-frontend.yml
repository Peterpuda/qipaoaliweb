name: Deploy Frontend to Aliyun OSS

on:
  push:
    branches:
      - main
      - prod
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/prod" ]]; then
            echo "bucket=${{ secrets.OSS_BUCKET }}" >> $GITHUB_OUTPUT
            echo "region=${{ secrets.OSS_REGION }}" >> $GITHUB_OUTPUT
            echo "cdn_domain=${{ secrets.CDN_DOMAIN }}" >> $GITHUB_OUTPUT
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "bucket=${{ secrets.OSS_BUCKET_DEV }}" >> $GITHUB_OUTPUT
            echo "region=${{ secrets.OSS_REGION }}" >> $GITHUB_OUTPUT
            echo "cdn_domain=${{ secrets.CDN_DOMAIN_DEV }}" >> $GITHUB_OUTPUT
            echo "env=staging" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ å®‰è£… ossutil
        run: |
          wget -q https://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil
          ossutil --version

      - name: âš™ï¸ é…ç½® ossutil
        run: |
          ossutil config -e ${{ steps.env.outputs.region }}.aliyuncs.com \
                        -i ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
                        -k ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}

      - name: ğŸš€ ä¸Šä¼ æ–‡ä»¶åˆ° OSS
        run: |
          cd frontend
          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ° OSS..."
          ossutil cp -r -f -u . oss://${{ steps.env.outputs.bucket }}/ \
            --exclude "*.md" \
            --exclude ".git/*" \
            --exclude "node_modules/*" \
            --exclude ".DS_Store" \
            --exclude "*.log"
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"

      - name: ğŸ¨ è®¾ç½®ç¼“å­˜ç­–ç•¥
        run: |
          echo "âš™ï¸ é…ç½®ç¼“å­˜ç­–ç•¥..."
          
          # HTMLæ–‡ä»¶ä¸ç¼“å­˜ï¼ˆæˆ–çŸ­ç¼“å­˜ï¼‰
          ossutil set-meta oss://${{ steps.env.outputs.bucket }}/ \
            Cache-Control:no-cache,no-store,must-revalidate \
            Content-Type:text/html \
            --include "*.html" \
            -r -f -u || true
          
          # JS/CSSç¼“å­˜7å¤©
          ossutil set-meta oss://${{ steps.env.outputs.bucket }}/ \
            Cache-Control:max-age=604800 \
            --include "*.js" \
            -r -f -u || true
          
          ossutil set-meta oss://${{ steps.env.outputs.bucket }}/ \
            Cache-Control:max-age=604800 \
            --include "*.css" \
            -r -f -u || true
          
          # å›¾ç‰‡ç¼“å­˜30å¤©
          ossutil set-meta oss://${{ steps.env.outputs.bucket }}/ \
            Cache-Control:max-age=2592000 \
            --include "*.jpg" \
            --include "*.jpeg" \
            --include "*.png" \
            --include "*.gif" \
            --include "*.webp" \
            --include "*.svg" \
            -r -f -u || true
          
          # è§†é¢‘/éŸ³é¢‘ç¼“å­˜30å¤©
          ossutil set-meta oss://${{ steps.env.outputs.bucket }}/ \
            Cache-Control:max-age=2592000 \
            --include "*.mp4" \
            --include "*.mp3" \
            --include "*.webm" \
            -r -f -u || true
          
          echo "âœ… ç¼“å­˜ç­–ç•¥é…ç½®å®Œæˆ"

      - name: ğŸ”„ åˆ·æ–° CDN ç¼“å­˜
        if: steps.env.outputs.cdn_domain != ''
        run: |
          echo "ğŸ”„ åˆ·æ–°CDNç¼“å­˜..."
          
          # å®‰è£…é˜¿é‡Œäº‘CLI
          wget -q https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar -xzf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          
          # é…ç½®CLI
          aliyun configure set \
            --profile default \
            --region cn-shanghai \
            --access-key-id ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
            --access-key-secret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          
          # åˆ·æ–°HTMLæ–‡ä»¶
          aliyun cdn RefreshObjectCaches \
            --ObjectPath https://${{ steps.env.outputs.cdn_domain }}/ \
            --ObjectType Directory || echo "âš ï¸ CDNåˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°"
          
          echo "âœ… CDNç¼“å­˜åˆ·æ–°å®Œæˆ"

      - name: ğŸ“Š éƒ¨ç½²ä¿¡æ¯
        run: |
          echo "=========================================="
          echo "âœ… å‰ç«¯éƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo "ğŸ“¦ OSS Bucket: ${{ steps.env.outputs.bucket }}"
          echo "ğŸŒ åŒºåŸŸ: ${{ steps.env.outputs.region }}"
          echo "ğŸŒ è®¿é—®åœ°å€: https://${{ steps.env.outputs.cdn_domain }}"
          echo "ğŸ”— OSSç›´æ¥è®¿é—®: https://${{ steps.env.outputs.bucket }}.${{ steps.env.outputs.region }}.aliyuncs.com"
          echo "ğŸ• éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
          echo "ğŸ”– åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ†” Commit: ${{ github.sha }}"
          echo "=========================================="

      - name: ğŸ“¢ å‘é€é’‰é’‰é€šçŸ¥
        if: always() && secrets.DINGTALK_WEBHOOK != ''
        uses: zcong1993/actions-ding@master
        with:
          dingToken: ${{ secrets.DINGTALK_WEBHOOK }}
          body: |
            {
              "msgtype": "markdown",
              "markdown": {
                "title": "å‰ç«¯éƒ¨ç½²é€šçŸ¥",
                "text": "## ğŸš€ å‰ç«¯éƒ¨ç½²${{ job.status == 'success' && 'æˆåŠŸ âœ…' || 'å¤±è´¥ âŒ' }}\n\n- **ç¯å¢ƒ**: ${{ steps.env.outputs.env }}\n- **åˆ†æ”¯**: ${{ github.ref_name }}\n- **æäº¤**: ${{ github.event.head_commit.message }}\n- **æäº¤è€…**: ${{ github.actor }}\n- **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')\n- **è®¿é—®**: [https://${{ steps.env.outputs.cdn_domain }}](https://${{ steps.env.outputs.cdn_domain }})"
              }
            }

