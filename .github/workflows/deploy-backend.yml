name: Deploy Backend to Aliyun FC

on:
  push:
    branches:
      - main
      - prod
    paths:
      - 'worker-api/**'
      - '.github/workflows/deploy-backend.yml'

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: worker-api/package-lock.json

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          cd worker-api
          npm ci --production
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ðŸ› ï¸ å®‰è£… Serverless Devs
        run: |
          npm install -g @serverless-devs/s
          s -v

      - name: âš™ï¸ é…ç½® Serverless Devs
        run: |
          s config add \
            --AccountID ${{ secrets.ALIYUN_ACCOUNT_ID }} \
            --AccessKeyID ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
            --AccessKeySecret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }} \
            -a default

      - name: ðŸ“ åˆ›å»º s.yaml é…ç½®
        run: |
          cd worker-api
          cat > s.yaml << 'EOF'
          edition: 1.0.0
          name: songbrocade-api
          access: default

          services:
            songbrocade-api:
              component: fc
              props:
                region: cn-shanghai
                service:
                  name: songbrocade-api
                  description: æ——è¢ä¼šåŽç«¯APIæœåŠ¡
                  logConfig:
                    project: aliyun-fc-cn-shanghai-xxx
                    logstore: function-log
                  role: acs:ram::${{ secrets.ALIYUN_ACCOUNT_ID }}:role/aliyunfcdefaultrole
                function:
                  name: api-handler
                  description: APIå¤„ç†å‡½æ•°
                  runtime: custom
                  codeUri: ./
                  handler: index.handler
                  memorySize: 1024
                  timeout: 60
                  instanceConcurrency: 10
                  environmentVariables:
                    NODE_ENV: production
                    DB_HOST: ${{ secrets.DB_HOST }}
                    DB_PORT: ${{ secrets.DB_PORT }}
                    DB_USER: ${{ secrets.DB_USER }}
                    DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
                    DB_NAME: ${{ secrets.DB_NAME }}
                    OSS_REGION: ${{ secrets.OSS_REGION }}
                    OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
                    OSS_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
                    OSS_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
                    RPC_URL: ${{ secrets.RPC_URL }}
                    BROCADE_ADDR: ${{ secrets.BROCADE_ADDR }}
                    RDA_REG_ADDR: ${{ secrets.RDA_REG_ADDR }}
                    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
                    REPLICATE_API_KEY: ${{ secrets.REPLICATE_API_KEY }}
                    ADMIN_WALLETS: ${{ secrets.ADMIN_WALLETS }}
                    SHIPPING_KEY: ${{ secrets.SHIPPING_KEY }}
                triggers:
                  - name: httpTrigger
                    type: http
                    config:
                      authType: anonymous
                      methods:
                        - GET
                        - POST
                        - PUT
                        - DELETE
                        - OPTIONS
          EOF

      - name: ðŸ“ åˆ›å»º bootstrap æ–‡ä»¶
        run: |
          cd worker-api
          cat > bootstrap << 'EOF'
          #!/bin/bash
          export PORT=9000
          node index.js
          EOF
          chmod +x bootstrap

      - name: ðŸš€ éƒ¨ç½²åˆ°å‡½æ•°è®¡ç®—
        run: |
          cd worker-api
          s deploy -y --use-local
          echo "âœ… åŽç«¯éƒ¨ç½²å®Œæˆ"

      - name: ðŸ§ª æµ‹è¯• API
        run: |
          echo "ðŸ§ª æµ‹è¯•APIå¥åº·æ£€æŸ¥..."
          sleep 5
          # è¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºå®žé™…çš„APIåœ°å€
          # curl -f https://api.songbrocade.com/health || echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥"

      - name: ðŸ“Š éƒ¨ç½²ä¿¡æ¯
        run: |
          echo "=========================================="
          echo "âœ… åŽç«¯éƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo "ðŸ”§ æœåŠ¡åç§°: songbrocade-api"
          echo "âš¡ å‡½æ•°åç§°: api-handler"
          echo "ðŸŒ åŒºåŸŸ: cn-shanghai"
          echo "ðŸ”— APIåœ°å€: https://api.songbrocade.com"
          echo "ðŸ• éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "ðŸ‘¤ æäº¤è€…: ${{ github.actor }}"
          echo "=========================================="

      - name: ðŸ“¢ å‘é€é’‰é’‰é€šçŸ¥
        if: always() && secrets.DINGTALK_WEBHOOK != ''
        uses: zcong1993/actions-ding@master
        with:
          dingToken: ${{ secrets.DINGTALK_WEBHOOK }}
          body: |
            {
              "msgtype": "markdown",
              "markdown": {
                "title": "åŽç«¯éƒ¨ç½²é€šçŸ¥",
                "text": "## ðŸš€ åŽç«¯éƒ¨ç½²${{ job.status == 'success' && 'æˆåŠŸ âœ…' || 'å¤±è´¥ âŒ' }}\n\n- **æœåŠ¡**: songbrocade-api\n- **åˆ†æ”¯**: ${{ github.ref_name }}\n- **æäº¤**: ${{ github.event.head_commit.message }}\n- **æäº¤è€…**: ${{ github.actor }}\n- **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')\n- **API**: https://api.songbrocade.com"
              }
            }

