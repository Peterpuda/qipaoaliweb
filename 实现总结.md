# ğŸ‰ ç­¾åˆ°åŠ ç§¯åˆ†åŠŸèƒ½å®ç°å®Œæˆ

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è®¾è®¡
- âœ… æ–°å¢ `airdrop_eligible` è¡¨ï¼ˆç©ºæŠ•èµ„æ ¼è®°å½•ï¼‰
- âœ… æ–°å¢ `merkle_batches` è¡¨ï¼ˆMerkle æ‰¹æ¬¡ç®¡ç†ï¼‰
- âœ… æ·»åŠ ç›¸å…³ç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½

### 2. åç«¯ API å®ç°
- âœ… ç­¾åˆ°æ¥å£æ·»åŠ ç§¯åˆ†å¥–åŠ±ï¼ˆæ¯æ¬¡ç­¾åˆ° 10 ç§¯åˆ†ï¼‰
- âœ… ç­¾åˆ°æ¥å£è®°å½•ç©ºæŠ•èµ„æ ¼
- âœ… å®ç°ç©ºæŠ•èµ„æ ¼æŸ¥è¯¢ API: `/rewards/v2/eligibility/{event_id}/{wallet}`

### 3. å‰ç«¯åŠŸèƒ½
- âœ… ç­¾åˆ°æˆåŠŸåæ˜¾ç¤ºç§¯åˆ†ä¿¡æ¯
- âœ… æ˜¾ç¤ºç©ºæŠ•èµ„æ ¼æé†’
- âœ… æ·»åŠ "å‰å¾€é¢†å–ä»£å¸"æŒ‰é’®

### 4. éƒ¨ç½²
- âœ… åç«¯éƒ¨ç½²åˆ° Cloudflare Worker: `songbrocade-api.petterbrand03.workers.dev`
- âœ… å‰ç«¯éƒ¨ç½²åˆ° Cloudflare Pages: `17ae0fd9.poap-checkin-frontend.pages.dev`

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### ç”¨æˆ·ç­¾åˆ°æµç¨‹

1. **ç”¨æˆ·ç­¾åˆ°** â†’ è¿æ¥é’±åŒ… â†’ è¾“å…¥ç­¾åˆ°ç  â†’ ç‚¹å‡»"é“­åˆ»æˆ‘çš„åˆ°åœº"
2. **åç«¯å¤„ç†**:
   - è®°å½•ç­¾åˆ°åˆ° `checkins` è¡¨
   - æ·»åŠ  10 ç§¯åˆ†åˆ° `rewards` è¡¨
   - è®°å½•ç©ºæŠ•èµ„æ ¼åˆ° `airdrop_eligible` è¡¨
3. **å‰ç«¯æ˜¾ç¤º**:
   - æ˜¾ç¤º"ç­¾åˆ°æˆåŠŸï¼è·å¾— 10 ç§¯åˆ† ğŸ å·²è·å¾—ç©ºæŠ•èµ„æ ¼ ğŸ’"
   - æ˜¾ç¤º"å‰å¾€é¢†å–ä»£å¸"æŒ‰é’®

### ç§¯åˆ†ç³»ç»Ÿ

- **è·å–ç§¯åˆ†**: æ¯æ¬¡ç­¾åˆ°è·å¾— 10 ç§¯åˆ†
- **æŸ¥è¯¢ç§¯åˆ†**: GET `/points` è·å–ç”¨æˆ·æ€»ç§¯åˆ†å’Œå†å²è®°å½•
- **ç§¯åˆ†ç”¨é€”**: å¯ä»¥ç”¨äºåç»­æ‰©å±•çš„åŠŸèƒ½ï¼ˆå¦‚å…‘æ¢å•†å“ç­‰ï¼‰

### ç©ºæŠ•èµ„æ ¼ç³»ç»Ÿ

- **è®°å½•èµ„æ ¼**: ç­¾åˆ°æˆåŠŸåè‡ªåŠ¨è®°å½•ç©ºæŠ•èµ„æ ¼ï¼ˆ1 ä¸ªä»£å¸ï¼‰
- **æŸ¥è¯¢èµ„æ ¼**: GET `/rewards/v2/eligibility/{event_id}/{wallet}`
- **é¢†å–çŠ¶æ€**: åˆ†ä¸º `not_ready`ï¼ˆMerkle proof æœªç”Ÿæˆï¼‰å’Œ `ready`ï¼ˆå¯é¢†å–ï¼‰

## ğŸ“‹ åç»­æ­¥éª¤è¯´æ˜

### æ­¥éª¤ 1: æµ‹è¯•ç­¾åˆ°åŠŸèƒ½

è®¿é—®å‰ç«¯é¡µé¢ï¼š
```
https://17ae0fd9.poap-checkin-frontend.pages.dev/checkin/
```

æµ‹è¯•æ­¥éª¤ï¼š
1. å‡†å¤‡ä¸€ä¸ªæ´»åŠ¨ï¼ˆå¯ä»¥åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæµ‹è¯•äº‹ä»¶ï¼‰
2. è¿æ¥é’±åŒ…
3. è¾“å…¥ç­¾åˆ°ç 
4. æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºç§¯åˆ†å’Œç©ºæŠ•èµ„æ ¼ä¿¡æ¯

### æ­¥éª¤ 2: ç”Ÿæˆ Merkle Treeï¼ˆå¦‚éœ€ä½¿ç”¨é¢†å–åŠŸèƒ½ï¼‰

å¦‚æœç”¨æˆ·è¦é¢†å–ä»£å¸ï¼Œéœ€è¦ï¼š
1. ä»æ•°æ®åº“è·å–æ‰€æœ‰ç­¾åˆ°ç”¨æˆ·
2. ç”Ÿæˆ Merkle Tree
3. è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„ Merkle Proof
4. æ›´æ–° `airdrop_eligible` è¡¨çš„ `item_index` å’Œ `proof` å­—æ®µ

### æ­¥éª¤ 3: å®ç°ä»£å¸è‡ªåŠ¨è½¬è´¦ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦è‡ªåŠ¨è½¬è´¦ï¼ˆè€Œä¸æ˜¯ç”¨æˆ·æ‰‹åŠ¨é¢†å–ï¼‰ï¼Œéœ€è¦ï¼š
1. è®¾ç½®ç®¡ç†å‘˜ç§é’¥ä¸º Cloudflare Secret
2. é…ç½®ä»£å¸åˆçº¦åœ°å€
3. å®ç°ä»£å¸è½¬è´¦é€»è¾‘ï¼ˆè°ƒç”¨ ERC20 transferï¼‰
4. è®°å½•äº¤æ˜“å“ˆå¸Œ

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“ç»“æ„

```sql
-- ç©ºæŠ•èµ„æ ¼è¡¨
CREATE TABLE airdrop_eligible (
  id INTEGER PRIMARY KEY,
  wallet TEXT NOT NULL,
  event_id TEXT NOT NULL,
  amount TEXT NOT NULL,      -- ä»£å¸æ•°é‡ï¼ˆå­—ç¬¦ä¸²ï¼‰
  item_index INTEGER,        -- Merkle Tree ä¸­çš„ç´¢å¼•
  proof TEXT,                 -- Merkle Proofï¼ˆJSON æ•°ç»„ï¼‰
  claimed INTEGER DEFAULT 0, -- æ˜¯å¦å·²é¢†å–
  merkle_batch TEXT,          -- Merkle æ‰¹æ¬¡ ID
  token_tx_hash TEXT,         -- ä»£å¸è½¬è´¦äº¤æ˜“å“ˆå¸Œ
  created_at INTEGER,
  UNIQUE(wallet, event_id)
);

-- Merkle æ‰¹æ¬¡è¡¨
CREATE TABLE merkle_batches (
  batch_id TEXT PRIMARY KEY,
  merkle_root TEXT NOT NULL,
  distributor_address TEXT NOT NULL,
  total_amount TEXT NOT NULL,
  claim_count INTEGER DEFAULT 0,
  created_by TEXT,
  created_at INTEGER
);
```

### API æ¥å£

#### 1. ç­¾åˆ°æ¥å£
```
POST /poap/checkin
Body: { event_id, wallet, code }

Response: {
  ok: true,
  id: "ç­¾åˆ°ID",
  ts: æ—¶é—´æˆ³,
  points: 10,
  eligible: true
}
```

#### 2. æŸ¥è¯¢ç©ºæŠ•èµ„æ ¼
```
GET /rewards/v2/eligibility/{event_id}/{wallet}

Response: {
  ok: true,
  eligible: true/false,
  ready: true/false,
  index: ç´¢å¼•,
  amount: "1000000000000000000",
  proof: ["0x...", "0x..."],
  batch: "æ‰¹æ¬¡ID"
}
```

#### 3. æŸ¥è¯¢ç§¯åˆ†
```
GET /points

Response: {
  ok: true,
  points: 100,
  history: [
    { type: "checkin", points: 10, timestamp: 1234567890 }
  ]
}
```

## ğŸ› å·²çŸ¥é—®é¢˜

1. **ç§¯åˆ†æŸ¥è¯¢ API**: éœ€è¦ Bearer Token è®¤è¯ï¼Œä½†ç›®å‰ç­¾åˆ°é¡µé¢çš„ localStorage ä¸­æ²¡æœ‰å­˜å‚¨ token
2. **ä»£å¸ç©ºæŠ•**: å½“å‰åªè®°å½•ç©ºæŠ•èµ„æ ¼ï¼Œéœ€è¦æ‰‹åŠ¨ç”Ÿæˆ Merkle Tree æˆ–å®ç°è‡ªåŠ¨è½¬è´¦
3. **é¢†å–é¡µé¢**: `claim/index.html` éœ€è¦é…ç½®æ­£ç¡®çš„ API åœ°å€

## ğŸ’¡ æ”¹è¿›å»ºè®®

### çŸ­æœŸï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
1. âœ… ä¿®å¤ç§¯åˆ†æ˜¾ç¤ºï¼ˆå·²å®Œæˆï¼‰
2. â³ å®ç°ä»£å¸è‡ªåŠ¨è½¬è´¦åŠŸèƒ½
3. â³ æ·»åŠ ç­¾åˆ°å†å²æŸ¥è¯¢åŠŸèƒ½

### ä¸­æœŸ
1. å®ç°å®Œæ•´çš„ Merkle Tree ç”Ÿæˆå·¥å…·
2. æ·»åŠ ç®¡ç†å‘˜åå°ç®¡ç†ç©ºæŠ•æ‰¹æ¬¡
3. å®ç°ç§¯åˆ†å…‘æ¢å•†å“åŠŸèƒ½

### é•¿æœŸ
1. æ”¯æŒå¤šä¸ªæ´»åŠ¨ç±»å‹
2. æ·»åŠ ç­¾åˆ°æ’è¡Œæ¦œ
3. å®ç°æ¨èå¥–åŠ±æœºåˆ¶

## ğŸ“ æ“ä½œæµç¨‹

### æµ‹è¯•ç­¾åˆ°åŠŸèƒ½

```bash
# 1. è®¿é—®å‰ç«¯
open https://17ae0fd9.poap-checkin-frontend.pages.dev/checkin/

# 2. æµ‹è¯• API
curl https://songbrocade-api.petterbrand03.workers.dev/health

# 3. æŸ¥çœ‹æ—¥å¿—
cd worker-api
npx wrangler tail songbrocade-api

# 4. æŸ¥çœ‹æ•°æ®åº“
npx wrangler d1 execute poap-db --command="SELECT * FROM rewards ORDER BY ts DESC LIMIT 5"
```

### ç®¡ç†ç©ºæŠ•

```bash
# æŸ¥çœ‹æ‰€æœ‰ç©ºæŠ•èµ„æ ¼
npx wrangler d1 execute poap-db --command="SELECT * FROM airdrop_eligible"

# æŸ¥çœ‹ç§¯åˆ†è®°å½•
npx wrangler d1 execute poap-db --command="SELECT * FROM rewards ORDER BY ts DESC LIMIT 10"

# æŸ¥çœ‹ç­¾åˆ°è®°å½•
npx wrangler d1 execute poap-db --command="SELECT * FROM checkins ORDER BY created_at DESC LIMIT 10"
```

## ğŸ‰ å®Œæˆï¼

ç­¾åˆ°åŠ ç§¯åˆ†åŠŸèƒ½å·²ç»æˆåŠŸå®ç°å¹¶éƒ¨ç½²ï¼
ç”¨æˆ·å¯ä»¥ç­¾åˆ°è·å¾—ç§¯åˆ†ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•ç©ºæŠ•èµ„æ ¼ã€‚

ä¸‹ä¸€æ­¥å¯ä»¥æ ¹æ®éœ€è¦å®ç°ï¼š
- ä»£å¸è‡ªåŠ¨è½¬è´¦
- Merkle Tree ç”Ÿæˆ
- é¢†å–é¡µé¢é›†æˆ

