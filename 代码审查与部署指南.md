# ä»£ç å®¡æŸ¥ä¸éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ä»£ç å®¡æŸ¥æŠ¥å‘Š

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

1. **è®¤è¯ç³»ç»Ÿ**ï¼šåŸºäºé’±åŒ…ç­¾åçš„ç®¡ç†å‘˜è®¤è¯
2. **D1 æ•°æ®åº“**ï¼šå®Œæ•´çš„æ•°æ®æ¨¡å‹å’Œè¿ç§»è„šæœ¬
3. **CORS é…ç½®**ï¼šè·¨åŸŸæ”¯æŒå·²é…ç½®
4. **äº‹ä»¶ç®¡ç†**ï¼šåˆ›å»ºå’Œç®¡ç† POAP äº‹ä»¶
5. **ç­¾åˆ°ç³»ç»Ÿ**ï¼šæ”¯æŒé™æ€ç å’ŒåŠ¨æ€ç 
6. **å•†å“ç®¡ç†**ï¼šä¼ æ‰¿äººã€å•†å“ã€è®¢å•ç³»ç»Ÿ
7. **ç§¯åˆ†ç³»ç»Ÿ**ï¼šç”¨æˆ·ç§¯åˆ†è®°å½•å’ŒæŸ¥è¯¢
8. **å¾½ç« ç³»ç»Ÿ**ï¼šè®¢å•å®Œæˆåçš„å¾½ç« å‘è¡Œ

### âš ï¸ å‘ç°çš„é—®é¢˜

#### 1. é…ç½®å†—ä½™
- æ ¹ç›®å½•æœ‰ `wrangler.toml`
- `worker/` ç›®å½•æœ‰ `wrangler.toml`
- `worker-api/` ç›®å½•æœ‰ `wrangler.toml`
- ä¸‰ä¸ªé…ç½®ä¸ä¸€è‡´ï¼Œå»ºè®®åªä½¿ç”¨ `worker-api/`

#### 2. TODO éœ€è¦å®Œæˆ
- `worker-api/utils/runtime.js` ä¸­çš„ç­¾ååŠŸèƒ½ï¼ˆline 216ï¼‰
- å¾½ç« ç­¾åéœ€è¦å®ç°çœŸæ­£çš„ç­¾åé€»è¾‘

#### 3. ç¯å¢ƒå˜é‡ç®¡ç†
- `SHIPPING_KEY` ä½¿ç”¨å¼±å¯†é’¥
- å»ºè®®ç”Ÿæˆæ›´å¼ºçš„åŠ å¯†å¯†é’¥

#### 4. æ•°æ®åº“åˆå§‹åŒ–
- éœ€è¦ç¡®ä¿ D1 æ•°æ®åº“å·²åˆ›å»ºå’Œåˆå§‹åŒ–

## ğŸ”§ éœ€è¦ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1: é…ç½®æ¸…ç†
**å½“å‰çŠ¶æ€**ï¼šå¤šä¸ª wrangler.toml é…ç½®æ··ä¹±
**è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€ä½¿ç”¨ `worker-api/wrangler.toml`

### é—®é¢˜ 2: ç­¾ååŠŸèƒ½ä¸å®Œæ•´
**å½“å‰çŠ¶æ€**ï¼š`buildBadgeSignaturePayload` è¿”å›å ä½ç¬¦
**è§£å†³æ–¹æ¡ˆ**ï¼šå®ç°çœŸæ­£çš„ EIP-712 ç­¾åæˆ–æš‚æ—¶è·³è¿‡

### é—®é¢˜ 3: åŠ å¯†å¯†é’¥å¤ªå¼±
**å½“å‰çŠ¶æ€**ï¼š`SHIPPING_KEY = "YWJjZGVmZ2hpams="`
**è§£å†³æ–¹æ¡ˆ**ï¼šç”Ÿæˆéšæœº 32 å­—èŠ‚å¯†é’¥

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: å‡†å¤‡ç¯å¢ƒ
```bash
# 1. å®‰è£…ä¾èµ–
cd worker-api
npm install

# 2. ç™»å½• Cloudflare
npx wrangler login
```

### æ­¥éª¤ 2: åˆ›å»º D1 æ•°æ®åº“ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
```bash
npx wrangler d1 create poap-db
```
è®°å½•è¿”å›çš„ `database_id`ï¼Œæ›´æ–° `wrangler.toml` ä¸­çš„ `database_id`

### æ­¥éª¤ 3: åˆ›å»º R2 å­˜å‚¨æ¡¶ï¼ˆç”¨äºå›¾ç‰‡ä¸Šä¼ ï¼‰
```bash
# åœ¨ Cloudflare Dashboard ä¸­åˆ›å»ºï¼š
# 1. ç™»å½• Cloudflare Dashboard
# 2. è¿›å…¥ R2 å­˜å‚¨
# 3. åˆ›å»ºå­˜å‚¨æ¡¶ï¼Œå‘½åä¸º "poap-images"
```

### æ­¥éª¤ 4: è®¾ç½®ç¯å¢ƒå˜é‡

#### è®¾ç½®ç®¡ç†å‘˜åœ°å€
```bash
cd worker-api
echo "0xEf85456652ada05f12708b9bDcF215780E780D18" | npx wrangler secret put ADMIN_WALLETS_SECRET
```

#### è®¾ç½® RPC URLï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
echo "https://sepolia.base.org" | npx wrangler secret put RPC_URL
```

#### è®¾ç½®åˆçº¦åœ°å€ï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
echo "0xYOUR_CONTRACT_ADDRESS" | npx wrangler secret put BROCADE_ADDR
```

### æ­¥éª¤ 5: åˆå§‹åŒ–æ•°æ®åº“
```bash
# ä½¿ç”¨è¿ç§»è„šæœ¬è‡ªåŠ¨åˆå§‹åŒ–
npx wrangler d1 execute poap-db --file=migrations/004_badges_issues.sql

# æˆ–è€…æ‰‹åŠ¨è¿è¡Œåˆå§‹åŒ– SQLï¼ˆworker-api/utils/db.js ä¸­çš„ STMT_CREATEï¼‰
```

### æ­¥éª¤ 6: éƒ¨ç½² Worker
```bash
cd worker-api
npx wrangler deploy
```

### æ­¥éª¤ 7: éƒ¨ç½²å‰ç«¯ï¼ˆå¯é€‰ï¼‰
```bash
cd frontend
# ä½¿ç”¨ Cloudflare Pages éƒ¨ç½²
# æˆ–è€…ä½¿ç”¨ wrangler pages deploy
npx wrangler pages deploy frontend --project-name=poap-frontend
```

### æ­¥éª¤ 8: é…ç½®å‰ç«¯ API åœ°å€
æ›´æ–° `frontend/poap.config.js` å’Œ `frontend/common/api.js`ï¼š
```javascript
WORKER_BASE_URL: "https://songbrocade-api.YOUR-ACCOUNT.workers.dev"
```

## ğŸ”’ å®‰å…¨å»ºè®®

1. **åŠ å¯†å¯†é’¥**ï¼šç”Ÿæˆæ–°çš„éšæœº 32 å­—èŠ‚å¯†é’¥
   ```bash
   # ç”Ÿæˆæ–°å¯†é’¥
   node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
   ```

2. **ç®¡ç†å‘˜åœ°å€**ï¼šä½¿ç”¨ Secret è€Œä¸æ˜¯ç¯å¢ƒå˜é‡

3. **CORS è®¾ç½®**ï¼šé™åˆ¶å…è®¸çš„åŸŸå

4. **ç­¾åéªŒè¯**ï¼šå®ç°å®Œæ•´çš„ EIP-712 ç­¾åéªŒè¯

## ğŸ“ éƒ¨ç½²åæ£€æŸ¥æ¸…å•

- [ ] Worker éƒ¨ç½²æˆåŠŸ
- [ ] D1 æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] R2 å­˜å‚¨æ¡¶å¯ç”¨
- [ ] å‰ç«¯èƒ½è®¿é—® Worker API
- [ ] ç®¡ç†å‘˜è®¤è¯æ­£å¸¸
- [ ] äº‹ä»¶åˆ›å»ºåŠŸèƒ½æ­£å¸¸
- [ ] ç­¾åˆ°åŠŸèƒ½æ­£å¸¸
- [ ] å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ­£å¸¸

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ï¼šWorker éƒ¨ç½²å¤±è´¥
**åŸå› **ï¼šå¯èƒ½æ˜¯é…ç½®é—®é¢˜æˆ–ä¾èµ–é—®é¢˜
**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ wrangler.toml é…ç½®
cd worker-api
npx wrangler deploy --dry-run
```

### é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
**åŸå› **ï¼šD1 æ•°æ®åº“æœªåˆ›å»ºæˆ– database_id é”™è¯¯
**è§£å†³**ï¼š
```bash
# æ£€æŸ¥æ•°æ®åº“åˆ—è¡¨
npx wrangler d1 list

# ç¡®è®¤ database_id
cat wrangler.toml
```

### é—®é¢˜ï¼šç®¡ç†å‘˜è®¤è¯å¤±è´¥
**åŸå› **ï¼šåœ°å€æœªåœ¨ç™½åå•ä¸­
**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ secret
npx wrangler secret list --name songbrocade-api

# é‡æ–°è®¾ç½®
echo "YOUR_ADDRESS" | npx wrangler secret put ADMIN_WALLETS_SECRET --name songbrocade-api
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Cloudflare Workers æ–‡æ¡£](https://developers.cloudflare.com/workers/)
- [D1 æ•°æ®åº“æ–‡æ¡£](https://developers.cloudflare.com/d1/)
- [R2 å­˜å‚¨æ–‡æ¡£](https://developers.cloudflare.com/r2/)
- [Wrangler CLI æ–‡æ¡£](https://developers.cloudflare.com/workers/wrangler/)

